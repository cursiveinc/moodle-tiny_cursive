{"version":3,"file":"cursive_writing_reports.min.js","sources":["../src/cursive_writing_reports.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module     tiny_cursive/cursive_writing_reports\n * @category TinyMCE Editor\n * @copyright  CTI <info@cursivetechnology.com>\n * @author Brain Station 23 <elearning@brainstation-23.com>\n */\n\ndefine([\"core/ajax\", \"core/str\", \"core/templates\", \"./replay\", \"./analytic_button\", \"./analytic_events\",\n    \"core/modal_events\", \"core/modal_save_cancel\", \"core/modal_factory\", \"core/modal\"],\n    function (\n        AJAX,\n        str,\n        templates,\n        Replay,\n        analyticButton,\n        AnalyticEvents,\n        Events,\n        Modal,\n        Factory,\n        Alert\n    ) {\n        const replayInstances = {};\n        // eslint-disable-next-line\n        window.video_playback = function (mid, filepath) {\n            if (filepath !== '') {\n                const replay = new Replay(\n                    'content' + mid,\n                    filepath,\n                    10,\n                    false,\n                    'player_' + mid\n                );\n                replayInstances[mid] = replay;\n            } else {\n                templates.render('tiny_cursive/no_submission').then(html => {\n                    document.getElementById('content' + mid).innerHTML = html;\n                }).catch(e => window.console.error(e));\n            }\n            return false;\n        };\n\n        var usersTable = {\n            init: function (page, hasApiKey, csvOption) {\n                str.get_strings([{ key: \"field_require\", component: \"tiny_cursive\" }])\n                    .done(function () {\n                        usersTable.getusers(page);\n                    });\n\n                let myEvents = new AnalyticEvents();\n                (async function () {\n                    try {\n                        let scoreSetting = await str.get_string('confidence_threshold', 'tiny_cursive');\n                        analyticsEvents(scoreSetting, hasApiKey, parseInt(csvOption));\n                    } catch (error) {\n                        window.console.error('Error fetching string:', error);\n                    }\n                })();\n\n                /**\n                 * Handles the analytics events for each modal on the page.\n                 *\n                 * This function iterates over each element with the class `analytic-modal`,\n                 * retrieves necessary data attributes, and makes an AJAX call to get writing\n                 * statistics. Once the data is retrieved, it processes and displays it within\n                 * the modal.\n                 *\n                 * @param {Object} scoreSetting - Configuration settings related to scoring.\n                 * @param {boolean} hasApiKey - API key status\n                 * @param {boolean} csvOption - CSV option status\n                 */\n                function analyticsEvents(scoreSetting, hasApiKey, csvOption) {\n                    const analyticModals = document.querySelectorAll(\".analytic-modal\");\n\n                    analyticModals.forEach(modalElement => {\n                        const mid = modalElement.dataset.id;\n                        const filepath = modalElement.dataset.filepath;\n                        let context = {};\n                        context.userid = mid;\n                        const cmid = modalElement.dataset.cmid;\n\n                        AJAX.call([{\n                            methodname: 'cursive_get_writing_statistics',\n                            args: { cmid: cmid, fileid: mid },\n                        }])[0].done(response => {\n                            try {\n                                let data = JSON.parse(response.data);\n                                modalElement.innerHTML = '';\n                                modalElement.appendChild(analyticButton(hasApiKey ? data.effort_ratio : \"\", mid));\n\n                                context.formattime = myEvents.formatedTime(data);\n                                context.tabledata = data;\n                                context.apikey = hasApiKey;\n\n                                let authIcon = myEvents.authorshipStatus(data.first_file, data.score, scoreSetting);\n                                myEvents.createModal(mid, context, '', replayInstances, authIcon);\n                                myEvents.analytics(mid, templates, context, '', replayInstances, authIcon);\n                                myEvents.checkDiff(mid, mid, '', replayInstances);\n                                myEvents.replyWriting(mid, filepath, '', replayInstances);\n                            } catch (error) {\n                                window.console.error('Failed to parse response data:', error);\n                            }\n                        }).fail(error => {\n                            throw new Error('Error: ' + error.message);\n                        });\n                    });\n\n                    document.querySelectorAll('.download-btn').forEach(function(button) {\n                        button.addEventListener('click', async function(e) {\n                            e.preventDefault();\n\n                            const link1 = this.getAttribute('href');\n                            const link2 = this.getAttribute('data-link');\n\n                            window.console.log(\"link1 \", link1);\n                            window.console.log(\"link2 \", link2);\n\n                            let type = Factory.types.SAVE_CANCEL;\n                            let optionModal = Modal;\n                            let select = document.createElement('select');\n                            select.id = \"download-type\";\n                            select.classList.add('form-control', 'inputUrl');\n\n                            let title;\n                            try {\n                                title = await str.get_string('download', 'tiny_cursive');\n                            } catch (error) {\n                                window.console.error(error);\n                            }\n\n                            // Add CSV option\n                            if (csvOption) {\n                                try {\n                                    const text = await str.get_string('payloadjson', 'tiny_cursive');\n                                    let option = document.createElement('option');\n                                    option.text = text;\n                                    option.value = 0;\n                                    select.appendChild(option);\n                                } catch (error) {\n                                    window.console.error(error);\n                                }\n                            }\n\n                            // Add API key option\n                            if (hasApiKey) {\n                                try {\n                                    const text = await str.get_string('analyticspdf', 'tiny_cursive');\n                                    let option2 = document.createElement('option');\n                                    option2.text = text;\n                                    option2.value = 1;\n                                    select.appendChild(option2);\n                                } catch (error) {\n                                    window.console.error(error);\n                                }\n                            }\n\n                            // If no options available\n                            if (!hasApiKey && !csvOption) {\n                                try {\n                                    const noOptionText = await str.get_string('no_option', 'tiny_cursive');\n                                    const messageText = await str.get_string('message', 'tool_dataprivacy');\n                                    title = messageText;\n                                    type = Factory.types.ALERT;\n                                    optionModal = Alert;\n                                    select = noOptionText;\n                                } catch (error) {\n                                    window.console.error(error);\n                                }\n                            }\n\n                            optionModal.create({\n                                type: type,\n                                title: title,\n                                body: select,\n                                removeOnClose: true,\n                                buttons: type === Factory.types.SAVE_CANCEL ? [{\n                                    text: 'OK',\n                                    type: 'submit',\n                                    primary: true\n                                }] : []\n                            }).then(modal => {\n                                modal.show();\n\n                                if (type === Factory.types.SAVE_CANCEL) {\n                                    modal.getRoot().on(Events.save, function() {\n                                        const data = document.getElementById('download-type');\n                                        if (!data) {\n                                            return;\n                                        }\n\n                                        if (parseInt(data.value)) {\n                                            window.location.href = link2;\n                                        } else {\n                                            window.location.href = link1;\n                                        }\n                                    });\n                                }\n\n                                return modal;\n                            });\n\n                        });\n                    });\n\n                }\n            },\n\n            getusers: function (page) {\n                document.getElementById(\"id_coursename\").addEventListener('change', function () {\n                    const courseid = this.value;\n\n                    AJAX.call([{\n                        methodname: \"cursive_get_user_list\",\n                        args: { courseid: courseid },\n                    }])[0].done(function (json) {\n                        const data = JSON.parse(json);\n                        const context = {\n                            tabledata: data,\n                            page: page,\n                        };\n                        templates.render(\"tiny_cursive/user_list\", context)\n                            .then(function (html) {\n                                document.getElementById(\"id_username\").innerHTML = html;\n                                return true;\n                            });\n                    });\n\n                    AJAX.call([{\n                        methodname: \"cursive_get_module_list\",\n                        args: { courseid: courseid },\n                    }])[0].done(function (json) {\n                        const data = JSON.parse(json);\n                        const context = {\n                            tabledata: data,\n                            page: page,\n                        };\n                        templates.render(\"tiny_cursive/module_list\", context)\n                            .then(function (html) {\n                                document.getElementById(\"id_modulename\").innerHTML = html;\n                                return true;\n                            });\n                    });\n                });\n            },\n        };\n\n        return usersTable;\n    });\n"],"names":["define","AJAX","str","templates","Replay","analyticButton","AnalyticEvents","Events","Modal","Factory","Alert","replayInstances","window","video_playback","mid","filepath","replay","render","then","html","document","getElementById","innerHTML","catch","e","console","error","usersTable","init","page","hasApiKey","csvOption","get_strings","key","component","done","getusers","myEvents","scoreSetting","querySelectorAll","forEach","modalElement","dataset","id","context","userid","cmid","call","methodname","args","fileid","response","data","JSON","parse","appendChild","effort_ratio","formattime","formatedTime","tabledata","apikey","authIcon","authorshipStatus","first_file","score","createModal","analytics","checkDiff","replyWriting","fail","Error","message","button","addEventListener","async","preventDefault","link1","this","getAttribute","link2","log","title","type","types","SAVE_CANCEL","optionModal","select","createElement","classList","add","get_string","text","option","value","option2","noOptionText","ALERT","create","body","removeOnClose","buttons","primary","modal","show","getRoot","on","save","parseInt","location","href","analyticsEvents","courseid","json"],"mappings":"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"}