{"version":3,"file":"cursive_writing_reports.min.js","sources":["../src/cursive_writing_reports.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module     tiny_cursive/cursive_writing_reports\n * @category TinyMCE Editor\n * @copyright  CTI <info@cursivetechnology.com>\n * @author kuldeep singh <mca.kuldeep.sekhon@gmail.com>\n */\n\ndefine([\"jquery\", \"core/ajax\", \"core/str\", \"core/templates\", \"./replay\", './analytic_button', './replay_button',\n\"./analytic_events\", \"core/modal_events\", \"./replay_modal\", 'core/modal_save_cancel', 'core/modal_factory', 'core/modal'],\n    function(\n    $,\n    AJAX,\n    str,\n    templates,\n    Replay,\n    analyticButton,\n    replayButton,\n    AnalyticEvents,\n    Events,\n    replayModal,\n    Modal,\n    Factory,\n    Alert\n) {\n    const replayInstances = {};\n    // eslint-disable-next-line\n    window.video_playback = function (mid, filepath) {\n        if (filepath !== '') {\n            const replay = new Replay(\n                'content' + mid,\n                filepath,\n                10,\n                false,\n                'player_' + mid\n            );\n            replayInstances[mid] = replay;\n        } else {\n            // eslint-disable-next-line\n            templates.render('tiny_cursive/no_submission').then(html => {\n                $('#content' + mid).html(html);\n            }).catch(e => window.console.error(e));\n        }\n        return false;\n\n    };\n    var usersTable = {\n        init: function(page, hasApiKey, csvOption) {\n            str\n                .get_strings([\n                    {key: \"field_require\", component: \"tiny_cursive\"},\n                ])\n                .done(function() {\n                    usersTable.getusers(page);\n                });\n\n            let myEvents = new AnalyticEvents();\n            (async function() {\n                try {\n                    let scoreSetting = await str.get_string('confidence_threshold', 'tiny_cursive');\n                    analyticsEvents(scoreSetting, hasApiKey, parseInt(csvOption));\n                } catch (error) {\n                    window.console.error('Error fetching string:', error);\n                }\n            })();\n\n            /**\n             * Handles the analytics events for each modal on the page.\n             *\n             * This function iterates over each element with the class `analytic-modal`,\n             * retrieves necessary data attributes, and makes an AJAX call to get writing\n             * statistics. Once the data is retrieved, it processes and displays it within\n             * the modal.\n             *\n             * @param {Object} scoreSetting - Configuration settings related to scoring.\n             * @param {boolean} hasApiKey - api key status\n             * @param {boolean} csvOption - csv option status\n             */\n            function analyticsEvents(scoreSetting, hasApiKey, csvOption) {\n\n                $(\".analytic-modal\").each(function() {\n                    var mid = $(this).data(\"id\");\n                    var filepath = $(this).data(\"filepath\");\n                    let context = {};\n                    context.userid = mid;\n                    let cmid = $(this).data(\"cmid\");\n\n\n                        // If no API key, show only replay button and skip analytics\n                        if (!hasApiKey) {\n                            $(this).html(replayButton(mid));\n\n                            $(document).off('click', '#replay' + mid).on('click', '#replay' + mid, function(e) {\n                                e.preventDefault();\n                                const context = {\n                                    mid: mid\n                                };\n                                replayModal.create({templateContext: context}).then(modal => {\n                                    modal.show();\n                                    window.video_playback(mid, filepath);\n                                    return modal;\n                                }).catch(error => {\n                                    window.console.error('Failed to create replay modal:', error);\n                                });\n                            });\n                            return;\n                    }\n                    AJAX.call([{\n                        methodname: 'cursive_get_writing_statistics',\n                        args: {\n                            cmid: cmid,\n                            fileid: mid,\n                        },\n                    }])[0].done(response => {\n                        let data = JSON.parse(response.data);\n\n                        $(this).html(analyticButton(hasApiKey ? data.effort_ratio : \"\", $(this).data('id')));\n\n                        context.formattime = myEvents.formatedTime(data);\n                        context.tabledata = data;\n                        context.apikey = hasApiKey;\n                        // Perform actions that require context.tabledata\n                        let authIcon = myEvents.authorshipStatus(data.first_file, data.score, scoreSetting);\n                        myEvents.createModal(mid, context, '', replayInstances, authIcon);\n                        myEvents.analytics(mid, templates, context, '', replayInstances, authIcon);\n                        myEvents.checkDiff(mid, mid, '', replayInstances);\n                        myEvents.replyWriting(mid, filepath, '', replayInstances);\n\n                    }).fail(error => {\n                        throw new Error('Error: ' + error.message);\n                    });\n\n                });\n\n                $('.download-btn').on('click', async function(e) {\n                    e.preventDefault();\n\n                    const link1 = $(this).attr('href');\n                    const link2 = $(this).data('link');\n\n                    let type = Factory.types.SAVE_CANCEL;\n                    let optionModal = Modal;\n                    let select = document.createElement('select');\n                    select.id = \"download-type\";\n                    select.classList.add('form-control', 'inputUrl');\n\n                    let title = await str.get_string('download', 'tiny_cursive');\n\n                    // Add CSV option\n                    if (csvOption) {\n                        try {\n                            const text = await str.get_string('payloadjson', 'tiny_cursive');\n                            let option = document.createElement('option');\n                            option.text = text;\n                            option.value = 0;\n                            select.appendChild(option);\n                        } catch (error) {\n                            window.console.error(error);\n                        }\n                    }\n\n                    // Add API key option\n                    if (hasApiKey) {\n                        try {\n                            const text = await str.get_string('analyticspdf', 'tiny_cursive');\n                            let option2 = document.createElement('option');\n                            option2.text = text;\n                            option2.value = 1;\n                            select.appendChild(option2);\n                        } catch (error) {\n                            window.console.error(error);\n                        }\n                    }\n\n                    // If no options available\n                    if (!hasApiKey && !csvOption) {\n                        try {\n                            const noOptionText = await str.get_string('no_option', 'tiny_cursive');\n                            const messageText = await str.get_string('message', 'tool_dataprivacy');\n                            title = messageText;\n                            type = Factory.types.ALERT;\n                            optionModal = Alert;\n                            select = noOptionText;\n                        } catch (error) {\n                            window.console.error(error);\n                        }\n                    }\n\n                    optionModal.create({\n                        type: type,\n                        title: title,\n                        body: select,\n                        removeOnClose: true,\n                        buttons: type === Factory.types.SAVE_CANCEL ? [{\n                            text: 'OK',\n                            type: 'submit',\n                            primary: true\n                        }] : []\n                    }).then(modal => {\n                        modal.show();\n\n                        if (type === Factory.types.SAVE_CANCEL) {\n                            modal.getRoot().on(Events.save, function() {\n                                const data = document.getElementById('download-type');\n                                if (!data) {\n                                    return;\n                                }\n                                if (parseInt(data.value)) {\n                                    window.location.href = link2;\n                                } else {\n                                    window.location.href = link1;\n                                }\n                            });\n                        }\n                        return modal;\n                    }).catch(error => {\n                        window.console.error('failed to open modal', error);\n                    });\n                });\n\n            }\n        },\n        getusers: function(page) {\n            $(\"#id_coursename\").change(function() {\n                var courseid = $(this).val();\n                var promise1 = AJAX.call([\n                    {\n                        methodname: \"cursive_get_user_list\",\n                        args: {\n                            courseid: courseid,\n                        },\n                    },\n                ]);\n                promise1[0].done(function(json) {\n                    var data = JSON.parse(json);\n                    var context = {\n                        tabledata: data,\n                        page: page,\n                    };\n                    // eslint-disable-next-line\n                    templates\n                        .render(\"tiny_cursive/user_list\", context)\n                        .then(function(html) {\n\n                            var filteredUser = $(\"#id_username\");\n                            filteredUser.html(html);\n                            return true;\n                        });\n                });\n\n                var promise2 = AJAX.call([\n                    {\n                        methodname: \"cursive_get_module_list\",\n                        args: {\n                            courseid: courseid,\n                        },\n                    },\n                ]);\n                promise2[0].done(function(json) {\n                    var data = JSON.parse(json);\n                    var context = {\n                        tabledata: data,\n                        page: page,\n                    };\n                    // eslint-disable-next-line\n                    templates\n                        .render(\"tiny_cursive/module_list\", context)\n                        .then(function(html) {\n\n                            var filteredUser = $(\"#id_modulename\");\n                            filteredUser.html(html);\n                            return true;\n                        });\n                });\n            });\n        },\n    };\n    return usersTable;\n});\n"],"names":["define","$","AJAX","str","templates","Replay","analyticButton","replayButton","AnalyticEvents","Events","replayModal","Modal","Factory","Alert","replayInstances","window","video_playback","mid","filepath","replay","render","then","html","catch","e","console","error","usersTable","init","page","hasApiKey","csvOption","get_strings","key","component","done","getusers","myEvents","scoreSetting","each","this","data","context","userid","cmid","document","off","on","preventDefault","create","templateContext","modal","show","call","methodname","args","fileid","response","JSON","parse","effort_ratio","formattime","formatedTime","tabledata","apikey","authIcon","authorshipStatus","first_file","score","createModal","analytics","checkDiff","replyWriting","fail","Error","message","async","link1","attr","link2","type","types","SAVE_CANCEL","optionModal","select","createElement","id","classList","add","title","get_string","text","option","value","appendChild","option2","noOptionText","ALERT","body","removeOnClose","buttons","primary","getRoot","save","getElementById","parseInt","location","href","analyticsEvents","change","courseid","val","json"],"mappings":"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"}