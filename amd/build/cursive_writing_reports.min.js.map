{"version":3,"file":"cursive_writing_reports.min.js","sources":["../src/cursive_writing_reports.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module     tiny_cursive/cursive_writing_reports\n * @category TinyMCE Editor\n * @copyright  CTI <info@cursivetechnology.com>\n * @author kuldeep singh <mca.kuldeep.sekhon@gmail.com>\n */\n\ndefine([\"jquery\", \"core/ajax\", \"core/str\", \"core/templates\", \"./replay\", './analytic_button', './replay_button',\n\"./analytic_events\", \"core/modal_events\", 'core/modal_save_cancel', 'core/modal_factory', 'core/modal'],\n    function(\n    $,\n    AJAX,\n    str,\n    templates,\n    Replay,\n    analyticButton,\n    replayButton,\n    AnalyticEvents,\n    Events,\n    Modal,\n    Factory,\n    Alert\n) {\n    const replayInstances = {};\n    // eslint-disable-next-line\n    window.video_playback = function (mid, filepath) {\n        if (filepath !== '') {\n            const replay = new Replay(\n                'content' + mid,\n                filepath,\n                10,\n                false,\n                'player_' + mid\n            );\n            replayInstances[mid] = replay;\n        } else {\n            // eslint-disable-next-line\n            templates.render('tiny_cursive/no_submission').then(html => {\n                $('#content' + mid).html(html);\n            }).catch(e => window.console.error(e));\n        }\n        return false;\n\n    };\n    var usersTable = {\n        init: function(page, hasApiKey, csvOption) {\n            str\n                .get_strings([\n                    {key: \"field_require\", component: \"tiny_cursive\"},\n                ])\n                .done(function() {\n                    usersTable.getusers(page);\n                });\n\n            let myEvents = new AnalyticEvents();\n            (async function() {\n                try {\n                    let scoreSetting = await str.get_string('confidence_threshold', 'tiny_cursive');\n                    analyticsEvents(scoreSetting, hasApiKey, parseInt(csvOption));\n                } catch (error) {\n                    window.console.error('Error fetching string:', error);\n                }\n            })();\n\n            /**\n             * Handles the analytics events for each modal on the page.\n             *\n             * This function iterates over each element with the class `analytic-modal`,\n             * retrieves necessary data attributes, and makes an AJAX call to get writing\n             * statistics. Once the data is retrieved, it processes and displays it within\n             * the modal.\n             *\n             * @param {Object} scoreSetting - Configuration settings related to scoring.\n             * @param {boolean} hasApiKey - api key status\n             * @param {boolean} csvOption - csv option status\n             */\n            function analyticsEvents(scoreSetting, hasApiKey, csvOption) {\n\n                $(\".analytic-modal\").each(function() {\n                    var mid = $(this).data(\"id\");\n                    var filepath = $(this).data(\"filepath\");\n                    let context = {};\n                    context.userid = mid;\n                    let cmid = $(this).data(\"cmid\");\n\n                    AJAX.call([{\n                        methodname: 'cursive_get_writing_statistics',\n                        args: {\n                            cmid: cmid,\n                            fileid: mid,\n                        },\n                    }])[0].done(response => {\n                        let data = JSON.parse(response.data);\n\n                        // Show replay button if no API key, otherwise show analytics button\n                        if (!hasApiKey) {\n                            $(this).html(replayButton(mid));\n                        } else {\n                            $(this).html(analyticButton(data.effort_ratio, $(this).data('id')));\n                        }\n\n                        context.formattime = myEvents.formatedTime(data);\n                        context.tabledata = data;\n                        context.apikey = hasApiKey;\n                        // Perform actions that require context.tabledata\n                        let authIcon = myEvents.authorshipStatus(data.first_file, data.score, scoreSetting);\n                        myEvents.createModal(mid, context, '', replayInstances, authIcon);\n                        myEvents.analytics(mid, templates, context, '', replayInstances, authIcon);\n                        myEvents.checkDiff(mid, mid, '', replayInstances);\n                        myEvents.replyWriting(mid, filepath, '', replayInstances);\n\n                    }).fail(error => {\n                        throw new Error('Error: ' + error.message);\n                    });\n\n                });\n\n                $('.download-btn').on('click', async function(e) {\n                    e.preventDefault();\n\n                    const link1 = $(this).attr('href');\n                    const link2 = $(this).data('link');\n\n                    let type = Factory.types.SAVE_CANCEL;\n                    let optionModal = Modal;\n                    let select = document.createElement('select');\n                    select.id = \"download-type\";\n                    select.classList.add('form-control', 'inputUrl');\n\n                    let title = await str.get_string('download', 'tiny_cursive');\n\n                    // Add CSV option\n                    if (csvOption) {\n                        try {\n                            const text = await str.get_string('payloadjson', 'tiny_cursive');\n                            let option = document.createElement('option');\n                            option.text = text;\n                            option.value = 0;\n                            select.appendChild(option);\n                        } catch (error) {\n                            window.console.error(error);\n                        }\n                    }\n\n                    // Add API key option\n                    if (hasApiKey) {\n                        try {\n                            const text = await str.get_string('analyticspdf', 'tiny_cursive');\n                            let option2 = document.createElement('option');\n                            option2.text = text;\n                            option2.value = 1;\n                            select.appendChild(option2);\n                        } catch (error) {\n                            window.console.error(error);\n                        }\n                    }\n\n                    // If no options available\n                    if (!hasApiKey && !csvOption) {\n                        try {\n                            const noOptionText = await str.get_string('no_option', 'tiny_cursive');\n                            const messageText = await str.get_string('message', 'tool_dataprivacy');\n                            title = messageText;\n                            type = Factory.types.ALERT;\n                            optionModal = Alert;\n                            select = noOptionText;\n                        } catch (error) {\n                            window.console.error(error);\n                        }\n                    }\n\n                    optionModal.create({\n                        type: type,\n                        title: title,\n                        body: select,\n                        removeOnClose: true,\n                        buttons: type === Factory.types.SAVE_CANCEL ? [{\n                            text: 'OK',\n                            type: 'submit',\n                            primary: true\n                        }] : []\n                    }).then(modal => {\n                        modal.show();\n\n                        if (type === Factory.types.SAVE_CANCEL) {\n                            modal.getRoot().on(Events.save, function() {\n                                const data = document.getElementById('download-type');\n                                if (!data) {\n                                    return;\n                                }\n                                if (parseInt(data.value)) {\n                                    window.location.href = link2;\n                                } else {\n                                    window.location.href = link1;\n                                }\n                            });\n                        }\n                        return modal;\n                    }).catch(error => {\n                        window.console.error('failed to open modal', error);\n                    });\n                });\n\n            }\n        },\n        getusers: function(page) {\n            $(\"#id_coursename\").change(function() {\n                var courseid = $(this).val();\n                var promise1 = AJAX.call([\n                    {\n                        methodname: \"cursive_get_user_list\",\n                        args: {\n                            courseid: courseid,\n                        },\n                    },\n                ]);\n                promise1[0].done(function(json) {\n                    var data = JSON.parse(json);\n                    var context = {\n                        tabledata: data,\n                        page: page,\n                    };\n                    // eslint-disable-next-line\n                    templates\n                        .render(\"tiny_cursive/user_list\", context)\n                        .then(function(html) {\n\n                            var filteredUser = $(\"#id_username\");\n                            filteredUser.html(html);\n                            return true;\n                        });\n                });\n\n                var promise2 = AJAX.call([\n                    {\n                        methodname: \"cursive_get_module_list\",\n                        args: {\n                            courseid: courseid,\n                        },\n                    },\n                ]);\n                promise2[0].done(function(json) {\n                    var data = JSON.parse(json);\n                    var context = {\n                        tabledata: data,\n                        page: page,\n                    };\n                    // eslint-disable-next-line\n                    templates\n                        .render(\"tiny_cursive/module_list\", context)\n                        .then(function(html) {\n\n                            var filteredUser = $(\"#id_modulename\");\n                            filteredUser.html(html);\n                            return true;\n                        });\n                });\n            });\n        },\n    };\n    return usersTable;\n});\n"],"names":["define","$","AJAX","str","templates","Replay","analyticButton","replayButton","AnalyticEvents","Events","Modal","Factory","Alert","replayInstances","window","video_playback","mid","filepath","replay","render","then","html","catch","e","console","error","usersTable","init","page","hasApiKey","csvOption","get_strings","key","component","done","getusers","myEvents","scoreSetting","each","this","data","context","userid","cmid","call","methodname","args","fileid","response","JSON","parse","effort_ratio","formattime","formatedTime","tabledata","apikey","authIcon","authorshipStatus","first_file","score","createModal","analytics","checkDiff","replyWriting","fail","Error","message","on","async","preventDefault","link1","attr","link2","type","types","SAVE_CANCEL","optionModal","select","document","createElement","id","classList","add","title","get_string","text","option","value","appendChild","option2","noOptionText","ALERT","create","body","removeOnClose","buttons","primary","modal","show","getRoot","save","getElementById","parseInt","location","href","analyticsEvents","change","courseid","val","json"],"mappings":"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"}