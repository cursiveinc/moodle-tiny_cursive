{"version":3,"file":"cursive_writing_reports.min.js","sources":["../src/cursive_writing_reports.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * @module     tiny_cursive/cursive_writing_reports\r\n * @category TinyMCE Editor\r\n * @copyright  CTI <info@cursivetechnology.com>\r\n * @author kuldeep singh <mca.kuldeep.sekhon@gmail.com>\r\n */\r\n\r\ndefine([\"jquery\", \"core/ajax\", \"core/str\", \"core/templates\", \"./replay\", './analytic_button', './replay_button',\r\n\"./analytic_events\", \"core/modal_events\", 'core/modal_save_cancel', 'core/modal_factory', 'core/modal'],\r\n    function(\r\n    $,\r\n    AJAX,\r\n    str,\r\n    templates,\r\n    Replay,\r\n    analyticButton,\r\n    replayButton,\r\n    AnalyticEvents,\r\n    Events,\r\n    Modal,\r\n    Factory,\r\n    Alert\r\n) {\r\n    const replayInstances = {};\r\n    // eslint-disable-next-line\r\n    window.video_playback = function (mid, filepath) {\r\n        if (filepath !== '') {\r\n            const replay = new Replay(\r\n                'content' + mid,\r\n                filepath,\r\n                10,\r\n                false,\r\n                'player_' + mid\r\n            );\r\n            replayInstances[mid] = replay;\r\n        } else {\r\n            // eslint-disable-next-line\r\n            templates.render('tiny_cursive/no_submission').then(html => {\r\n                $('#content' + mid).html(html);\r\n            }).catch(e => window.console.error(e));\r\n        }\r\n        return false;\r\n\r\n    };\r\n    var usersTable = {\r\n        init: function(page, hasApiKey, csvOption) {\r\n            str\r\n                .get_strings([\r\n                    {key: \"field_require\", component: \"tiny_cursive\"},\r\n                ])\r\n                .done(function() {\r\n                    usersTable.getusers(page);\r\n                });\r\n\r\n            let myEvents = new AnalyticEvents();\r\n            (async function() {\r\n                try {\r\n                    let scoreSetting = await str.get_string('confidence_threshold', 'tiny_cursive');\r\n                    analyticsEvents(scoreSetting, hasApiKey, parseInt(csvOption));\r\n                } catch (error) {\r\n                    window.console.error('Error fetching string:', error);\r\n                }\r\n            })();\r\n\r\n            /**\r\n             * Handles the analytics events for each modal on the page.\r\n             *\r\n             * This function iterates over each element with the class `analytic-modal`,\r\n             * retrieves necessary data attributes, and makes an AJAX call to get writing\r\n             * statistics. Once the data is retrieved, it processes and displays it within\r\n             * the modal.\r\n             *\r\n             * @param {Object} scoreSetting - Configuration settings related to scoring.\r\n             * @param {boolean} hasApiKey - api key status\r\n             * @param {boolean} csvOption - csv option status\r\n             */\r\n            function analyticsEvents(scoreSetting, hasApiKey, csvOption) {\r\n\r\n                $(\".analytic-modal\").each(function() {\r\n                    var mid = $(this).data(\"id\");\r\n                    var filepath = $(this).data(\"filepath\");\r\n                    let context = {};\r\n                    context.userid = mid;\r\n                    let cmid = $(this).data(\"cmid\");\r\n\r\n                    AJAX.call([{\r\n                        methodname: 'cursive_get_writing_statistics',\r\n                        args: {\r\n                            cmid: cmid,\r\n                            fileid: mid,\r\n                        },\r\n                    }])[0].done(response => {\r\n                        let data = JSON.parse(response.data);\r\n\r\n                        // Show replay button if no API key, otherwise show analytics button\r\n                        if (!hasApiKey) {\r\n                            $(this).html(replayButton(mid));\r\n                        } else {\r\n                            $(this).html(analyticButton(data.effort_ratio, $(this).data('id')));\r\n                        }\r\n\r\n                        context.formattime = myEvents.formatedTime(data);\r\n                        context.tabledata = data;\r\n                        context.apikey = hasApiKey;\r\n                        // Perform actions that require context.tabledata\r\n                        let authIcon = myEvents.authorshipStatus(data.first_file, data.score, scoreSetting);\r\n                        myEvents.createModal(mid, context, '', replayInstances, authIcon);\r\n                        myEvents.analytics(mid, templates, context, '', replayInstances, authIcon);\r\n                        myEvents.checkDiff(mid, mid, '', replayInstances);\r\n                        myEvents.replyWriting(mid, filepath, '', replayInstances);\r\n\r\n                    }).fail(error => {\r\n                        throw new Error('Error: ' + error.message);\r\n                    });\r\n\r\n                });\r\n\r\n                $('.download-btn').on('click', async function(e) {\r\n                    e.preventDefault();\r\n\r\n                    const link1 = $(this).attr('href');\r\n                    const link2 = $(this).data('link');\r\n\r\n                    let type = Factory.types.SAVE_CANCEL;\r\n                    let optionModal = Modal;\r\n                    let select = document.createElement('select');\r\n                    select.id = \"download-type\";\r\n                    select.classList.add('form-control', 'inputUrl');\r\n\r\n                    let title = await str.get_string('download', 'tiny_cursive');\r\n\r\n                    // Add CSV option\r\n                    if (csvOption) {\r\n                        try {\r\n                            const text = await str.get_string('payloadjson', 'tiny_cursive');\r\n                            let option = document.createElement('option');\r\n                            option.text = text;\r\n                            option.value = 0;\r\n                            select.appendChild(option);\r\n                        } catch (error) {\r\n                            window.console.error(error);\r\n                        }\r\n                    }\r\n\r\n                    // Add API key option\r\n                    if (hasApiKey) {\r\n                        try {\r\n                            const text = await str.get_string('analyticspdf', 'tiny_cursive');\r\n                            let option2 = document.createElement('option');\r\n                            option2.text = text;\r\n                            option2.value = 1;\r\n                            select.appendChild(option2);\r\n                        } catch (error) {\r\n                            window.console.error(error);\r\n                        }\r\n                    }\r\n\r\n                    // If no options available\r\n                    if (!hasApiKey && !csvOption) {\r\n                        try {\r\n                            const noOptionText = await str.get_string('no_option', 'tiny_cursive');\r\n                            const messageText = await str.get_string('message', 'tool_dataprivacy');\r\n                            title = messageText;\r\n                            type = Factory.types.ALERT;\r\n                            optionModal = Alert;\r\n                            select = noOptionText;\r\n                        } catch (error) {\r\n                            window.console.error(error);\r\n                        }\r\n                    }\r\n\r\n                    optionModal.create({\r\n                        type: type,\r\n                        title: title,\r\n                        body: select,\r\n                        removeOnClose: true,\r\n                        buttons: type === Factory.types.SAVE_CANCEL ? [{\r\n                            text: 'OK',\r\n                            type: 'submit',\r\n                            primary: true\r\n                        }] : []\r\n                    }).then(modal => {\r\n                        modal.show();\r\n\r\n                        if (type === Factory.types.SAVE_CANCEL) {\r\n                            modal.getRoot().on(Events.save, function() {\r\n                                const data = document.getElementById('download-type');\r\n                                if (!data) {\r\n                                    return;\r\n                                }\r\n                                if (parseInt(data.value)) {\r\n                                    window.location.href = link2;\r\n                                } else {\r\n                                    window.location.href = link1;\r\n                                }\r\n                            });\r\n                        }\r\n                        return modal;\r\n                    }).catch(error => {\r\n                        window.console.error('failed to open modal', error);\r\n                    });\r\n                });\r\n\r\n            }\r\n        },\r\n        getusers: function(page) {\r\n            $(\"#id_coursename\").change(function() {\r\n                var courseid = $(this).val();\r\n                var promise1 = AJAX.call([\r\n                    {\r\n                        methodname: \"cursive_get_user_list\",\r\n                        args: {\r\n                            courseid: courseid,\r\n                        },\r\n                    },\r\n                ]);\r\n                promise1[0].done(function(json) {\r\n                    var data = JSON.parse(json);\r\n                    var context = {\r\n                        tabledata: data,\r\n                        page: page,\r\n                    };\r\n                    // eslint-disable-next-line\r\n                    templates\r\n                        .render(\"tiny_cursive/user_list\", context)\r\n                        .then(function(html) {\r\n\r\n                            var filteredUser = $(\"#id_username\");\r\n                            filteredUser.html(html);\r\n                            return true;\r\n                        });\r\n                });\r\n\r\n                var promise2 = AJAX.call([\r\n                    {\r\n                        methodname: \"cursive_get_module_list\",\r\n                        args: {\r\n                            courseid: courseid,\r\n                        },\r\n                    },\r\n                ]);\r\n                promise2[0].done(function(json) {\r\n                    var data = JSON.parse(json);\r\n                    var context = {\r\n                        tabledata: data,\r\n                        page: page,\r\n                    };\r\n                    // eslint-disable-next-line\r\n                    templates\r\n                        .render(\"tiny_cursive/module_list\", context)\r\n                        .then(function(html) {\r\n\r\n                            var filteredUser = $(\"#id_modulename\");\r\n                            filteredUser.html(html);\r\n                            return true;\r\n                        });\r\n                });\r\n            });\r\n        },\r\n    };\r\n    return usersTable;\r\n});\r\n"],"names":["define","$","AJAX","str","templates","Replay","analyticButton","replayButton","AnalyticEvents","Events","Modal","Factory","Alert","replayInstances","window","video_playback","mid","filepath","replay","render","then","html","catch","e","console","error","usersTable","init","page","hasApiKey","csvOption","get_strings","key","component","done","getusers","myEvents","scoreSetting","each","this","data","context","userid","cmid","call","methodname","args","fileid","response","JSON","parse","effort_ratio","formattime","formatedTime","tabledata","apikey","authIcon","authorshipStatus","first_file","score","createModal","analytics","checkDiff","replyWriting","fail","Error","message","on","async","preventDefault","link1","attr","link2","type","types","SAVE_CANCEL","optionModal","select","document","createElement","id","classList","add","title","get_string","text","option","value","appendChild","option2","noOptionText","ALERT","create","body","removeOnClose","buttons","primary","modal","show","getRoot","save","getElementById","parseInt","location","href","analyticsEvents","change","courseid","val","json"],"mappings":"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"}