define("tiny_cursive/replay",["exports","core/ajax","core/templates","jquery","core/str"],(function(_exports,_ajax,_templates,_jquery,Str){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_templates=_interopRequireDefault(_templates),_jquery=_interopRequireDefault(_jquery),Str=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(Str);return _exports.default=class{controllerId="";constructor(elementId,filePath){let speed=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,loop=arguments.length>3&&void 0!==arguments[3]&&arguments[3],controllerId=arguments.length>4?arguments[4]:void 0;this.controllerId=controllerId,this.replayInProgress=!1,this.speed=parseFloat(speed),this.loop=loop,this.highlightedChars=[],this.deletedChars=[],this.cursorPosition=0,this.currentEventIndex=0,this.totalEvents=0,this.currentTime=0,this.totalDuration=0,this.usercomments=[],this.pasteTimestamps=[],this.originalContent="",this.isPasteEvent=!1;const element=document.getElementById(elementId);if(!element)throw new Error(`Element with id '${elementId}' not found`);this.outputElement=element,this.outputElement.classList.add("tiny_cursive_outputElement"),this.loadJSON(filePath).then((data=>{if(data.status){var val=JSON.parse(data.data);if(this.logData=val,this.originalContent=data.original,data.comments){var comments=JSON.parse(data.comments);this.usercomments=Array.isArray(comments)?[...comments]:[]}if("data"in this.logData&&(this.logData=this.logData.data),"payload"in this.logData&&(this.logData=this.logData.payload),this.logData.length>0&&this.logData[0].unixTimestamp){const startTime=this.logData[0].unixTimestamp;this.logData=this.logData.map((event=>({...event,normalizedTime:event.unixTimestamp-startTime}))),this.totalDuration=this.logData[this.logData.length-1].normalizedTime}this.totalEvents=this.logData.length,this.identifyPasteEvents(),controllerId&&this.logData&&this.constructController(controllerId),this.startReplay()}else try{Promise.all([_templates.default.render("tiny_cursive/no_submission"),Str.get_string("warningpayload","tiny_cursive")]).then((function(results){var html=results[0],str=results[1],newElement=(0,_jquery.default)(html);return newElement.text(str),(0,_jquery.default)(".tiny_cursive").html(newElement),!0})).catch((function(error){window.console.error(error)}))}catch(error){window.console.error(error)}return data})).catch((error=>{try{Promise.all([_templates.default.render("tiny_cursive/no_submission"),Str.get_string("warningpayload","tiny_cursive")]).then((function(results){var html=results[0],str=results[1],newElement=(0,_jquery.default)(html);newElement.text(str),(0,_jquery.default)(".tiny_cursive").html(newElement)})).catch((function(error){window.console.error(error)}))}catch(error){window.console.error(error)}window.console.error("Error loading JSON file: "+error.message)}))}stopReplay(){if(this.replayInProgress){clearTimeout(this.replayTimeout),this.replayInProgress=!1;var playSvg=document.createElement("img");playSvg.src=M.util.image_url("playicon","tiny_cursive"),this.playButton&&(this.playButton.querySelector(".play-icon").innerHTML=playSvg.outerHTML)}}constructController(controllerId){this.replayInProgress=!1,this.currentPosition=0,this.speed=1,this.replayIntervalId&&(clearInterval(this.replayIntervalId),this.replayIntervalId=null);const container=document.getElementById(controllerId);if(!container)return void window.console.error("Container element not found with ID:",controllerId);container.querySelectorAll(".replay-control").forEach((control=>control.remove()));container.querySelectorAll(".paste-events-panel").forEach((panel=>panel.remove()));const controlContainer=document.createElement("div");controlContainer.classList.add("tiny_cursive_replay_control","replay-control");const topRow=document.createElement("div");topRow.classList.add("tiny_cursive_top_row"),this.playButton=document.createElement("button"),this.playButton.classList.add("tiny_cursive_play_button");const playSvg=document.createElement("i");playSvg.className="",this.playButton.innerHTML=`<span class="play-icon">${playSvg.outerHTML}</span>`,this.playButton.classList.add("tiny_cursive_play_button"),this.playButton.addEventListener("click",(()=>{if(this.replayInProgress){this.stopReplay();const playSvg=document.createElement("img");playSvg.src=M.util.image_url("playicon","tiny_cursive"),this.playButton.querySelector(".play-icon").innerHTML=playSvg.outerHTML}else this.startReplay(!1)})),topRow.appendChild(this.playButton);const scrubberContainer=document.createElement("div");scrubberContainer.classList.add("tiny_cursive_scrubber_container"),this.scrubberElement=document.createElement("input"),this.scrubberElement.classList.add("tiny_cursive_timeline_scrubber","timeline-scrubber"),this.scrubberElement.id="timelineScrubber",this.scrubberElement.type="range",this.scrubberElement.max="100",this.scrubberElement.min="0",this.scrubberElement.value="0",this.scrubberElement.addEventListener("input",(()=>{const scrubberValue=parseInt(this.scrubberElement.value,10);this.skipToTime(scrubberValue)})),scrubberContainer.appendChild(this.scrubberElement),topRow.appendChild(scrubberContainer);const bottomRow=document.createElement("div");bottomRow.classList.add("tiny_cursive_bottom_row");const speedContainer=document.createElement("div");speedContainer.classList.add("tiny_cursive_speed_controls","speed-controls");const speedLabel=document.createElement("span");speedLabel.classList.add("tiny_cursive_speed_label"),speedContainer.appendChild(speedLabel),speedLabel.textContent="Speed: ";const speedGroup=document.createElement("div");speedGroup.classList.add("tiny_cursive_speed_group"),[1,1.5,2,5,10].forEach((speedValue=>{const speedBtn=document.createElement("button");speedBtn.textContent=`${speedValue}x`,speedBtn.classList.add("tiny_cursive_speed_btn","speed-btn"),parseFloat(speedValue)===parseFloat(this.speed)&&speedBtn.classList.add("active"),speedBtn.dataset.speed=speedValue,speedBtn.addEventListener("click",(()=>{document.querySelectorAll(".tiny_cursive_speed_btn").forEach((btn=>{btn.classList.remove("active")})),speedBtn.classList.add("active"),this.speed=parseFloat(speedBtn.dataset.speed);this.replayInProgress&&(this.stopReplay(),this.startReplay(!1))})),speedGroup.appendChild(speedBtn)})),speedContainer.appendChild(speedGroup),bottomRow.appendChild(speedContainer),controlContainer.appendChild(topRow),controlContainer.appendChild(bottomRow),this.timeDisplay=document.createElement("div"),this.timeDisplay.classList.add("tiny_cursive_time_display"),this.timeDisplay.textContent="00:00 / 00:00",topRow.appendChild(this.timeDisplay);const pasteEventsToggle=document.createElement("div");pasteEventsToggle.classList.add("tiny_cursive_paste_events_toggle","paste-events-toggle");const pasteEventsIcon=document.createElement("span"),pasteIcon=document.createElement("img");pasteIcon.src=M.util.image_url("pasteicon","tiny_cursive"),pasteEventsIcon.innerHTML=pasteIcon.outerHTML,pasteEventsIcon.classList.add("tiny_cursive_paste_events_icon");const pasteEventsText=document.createElement("span");pasteEventsText.textContent="Paste Events";const pasteEventCount=document.createElement("span");pasteEventCount.textContent=`(${this.pasteTimestamps.length})`,pasteEventCount.className="paste-event-count",pasteEventCount.style.marginLeft="2px";const chevronIcon=document.createElement("span"),chevron=document.createElement("i");chevron.className="fa fa-chevron-down",chevronIcon.innerHTML=chevron.outerHTML,chevronIcon.style.marginLeft="5px",chevronIcon.style.transition="transform 0.3s ease",pasteEventsToggle.appendChild(pasteEventsIcon),pasteEventsToggle.appendChild(pasteEventsText),pasteEventsToggle.appendChild(pasteEventCount),pasteEventsToggle.appendChild(chevronIcon);const pasteEventsPanel=document.createElement("div");pasteEventsPanel.classList.add("tiny_cursive_paste_events_panel","paste-events-panel"),this.populatePasteEventsPanel(pasteEventsPanel),pasteEventsToggle.addEventListener("click",(()=>{const isHidden="none"===pasteEventsPanel.style.display;pasteEventsPanel.style.display=isHidden?"block":"none",chevronIcon.style.transform=isHidden?"rotate(180deg)":"rotate(0)"})),bottomRow.appendChild(pasteEventsToggle),controlContainer.appendChild(pasteEventsPanel),this.pasteEventsPanel=pasteEventsPanel,this.pasteEventCount=pasteEventCount,container.insertBefore(controlContainer,container.firstChild)}identifyPasteEvents(){this.pasteTimestamps=[];let controlPressed=!1,pasteCount=0;for(let i=0;i<this.logData.length;i++){const event=this.logData[i];if(event.event&&"keydown"===event.event.toLowerCase())if("Control"===event.key)controlPressed=!0;else if("v"===event.key&&controlPressed){const pastePosition=event.rePosition,timestamp=event.normalizedTime||0;let pasteEndPosition=pastePosition,pasteLength=0,j=i+1;for(;j<this.logData.length&&("v"===this.logData[j].key&&"keyUp"===this.logData[j].event||"Control"===this.logData[j].key&&"keyUp"===this.logData[j].event||"left"===this.logData[j].key&&"mouseUp"===this.logData[j].event||"left"===this.logData[j].key&&"mouseDown"===this.logData[j].event||"right"===this.logData[j].key&&"mouseUp"===this.logData[j].event||"right"===this.logData[j].key&&"mouseDown"===this.logData[j].event);)j++;j<this.logData.length&&void 0!==this.logData[j].rePosition?(pasteEndPosition=this.logData[j].rePosition,pasteLength=pasteEndPosition-pastePosition):this.originalContent&&pastePosition<this.originalContent.length&&(pasteEndPosition=this.originalContent.length,pasteLength=pasteEndPosition-pastePosition);let FinalPasteLength=pasteLength,lastrePosition=pasteEndPosition;for(let k=j;k<this.logData.length;k++)if(void 0!==this.logData[k].rePosition)if("keyDown"===this.logData[k].event&&"Backspace"===this.logData[k].key)FinalPasteLength--,k++;else{if(this.logData[k].rePosition>lastrePosition)break;lastrePosition=this.logData[k].rePosition}let pastedText="";if(FinalPasteLength>0&&this.originalContent){const start=Math.min(pastePosition,this.originalContent.length),end=Math.min(pastePosition+FinalPasteLength,this.originalContent.length);pastedText=this.originalContent.substring(start,end)}this.pasteTimestamps.push({index:pasteCount,time:timestamp,formattedTime:this.formatTime(timestamp),pastedText:pastedText,startPosition:pastePosition,endPosition:pastePosition+FinalPasteLength,timestamp:timestamp}),pasteCount++,controlPressed=!1}else controlPressed=!1}this.pasteEventsPanel&&this.populatePasteEventsPanel(this.pasteEventsPanel)}populatePasteEventsPanel(panel){for(panel.innerHTML="";panel.firstChild;)panel.removeChild(panel.firstChild);panel.classList.add("tiny_cursive_event_panel");const pasteEvents=this.pasteTimestamps&&this.pasteTimestamps.length?this.pasteTimestamps:[];if(!pasteEvents||0===pasteEvents.length){const noEventsMessage=document.createElement("div");return noEventsMessage.className="no-paste-events-message p-3",noEventsMessage.textContent="No paste events detected for this submission.",void panel.appendChild(noEventsMessage)}const carouselContainer=document.createElement("div");carouselContainer.classList.add("tiny_cursive_paste_events_carousel","paste-events-carousel");const navigationRow=document.createElement("div");navigationRow.classList.add("paste-events-navigation","tiny_cursive_navigation_row");const counterDisplay=document.createElement("div");counterDisplay.classList.add("paste-events-counter","tiny_cursive_counter_display"),counterDisplay.textContent="Paste Events";const navButtons=document.createElement("div");navButtons.classList.add("tiny_cursive_nav_buttons","tiny_cursive_nav_buttons");const prevButton=document.createElement("button");prevButton.classList.add("paste-event-prev-btn","tiny_cursive_nav_button");const leftChevron=document.createElement("i");leftChevron.className="fa fa-chevron-left",prevButton.innerHTML=leftChevron.outerHTML;const nextButton=document.createElement("button");nextButton.className="paste-event-next-btn tiny_cursive_nav_button";const rightChevron=document.createElement("i");rightChevron.className="fa fa-chevron-right",nextButton.innerHTML=rightChevron.outerHTML,nextButton.disabled=pasteEvents.length<=1,navButtons.appendChild(prevButton),navButtons.appendChild(nextButton),navigationRow.appendChild(counterDisplay),navigationRow.appendChild(navButtons);const contentContainer=document.createElement("div");contentContainer.className="paste-events-content tiny_cursive_content_container";const createPasteEventDisplay=pasteEvent=>{const eventRow=document.createElement("div");eventRow.className="tiny_cursive_event_row";const headerRow=document.createElement("div");headerRow.className="tiny_cursive_header_row";const textContainer=document.createElement("div");textContainer.className="tiny_cursive_text_container";const timestampContainer=document.createElement("div");timestampContainer.className="paste-event-timestamp tiny_cursive_paste_event_timestamp",timestampContainer.textContent=pasteEvent.formattedTime;const pastedTextContainer=document.createElement("div");pastedTextContainer.className="paste-event-text tiny_cursive_pasted_text_container",pastedTextContainer.textContent=pasteEvent.pastedText,textContainer.appendChild(timestampContainer),textContainer.appendChild(pastedTextContainer);const playButton=document.createElement("button");playButton.className="paste-event-play-btn tiny_cursive_seekplay_button";const playIcon=document.createElement("img");return playIcon.src=M.util.image_url("seekplayicon","tiny_cursive"),playButton.innerHTML=playIcon.outerHTML,playButton.addEventListener("click",(()=>{this.jumpToTimestamp(pasteEvent.timestamp)})),headerRow.appendChild(textContainer),headerRow.appendChild(playButton),eventRow.appendChild(headerRow),eventRow};contentContainer.appendChild(createPasteEventDisplay(pasteEvents[0])),carouselContainer.appendChild(navigationRow),carouselContainer.appendChild(contentContainer),panel.appendChild(carouselContainer);let currentIndex=0;prevButton.addEventListener("click",(()=>{currentIndex>0&&(currentIndex--,updatePasteEventDisplay())})),nextButton.addEventListener("click",(()=>{currentIndex<pasteEvents.length-1&&(currentIndex++,updatePasteEventDisplay())}));const updatePasteEventDisplay=()=>{contentContainer.innerHTML="",contentContainer.appendChild(createPasteEventDisplay(pasteEvents[currentIndex])),counterDisplay.textContent="Paste Events",prevButton.disabled=0===currentIndex,prevButton.style.opacity=0===currentIndex?"0.5":"1",nextButton.disabled=currentIndex===pasteEvents.length-1,nextButton.style.opacity=currentIndex===pasteEvents.length-1?"0.5":"1"}}jumpToTimestamp(timestamp){const percentage=this.totalDuration>0?timestamp/this.totalDuration*100:0;this.skipToTime(percentage),this.replayInProgress||this.startReplay(!1)}setScrubberVal(value){if(this.scrubberElement&&(this.scrubberElement.value=String(value),this.timeDisplay)){const displayTime=Math.min(this.currentTime,this.totalDuration),currentTimeFormatted=this.formatTime(displayTime),totalTimeFormatted=this.formatTime(this.totalDuration);this.timeDisplay.textContent=`${currentTimeFormatted} / ${totalTimeFormatted}`}}loadJSON(filePath){return(0,_ajax.call)([{methodname:"cursive_get_reply_json",args:{filepath:filePath}}])[0].done((response=>response)).fail((error=>{throw new Error("Error loading JSON file: "+error.message)}))}formatTime(ms){const seconds=Math.floor(ms/1e3),remainingSeconds=seconds%60;return`${Math.floor(seconds/60).toString().padStart(2,"0")}:${remainingSeconds.toString().padStart(2,"0")}`}startReplay(){let reset=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.replayInProgress&&clearTimeout(this.replayTimeout);if((this.totalDuration>0&&this.currentTime>=this.totalDuration||this.currentEventIndex>=this.totalEvents)&&!reset&&(reset=!0),this.replayInProgress=!0,reset&&(this.outputElement.innerHTML="",this.text="",this.cursorPosition=0,this.currentEventIndex=0,this.currentTime=0,this.highlightedChars=[],this.deletedChars=[],this.isControlKeyPressed=!1),this.playButton){const pauseSvg=document.createElement("i");pauseSvg.className="fa fa-pause",this.playButton.querySelector(".play-icon").innerHTML=pauseSvg.outerHTML}this.replayLog()}replayLog(){if(this.replayInProgress){for(;this.currentEventIndex<this.logData.length;){const event=this.logData[this.currentEventIndex];if(event.normalizedTime&&event.normalizedTime>this.currentTime)break;let text=this.text||"",cursor=this.cursorPosition||0,updatedHighlights=[...this.highlightedChars],updatedDeleted=[...this.deletedChars];if(void 0!==event.rePosition&&(cursor=Math.max(0,Math.min(event.rePosition,text.length))),event.event&&"keydown"===event.event.toLowerCase()){const charToInsert=this.applyKey(event.key);if("Control"===event.key?this.isControlKeyPressed=!0:"v"!==event.key?("Control"!==event.key&&(this.isControlKeyPressed=!1),"Backspace"!==event.key&&"ArrowLeft"!==event.key&&"ArrowRight"!==event.key&&(this.isPasteEvent=!1)):"v"==event.key&&this.isControlKeyPressed&&(this.isPasteEvent=!0,this.isControlKeyPressed=!1),"Backspace"===event.key&&this.isControlKeyPressed){if(cursor>0){let wordStart=cursor;for(;wordStart>0&&" "===text[wordStart-1];)wordStart--;for(;wordStart>0&&" "!==text[wordStart-1];)wordStart--;const wordToDelete=text.substring(wordStart,cursor);for(let i=0;i<wordToDelete.length;i++)updatedDeleted.push({index:wordStart+i,char:wordToDelete[i],time:this.currentTime,expiresAt:this.currentTime+2e3});text=text.substring(0,wordStart)+text.substring(cursor),cursor=wordStart}this.isControlKeyPressed=!1}else"Backspace"!==event.key||this.isPasteEvent?"ArrowLeft"===event.key?cursor=Math.max(0,cursor-1):"ArrowRight"===event.key?cursor=Math.min(text.length,cursor+1):null!==charToInsert&&""!==charToInsert&&(text=text.substring(0,cursor)+charToInsert+text.substring(cursor),""!==charToInsert.trim()&&updatedHighlights.push({index:cursor,char:charToInsert,time:this.currentTime,expiresAt:this.currentTime+1500}),cursor++):cursor>0&&(updatedDeleted.push({index:cursor-1,char:text[cursor-1],time:this.currentTime,expiresAt:this.currentTime+2e3}),text=text.substring(0,cursor-1)+text.substring(cursor),cursor--)}this.text=text,this.cursorPosition=cursor,this.highlightedChars=updatedHighlights.filter((h=>!h.expiresAt||h.expiresAt>this.currentTime)),this.deletedChars=updatedDeleted.filter((d=>!d.expiresAt||d.expiresAt>this.currentTime)),this.currentEventIndex++}if(this.updateDisplayText(this.text,this.cursorPosition,this.highlightedChars,this.deletedChars),this.totalDuration>0){const percentComplete=Math.min(this.currentTime/this.totalDuration*100,100);this.setScrubberVal(percentComplete)}if(this.replayInProgress){const baseIncrement=100,incrementTime=baseIncrement/this.speed;this.currentTime+=baseIncrement,this.currentEventIndex>=this.totalEvents?this.loop?this.startReplay(!0):(this.stopReplay(),this.updateDisplayText(this.text,this.cursorPosition,[],[])):this.replayTimeout=setTimeout((()=>this.replayLog()),incrementTime)}}else this.updateDisplayText(this.text,this.cursorPosition,[],[])}skipToEnd(){this.replayInProgress&&(this.replayInProgress=!1);let textOutput="";this.logData.forEach((event=>{"keydown"===event.event.toLowerCase()&&(textOutput=this.applyKey(event.key,textOutput))})),this.outputElement.innerHTML=textOutput.slice(0,-1),this.setScrubberVal(100)}skipToTime(percentage){const wasPlaying=this.replayInProgress;wasPlaying&&(this.replayInProgress=!1,clearTimeout(this.replayTimeout));const targetTime=this.totalDuration*percentage/100;this.currentTime=targetTime,this.currentEventIndex=0,this.text="",this.cursorPosition=0,this.highlightedChars=[],this.deletedChars=[],this.isControlKeyPressed=!1;let text="",cursor=0;for(let i=0;i<this.logData.length;i++){const event=this.logData[i];if(event.normalizedTime&&event.normalizedTime>targetTime){this.currentEventIndex=i;break}if(void 0!==event.rePosition&&(cursor=Math.max(0,Math.min(event.rePosition,text.length))),event.event&&"keydown"===event.event.toLowerCase()){const charToInsert=this.applyKey(event.key);if("Control"===event.key?this.isControlKeyPressed=!0:"v"!==event.key?("Control"!==event.key&&(this.isControlKeyPressed=!1),"Backspace"!==event.key&&"ArrowLeft"!==event.key&&"ArrowRight"!==event.key&&(this.isPasteEvent=!1)):"v"==event.key&&this.isControlKeyPressed&&(this.isPasteEvent=!0,this.isControlKeyPressed=!1),"Backspace"===event.key&&this.isControlKeyPressed){if(cursor>0){let wordStart=cursor;for(;wordStart>0&&" "===text[wordStart-1];)wordStart--;for(;wordStart>0&&" "!==text[wordStart-1];)wordStart--;const wordToDelete=text.substring(wordStart,cursor);for(let i=0;i<wordToDelete.length;i++)this.deletedChars.push({index:wordStart+i,char:wordToDelete[i],time:targetTime,expiresAt:targetTime+2e3});text=text.substring(0,wordStart)+text.substring(cursor),cursor=wordStart}this.isControlKeyPressed=!1}else"Backspace"!==event.key||this.isPasteEvent?"ArrowLeft"===event.key?cursor=Math.max(0,cursor-1):"ArrowRight"===event.key?cursor=Math.min(text.length,cursor+1):charToInsert&&charToInsert.length>0&&(text=text.substring(0,cursor)+charToInsert+text.substring(cursor),""!==charToInsert.trim()&&this.highlightedChars.push({index:cursor,char:charToInsert,time:targetTime,expiresAt:targetTime+1e3}),cursor++):cursor>0&&(this.deletedChars.push({index:cursor-1,char:text[cursor-1],time:targetTime,expiresAt:targetTime+1e3}),text=text.substring(0,cursor-1)+text.substring(cursor),cursor=Math.max(0,cursor-1))}this.currentEventIndex=i+1}this.text=text,this.cursorPosition=cursor,this.updateDisplayText(text,cursor,this.highlightedChars,this.deletedChars),this.setScrubberVal(percentage),wasPlaying&&(this.replayInProgress=!0,this.replayLog())}updateDisplayText(text,cursorPosition,highlights,deletions){let html="";const highlightMap={},deletionMap={},currentTime=this.currentTime;highlights.forEach((h=>{let opacity=1;if(h.expiresAt){const timeRemaining=h.expiresAt-currentTime;timeRemaining<500&&(opacity=Math.max(0,timeRemaining/500))}highlightMap[h.index]={char:h.char,opacity:opacity}})),deletions.forEach((d=>{let opacity=.5;if(d.expiresAt){const timeRemaining=d.expiresAt-currentTime;timeRemaining<500&&(opacity=Math.max(0,timeRemaining/500*.5))}deletionMap[d.index]={char:d.char,opacity:opacity}}));const outOfRangeDeletions=deletions.filter((d=>d.index>=text.length)),textLines=text.split("\n");let currentPosition=0;for(let lineIndex=0;lineIndex<textLines.length;lineIndex++){const line=textLines[lineIndex];for(let i=0;i<line.length;i++){currentPosition===cursorPosition&&(html+='<span class="tiny_cursive-cursor">|</span>');const char=line[i];if(deletionMap[currentPosition]){const deletion=deletionMap[currentPosition];html+=`<span class="tiny_cursive-deleted-char" style="opacity: ${deletion.opacity};">${deletion.char}</span>`}if(highlightMap[currentPosition]&&" "!==char){html+=`<span class="tiny_cursive-highlighted-char" style="opacity: ${highlightMap[currentPosition].opacity};">${char}</span>`}else html+=" "===char?"&nbsp;":this.escapeHtml(char);currentPosition++}currentPosition===cursorPosition&&(html+='<span class="tiny_cursive-cursor">|</span>'),lineIndex<textLines.length-1&&(html+="<br>",currentPosition++)}if(cursorPosition!==text.length||html.endsWith('<span class="tiny_cursive-cursor">|</span>')||(html+='<span class="tiny_cursive-cursor">|</span>'),outOfRangeDeletions.length>0){outOfRangeDeletions.sort(((a,b)=>a.index-b.index));const cursorHTML='<span class="tiny_cursive-cursor">|</span>';let cursorPos=html.lastIndexOf(cursorHTML);if(-1!==cursorPos){let deletedWordHTML='<span class="tiny_cursive-deleted-char" style="opacity: 0.5;">';outOfRangeDeletions.forEach((d=>{deletedWordHTML+=d.char})),deletedWordHTML+="</span>",html=html.substring(0,cursorPos)+deletedWordHTML+html.substring(cursorPos)}}const wasScrolledToBottom=this.outputElement.scrollHeight-this.outputElement.clientHeight<=this.outputElement.scrollTop+1;this.outputElement.innerHTML=html,(wasScrolledToBottom||this.isCursorBelowViewport())&&(this.outputElement.scrollTop=this.outputElement.scrollHeight)}isCursorBelowViewport(){const cursorElement=this.outputElement.querySelector(".tiny_cursive-cursor:last-of-type");if(!cursorElement)return!1;const cursorRect=cursorElement.getBoundingClientRect(),outputRect=this.outputElement.getBoundingClientRect();return cursorRect.bottom>outputRect.bottom}escapeHtml(unsafe){return unsafe.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}applyKey(key){switch(key){case"Enter":return"\n";case"Backspace":case"ControlBackspace":return"";case" ":return" ";default:return["Shift","Ctrl","Alt","ArrowDown","ArrowUp","Control","ArrowRight","ArrowLeft","Meta","CapsLock","Tab","Escape","Delete","PageUp","PageDown","Insert","Home","End","NumLock","AudioVolumeUp","AudioVolumeDown","MediaPlayPause"].includes(key)?"":key}}},_exports.default}));

//# sourceMappingURL=replay.min.js.map