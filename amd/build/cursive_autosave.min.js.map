{"version":3,"file":"cursive_autosave.min.js","sources":["../src/cursive_autosave.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * TODO describe module cursive_autosave\n *\n * @module     tiny_cursive/cursive_autosave\n * @copyright  2025 Cursive Technology, Inc. <info@cursivetechnology.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {iconSaved} from 'tiny_cursive/common';\nimport templates from 'core/templates';\nimport {call} from 'core/ajax';\nimport Icons from 'tiny_cursive/svg_repo';\n\nexport default class CursiveAutosave {\n\n    static instance = null;\n\n\n    constructor(editor, rightWrapper, modules, isFullScreen) {\n        if (CursiveAutosave.instance) {\n            return CursiveAutosave.instance;\n        }\n\n        this.editor = editor;\n        this.module = modules;\n        this.savingState = '';\n        this.rightWrapper = rightWrapper;\n        this.isFullScreen = isFullScreen;\n        // Bind methods that will be used as event listener\n        this.fetchSavedContent = this.fetchSavedContent.bind(this);\n        this.handleEscapeKey = this.handleEscapeKey.bind(this);\n        this._savingTimer = null;\n        CursiveAutosave.instance = this;\n    }\n\n    static getInstance(editor, rightWrapper, modules, isFullScreen) {\n        if (!this.instance) {\n            this.instance = new CursiveAutosave(editor, rightWrapper, modules, isFullScreen);\n        }\n        this.isFullScreen = isFullScreen;\n        if (!document.querySelector('#tiny_cursive_savingState')) {\n            this.instance.init();\n        }\n\n        return this.instance;\n    }\n\n    init() {\n        const stateWrapper = this.cursiveSavingState(this.savingState);\n        stateWrapper.classList.add('tiny_cursive_savingState', 'btn');\n        stateWrapper.id = 'tiny_cursive_savingState';\n\n        if (this.isFullScreen) {\n            this.rightWrapper.prepend(stateWrapper);\n        } else {\n            this.rightWrapper.appendChild(stateWrapper);\n        }\n\n        stateWrapper.addEventListener('click', this.fetchSavedContent);\n    }\n\n    destroy() {\n        CursiveAutosave.instance = null;\n    }\n\n    static destroyInstance() {\n        if (this.instance) {\n            this.instance.destroy();\n            this.instance = null;\n        }\n    }\n\n    /**\n * Creates a wrapper div containing an icon and text to display the saving state\n * @param {string} state - The current saving state ('saving', 'saved', or 'offline')\n * @returns {HTMLElement} A div element containing the state icon and text\n * @description Creates and returns a div element with an icon and text span to show the current saving state.\n * The icon and text are updated based on the provided state parameter.\n */\n    cursiveSavingState(state) {\n        let wrapperDiv = document.createElement('div');\n        let icon = document.createElement('img');\n        let textSpan = document.createElement('span');\n        let button = document.createElement('button');\n        button.style.padding = '.3rem';\n\n        textSpan.style.fontSize = '0.75rem';\n        textSpan.style.color = 'gray';\n        textSpan.id = 'CursiveStateText';\n        if (state) {\n            textSpan.textContent = this.getStateText(state);\n            icon.src = this.getStateIcon(state);\n        }\n        icon.style.width = '20px';\n        icon.style.height = '20px';\n        icon.style.marginRight = '5px';\n        icon.style.display = 'none';\n        wrapperDiv.style.verticalAlign = 'middle';\n\n        wrapperDiv.appendChild(icon);\n        wrapperDiv.appendChild(textSpan);\n        button.appendChild(wrapperDiv);\n\n        return button;\n    }\n\n    /**\n     * Updates the saving state icon and text in the editor\n     * @param {string} state - The state to update to ('saving', 'saved', or 'offline')\n     * @description Updates the global saving state and modifies the UI elements to reflect the new state\n     */\n    static updateSavingState(state) {\n        const instance = this.instance;\n        instance.savingState = state;\n        let stateWrapper = document.querySelector('.tiny_cursive_savingState');\n        let stateTextEl = document.getElementById('CursiveStateText');\n\n        if (!stateWrapper) {\n            return;\n        }\n\n        let img = stateWrapper.querySelector('img');\n        let span = stateWrapper.querySelector('span');\n\n        img.style.display = 'inline';\n        span.textContent = instance.getStateText(state);\n        img.src = instance.getStateIcon(state);\n\n        if (instance._savingTimer) {\n            clearTimeout(instance._savingTimer);\n        }\n\n        if (state === 'saved' && stateTextEl) {\n            instance._savingTimer = setTimeout(() => {\n                stateTextEl.textContent = '';\n            }, 5000);\n        }\n    }\n\n    /**\n     * Gets the display text for a given saving state\n     * @param {string} state - The state to get text for ('saving', 'saved', or 'offline')\n     * @returns {string} The text to display for the given state\n     * @description Returns appropriate text label based on the current saving state\n     */\n    getStateText(state) {\n        switch (state) {\n            case 'saving': return 'saving';\n            case 'saved': return 'saved';\n            case 'offline': return 'offline';\n            default: return '';\n        }\n    }\n\n    /**\n     * Gets the icon URL for a given saving state\n     * @param {string} state - The state to get icon for ('saving', 'saved', or 'offline')\n     * @returns {string} The URL of the icon image for the given state\n     * @description Returns appropriate icon URL based on the current saving state\n     */\n    getStateIcon(state) {\n        switch (state) {\n            case 'saving': return iconSaved;\n            case 'saved': return iconSaved;\n            case 'offline': return 'data:image/svg+xml;base64,' + btoa(Icons.offline);\n            default: return '';\n        }\n    }\n\n    /**\n     * Fetches and displays saved content in a dropdown\n     * @async\n     * @param {Event} e - The event object\n     * @description Handles fetching and displaying saved content when the save state button is clicked.\n     * If the dropdown is already visible, it will be closed. Otherwise it will fetch saved content\n     * from the server (or use cached content if available) and display it in a dropdown panel.\n     * @throws {Error} Logs error to console if fetching content fails\n     */\n    async fetchSavedContent(e) {\n        e.preventDefault();\n\n        let dropdown = document.querySelector('#savedDropdown');\n        let isVisible = dropdown?.classList?.contains('show');\n\n        if (isVisible) {\n            this.closeSavedDropdown();\n            return;\n        }\n        const editorWrapper = document.querySelector('#tiny_cursive_savingState');\n\n        let args = {\n            id: this.module.resourceId,\n            cmid: this.module.cmid,\n            modulename: `${this.module.modulename}_autosave`,\n            questionid: this.module.questionid,\n            userid: this.module.userid,\n            courseid: this.module.courseid\n        };\n\n        call([{\n            methodname: \"cursive_get_autosave_content\",\n            args: args\n        }])[0].done((data) => {\n            let context = { comments: JSON.parse(data) };\n            Object.values(context.comments).forEach(content => {\n                content.time = this.timeAgo(content.timemodified);\n            });\n            this.renderCommentList(context, editorWrapper);\n\n        }).fail((error) => {\n            this.editor.windowManager.alert(`You are currently offline. Saved content\n                                    cannot be retrieved until you are back online.`);\n            window.console.error('Error fetching saved content:', error);\n        });\n    }\n\n    /**\n     * Toggles the visibility of the saved content dropdown\n     * @description Checks if the saved content dropdown is currently visible and either closes or opens it accordingly.\n     * If visible, calls closeSavedDropdown(). If hidden, calls openSavedDropdown().\n     */\n    toggleSavedDropdown() {\n        const dropdown = document.querySelector('#savedDropdown');\n        const isVisible = dropdown?.classList?.contains('show');\n\n        if (isVisible) {\n            this.closeSavedDropdown();\n        } else {\n            this.openSavedDropdown();\n        }\n    }\n\n    /**\n     * Opens the saved content dropdown panel\n     * @description Shows the saved content dropdown by adding the 'show' class and sets up an event listener\n     * for the Escape key to allow closing the dropdown. This  is called when toggling the dropdown open.\n     */\n    openSavedDropdown() {\n        const dropdown = document.querySelector('#savedDropdown');\n\n        dropdown.classList.add('show');\n\n        // Add event listener to close on Escape key\n        document.addEventListener('keydown', this.handleEscapeKey);\n    }\n\n    /**\n     * Closes the saved content dropdown panel\n     * @description Removes the 'show' class from the dropdown to hide it, removes the dropdown element from the DOM,\n     * and removes the Escape key event listener. This  is called when toggling the dropdown closed or when\n     * clicking outside the dropdown.\n     */\n    closeSavedDropdown() {\n        const dropdown = document.querySelector('#savedDropdown');\n        dropdown.classList.remove('show');\n        dropdown.remove();\n\n        // Remove event listener\n        document.removeEventListener('keydown', this.handleEscapeKey);\n    }\n\n    /**\n     * Handles the Escape key press event for closing the saved content dropdown\n     * @param {KeyboardEvent} event - The keyboard event object\n     * @description Event handler that checks if the Escape key was pressed and closes the saved content dropdown if it was\n     */\n    handleEscapeKey(event) {\n        if (event.key === 'Escape') {\n            this.closeSavedDropdown();\n        }\n    }\n\n    timeAgo(unixTime) {\n        const seconds = Math.floor(Date.now() / 1000) - unixTime;\n\n        if (seconds < 5) {\n            return \"just now\";\n        }\n        if (seconds < 60) {\n            return `${seconds} sec ago`;\n        }\n\n        const minutes = Math.floor(seconds / 60);\n        if (minutes < 60) {\n            return `${minutes} min ago`;\n        }\n\n        const hours = Math.floor(minutes / 60);\n        if (hours < 24) {\n            return `${hours} hour${hours > 1 ? \"s\" : \"\"} ago`;\n        }\n\n        const days = Math.floor(hours / 24);\n        if (days < 7) {\n            return `${days} day${days > 1 ? \"s\" : \"\"} ago`;\n        }\n\n        const weeks = Math.floor(days / 7);\n        if (weeks < 4) {\n            return `${weeks} week${weeks > 1 ? \"s\" : \"\"} ago`;\n        }\n\n        const months = Math.floor(days / 30);\n        if (months < 12) {\n            return `${months} month${months > 1 ? \"s\" : \"\"} ago`;\n        }\n\n        const years = Math.floor(days / 365);\n        return `${years} year${years > 1 ? \"s\" : \"\"} ago`;\n    }\n\n\n    /**\n     * Renders the saved content dropdown list using a template\n     * @param {Object} context - The context object containing saved comments data to render\n     * @param {HTMLElement} editorWrapper - The wrapper element to attach the dropdown to\n     * @description Renders the saved content dropdown using the tiny_cursive/saved_content template.\n     * Creates and positions the dropdown relative to the editor wrapper element.\n     * Handles toggling visibility and caching of the saved content.\n     * @throws {Error} Logs error to console if template rendering fails\n     */\n    renderCommentList(context, editorWrapper) {\n        templates.render('tiny_cursive/saved_content', context).then(html => {\n            editorWrapper.style.position = 'relative';\n\n            const tempDiv = document.createElement('div');\n            tempDiv.innerHTML = html.trim();\n            tempDiv.id = 'savedDropdown';\n            tempDiv.classList.add('saved-dropdown');\n\n            if (!tempDiv) {\n                window.console.error(\"Saved content template rendered empty or invalid HTML.\");\n                return false;\n            }\n\n            // Add to DOM if not already added\n            let existingPanel = document.querySelector('#savedDropdown');\n\n            if (!existingPanel) {\n                editorWrapper.appendChild(tempDiv);\n                existingPanel = tempDiv;\n            }\n\n            // Toggle visibility\n            existingPanel.classList.toggle('active');\n            this.toggleSavedDropdown();\n\n            this.insertSavedItems(this.editor);\n\n            return true;\n\n        }).catch(error => window.console.error(error));\n    }\n\n    /**\n     * Adds click event listeners to saved content items to insert them into the editor\n     * @description Finds all elements with class 'item-preview' and adds click handlers that will\n     * insert the element's text content into the editor when clicked. The text is inserted with\n     * a leading space.\n     * @param {Object} editor - The TinyMCE editor instance\n     * @returns {void}\n     */\n    insertSavedItems(editor) {\n        const items = document.querySelectorAll('.item-preview');\n        items.forEach(element => {\n            element.addEventListener('click', function () {\n                editor.insertContent(\" \" + this.textContent);\n            });\n        });\n    }\n\n}"],"names":["CursiveAutosave","constructor","editor","rightWrapper","modules","isFullScreen","instance","module","savingState","fetchSavedContent","this","bind","handleEscapeKey","_savingTimer","document","querySelector","init","stateWrapper","cursiveSavingState","classList","add","id","prepend","appendChild","addEventListener","destroy","state","wrapperDiv","createElement","icon","textSpan","button","style","padding","fontSize","color","textContent","getStateText","src","getStateIcon","width","height","marginRight","display","verticalAlign","stateTextEl","getElementById","img","span","clearTimeout","setTimeout","iconSaved","btoa","Icons","offline","e","preventDefault","dropdown","_dropdown$classList","contains","closeSavedDropdown","editorWrapper","args","resourceId","cmid","modulename","questionid","userid","courseid","methodname","done","data","context","comments","JSON","parse","Object","values","forEach","content","time","timeAgo","timemodified","renderCommentList","fail","error","windowManager","alert","window","console","toggleSavedDropdown","_dropdown$classList2","openSavedDropdown","remove","removeEventListener","event","key","unixTime","seconds","Math","floor","Date","now","minutes","hours","days","weeks","months","years","render","then","html","position","tempDiv","innerHTML","trim","existingPanel","toggle","insertSavedItems","catch","querySelectorAll","element","insertContent"],"mappings":"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"}