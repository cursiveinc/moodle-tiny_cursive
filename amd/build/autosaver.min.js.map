{"version":3,"file":"autosaver.min.js","sources":["../src/autosaver.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * @module     tiny_cursive/autosaver\r\n * @category   TinyMCE Editor\r\n * @copyright  CTI <info@cursivetechnology.com>\r\n * @author     Brain Station 23 <sales@brainstation-23.com>\r\n */\r\n\r\nimport {call} from 'core/ajax';\r\nimport {create} from 'core/modal_factory';\r\nimport {get_string as getString} from 'core/str';\r\nimport {save, cancel, hidden} from 'core/modal_events';\r\nimport $ from 'jquery';\r\nimport {iconUrl, iconGrayUrl, tooltipCss} from 'tiny_cursive/common';\r\nimport Autosave from 'tiny_cursive/cursive_autosave';\r\nimport DocumentView from 'tiny_cursive/document_view';\r\nimport {call as getUser} from \"core/ajax\";\r\n\r\nexport const register = (editor, interval, userId, hasApiKey, MODULES, Rubrics, submission, quizInfo, pasteSetting) => {\r\n\r\n    var isStudent = !($('#body').hasClass('teacher_admin'));\r\n    var intervention = $('#body').hasClass('intervention');\r\n    var host = M.cfg.wwwroot;\r\n    var userid = userId;\r\n    var courseid = M.cfg.courseId;\r\n    var editorid = editor?.id;\r\n    var cmid = M.cfg.contextInstanceId;\r\n    var ed = \"\";\r\n    var event = \"\";\r\n    var filename = \"\";\r\n    var questionid = 0;\r\n    var quizSubmit = $('#mod_quiz-next-nav');\r\n    let assignSubmit = $('#id_submitbutton');\r\n    var syncInterval = interval ? interval * 1000 : 10000; // Default: Sync Every 10s.\r\n    var lastCaretPos = 1;\r\n    let aiContents = [];\r\n    var isFullScreen = false;\r\n    var user = null;\r\n    let ur = window.location.href;\r\n    let parm = new URL(ur);\r\n    let modulesInfo = getModulesInfo(ur, parm, MODULES);\r\n    var resourceId = modulesInfo.resourceId;\r\n    var modulename = modulesInfo.name;\r\n    var errorAlert = true;\r\n    let PASTE_SETTING = pasteSetting || 'allow';\r\n    let shouldBlockPaste = false;\r\n    let isPasteAllowed = false;\r\n\r\n    if (ur.includes('pdfannotator')) {\r\n        document.addEventListener('click', e => {\r\n            if (e.target.className === \"dropdown-item comment-edit-a\") {\r\n                let id = e.target.id;\r\n                resourceId = id.replace('editButton', '');\r\n                localStorage.setItem('isEditing', '1');\r\n            }\r\n            if (e.target.id === 'commentSubmit') {\r\n                syncData();\r\n            }\r\n        });\r\n    }\r\n\r\n    const postOne = async(methodname, args) => {\r\n        try {\r\n            const response = await call([{\r\n                methodname,\r\n                args,\r\n            }])[0];\r\n            if (response) {\r\n                setTimeout(() => {\r\n                    Autosave.updateSavingState('saved');\r\n                }, 1000);\r\n            }\r\n            return response;\r\n        } catch (error) {\r\n            Autosave.updateSavingState('offline');\r\n            window.console.error('Error in postOne:', error);\r\n            throw error;\r\n        }\r\n    };\r\n\r\n    getUser([{\r\n            methodname: 'core_user_get_users_by_field',\r\n            args: {field: 'id', values: [userid]},\r\n        }])[0].done(response => {\r\n            user = response[0];\r\n        }).fail((ex) => {\r\n            window.console.error('Error fetching user data:', ex);\r\n        });\r\n\r\n    assignSubmit.on('click', async function(e) {\r\n        e.preventDefault();\r\n        if (filename) {\r\n            // eslint-disable-next-line\r\n            syncData().then(() => {\r\n                assignSubmit.off('click').click();\r\n            });\r\n        } else {\r\n            assignSubmit.off('click').click();\r\n        }\r\n        localStorage.removeItem('lastCopyCutContent');\r\n    });\r\n\r\n    quizSubmit.on('click', async function(e) {\r\n        e.preventDefault();\r\n        if (filename) {\r\n            // eslint-disable-next-line\r\n            syncData().then(() => {\r\n                quizSubmit.off('click').click();\r\n            });\r\n        } else {\r\n            quizSubmit.off('click').click();\r\n        }\r\n        localStorage.removeItem('lastCopyCutContent');\r\n    });\r\n\r\n    const getModal = () => {\r\n\r\n        Promise.all([\r\n            getString('tiny_cursive_srcurl', 'tiny_cursive'),\r\n            getString('tiny_cursive_srcurl_des', 'tiny_cursive'),\r\n            getString('tiny_cursive_placeholder', 'tiny_cursive')\r\n        ]).then(function([title, titledes, placeholder]) {\r\n\r\n            return create({\r\n                type: 'SAVE_CANCEL',\r\n                title: `<div><div class=\"tiny-cursive-title-text\">${title}</div>\r\n                <span class=\"tiny-cursive-title-description \">${titledes}</span></div>`,\r\n                body: `<textarea  class=\"form-control inputUrl\" value=\"\" id=\"inputUrl\" placeholder=\"${placeholder}\"></textarea>`,\r\n                removeOnClose: true,\r\n            })\r\n                .done(modal => {\r\n                    modal.getRoot().addClass('tiny-cursive-modal');\r\n                    modal.show();\r\n                    var lastEvent = '';\r\n\r\n                    modal.getRoot().on(save, function() {\r\n\r\n                        var number = document.getElementById(\"inputUrl\").value.trim();\r\n\r\n                        if (number === \"\" || number === null || number === undefined) {\r\n                            editor.execCommand('Undo');\r\n                            // eslint-disable-next-line\r\n                            getString('pastewarning', 'tiny_cursive').then(str => alert(str));\r\n                        } else {\r\n                            editor.execCommand('Paste');\r\n                        }\r\n\r\n                        postOne('cursive_user_comments', {\r\n                            modulename: modulename,\r\n                            cmid: cmid,\r\n                            resourceid: resourceId,\r\n                            courseid: courseid,\r\n                            usercomment: number,\r\n                            timemodified: Date.now(),\r\n                            editorid: editorid ? editorid : \"\"\r\n                        });\r\n\r\n                        lastEvent = 'save';\r\n                        modal.destroy();\r\n                    });\r\n                    modal.getRoot().on(cancel, function() {\r\n                        editor.execCommand('Undo');\r\n                        lastEvent = 'cancel';\r\n                    });\r\n\r\n                    modal.getRoot().on(hidden, function() {\r\n                        if (lastEvent != 'cancel' && lastEvent != 'save') {\r\n                            editor.execCommand('Undo');\r\n                        }\r\n                    });\r\n                    return modal;\r\n                });\r\n        }).catch(error => window.console.error(error));\r\n\r\n    };\r\n\r\n    const sendKeyEvent = (events, editor) => {\r\n        ed = editor;\r\n        event = events;\r\n\r\n        filename = `${userid}_${resourceId}_${cmid}_${modulename}_attempt`;\r\n\r\n        if (modulename === 'quiz') {\r\n            questionid = editorid.split(':')[1].split('_')[0];\r\n            filename = `${userid}_${resourceId}_${cmid}_${questionid}_${modulename}_attempt`;\r\n        }\r\n\r\n        if (localStorage.getItem(filename)) {\r\n            let data = JSON.parse(localStorage.getItem(filename));\r\n            data.push({\r\n                resourceId: resourceId,\r\n                key: editor.key,\r\n                keyCode: editor.keyCode,\r\n                event: event,\r\n                courseId: courseid,\r\n                unixTimestamp: Date.now(),\r\n                clientId: host,\r\n                personId: userid,\r\n                position: ed.caretPosition,\r\n                rePosition: ed.rePosition,\r\n                pastedContent: editor.pastedContent,\r\n                aiContent: editor.aiContent\r\n            });\r\n            localStorage.setItem(filename, JSON.stringify(data));\r\n        } else {\r\n            let data = [{\r\n                resourceId: resourceId,\r\n                key: editor.key,\r\n                keyCode: editor.keyCode,\r\n                event: event,\r\n                courseId: courseid,\r\n                unixTimestamp: Date.now(),\r\n                clientId: host,\r\n                personId: userid,\r\n                position: ed.caretPosition,\r\n                rePosition: ed.rePosition,\r\n                pastedContent: editor.pastedContent,\r\n                aiContent: editor.aiContent\r\n            }];\r\n            localStorage.setItem(filename, JSON.stringify(data));\r\n        }\r\n    };\r\n\r\n    editor.on('keyUp', (editor) => {\r\n        customTooltip();\r\n        let position = getCaretPosition(false);\r\n        editor.caretPosition = position.caretPosition;\r\n        editor.rePosition = position.rePosition;\r\n        sendKeyEvent(\"keyUp\", editor);\r\n    });\r\n    editor.on('Paste', async(e) => {\r\n        customTooltip();\r\n        const pastedContent = (e.clipboardData || e.originalEvent.clipboardData).getData('text');\r\n        if (!pastedContent) {\r\n            return;\r\n        }\r\n        // Trim both values for consistent comparison\r\n        const trimmedPastedContent = pastedContent.trim();\r\n        const lastCopyCutContent = localStorage.getItem('lastCopyCutContent');\r\n        const isFromOwnEditor = lastCopyCutContent && trimmedPastedContent === lastCopyCutContent;\r\n\r\n        if (isStudent && intervention) {\r\n\r\n            if (PASTE_SETTING === 'block') {\r\n                if (!isFromOwnEditor) {\r\n                    e.preventDefault();\r\n                    shouldBlockPaste = true;\r\n                    isPasteAllowed = false;\r\n                    e.stopPropagation();\r\n                    e.stopImmediatePropagation();\r\n                    getString('paste_blocked', 'tiny_cursive').then(str => {\r\n                       return editor.windowManager.alert(str);\r\n                    }).catch(error => window.console.error(error));\r\n                    setTimeout(() => {\r\n                        isPasteAllowed = true;\r\n                        shouldBlockPaste = false;\r\n                    }, 100);\r\n                    return;\r\n                }\r\n                shouldBlockPaste = false;\r\n                isPasteAllowed = true;\r\n                return;\r\n            }\r\n            if (PASTE_SETTING === 'cite_source') {\r\n                if (!isFromOwnEditor) {\r\n                    e.preventDefault();\r\n                    e.stopPropagation();\r\n                    e.stopImmediatePropagation();\r\n                    getModal(e);\r\n                }\r\n                isPasteAllowed = true;\r\n                return;\r\n            }\r\n        }\r\n        isPasteAllowed = true;\r\n    });\r\n    editor.on('Redo', async(e) => {\r\n        customTooltip();\r\n        if (isStudent && intervention) {\r\n            getModal(e);\r\n        }\r\n    });\r\n    editor.on('keyDown', (editor) => {\r\n        customTooltip();\r\n        const isPasteAttempt = (editor.key === 'v' || editor.key === 'V') &&\r\n        (editor.ctrlKey || editor.metaKey);\r\n        if (isPasteAttempt && isStudent && intervention && PASTE_SETTING === 'block' && !isPasteAllowed) {\r\n            setTimeout(() => {\r\n                isPasteAllowed = true;\r\n            }, 100);\r\n            return;\r\n        }\r\n        let position = getCaretPosition();\r\n        editor.caretPosition = position.caretPosition;\r\n        editor.rePosition = position.rePosition;\r\n        sendKeyEvent(\"keyDown\", editor);\r\n    });\r\n    editor.on('Cut', () => {\r\n        const selectedContent = editor.selection.getContent({format: 'text'});\r\n        localStorage.setItem('lastCopyCutContent', selectedContent.trim());\r\n    });\r\n    editor.on('Copy', () => {\r\n        const selectedContent = editor.selection.getContent({format: 'text'});\r\n        localStorage.setItem('lastCopyCutContent', selectedContent.trim());\r\n    });\r\n    editor.on('mouseDown', async(editor) => {\r\n        setTimeout(() => {\r\n            constructMouseEvent(editor);\r\n            sendKeyEvent(\"mouseDown\", editor);\r\n        }, 0);\r\n    });\r\n    editor.on('mouseUp', async(editor) => {\r\n        setTimeout(() => {\r\n            constructMouseEvent(editor);\r\n            sendKeyEvent(\"mouseUp\", editor);\r\n        }, 10);\r\n    });\r\n    editor.on('init', () => {\r\n        customTooltip();\r\n        localStorage.removeItem('lastCopyCutContent');\r\n    });\r\n    editor.on('SetContent', () => {\r\n        customTooltip();\r\n    });\r\n    editor.on('FullscreenStateChanged', (e) => {\r\n        let view = new DocumentView(user, Rubrics, submission, modulename, editor, quizInfo);\r\n        isFullScreen = e.state;\r\n        try {\r\n            if (!e.state) {\r\n                view.normalMode();\r\n            } else {\r\n                view.fullPageMode();\r\n            }\r\n        } catch (error) {\r\n            if (errorAlert) {\r\n                errorAlert = false;\r\n                getString('fullmodeerror', 'tiny_cursive').then(str => {\r\n                    return editor.windowManager.alert(str);\r\n                }).catch(error => window.console.error(error));\r\n            }\r\n            view.normalMode();\r\n            window.console.error('Error ResizeEditor event:', error);\r\n        }\r\n    });\r\n\r\n    editor.on('execcommand', function(e) {\r\n        if (e.command === \"mceInsertContent\") {\r\n            const contentObj = e.value;\r\n\r\n            const isPaste = contentObj && typeof contentObj === 'object' && contentObj.paste === true;\r\n\r\n            let insertedContent = contentObj.content || contentObj;\r\n            let tempDiv = document.createElement('div');\r\n            tempDiv.innerHTML = insertedContent;\r\n            let text = tempDiv.textContent || tempDiv.innerText || '';\r\n            let pastedText = tempDiv.textContent || tempDiv.innerText || '';\r\n\r\n            let position = getCaretPosition(true);\r\n            editor.caretPosition = position.caretPosition;\r\n            editor.rePosition = position.rePosition;\r\n\r\n            if (isPaste) {\r\n                if (shouldBlockPaste) {\r\n                    shouldBlockPaste = false;\r\n                    e.preventDefault();\r\n                    editor.undoManager.undo();\r\n                    return;\r\n                }\r\n                const lastCopyCutContent = localStorage.getItem('lastCopyCutContent');\r\n                const isFromOwnEditor = lastCopyCutContent && pastedText.trim() === lastCopyCutContent;\r\n\r\n                if (isStudent && intervention && PASTE_SETTING === 'block' && !isFromOwnEditor) {\r\n                    isPasteAllowed = false;\r\n                    editor.undoManager.undo();\r\n                    return;\r\n                }\r\n\r\n                sendKeyEvent(\"Paste\", {\r\n                    key: \"v\",\r\n                    keyCode: 86,\r\n                    caretPosition: editor.caretPosition,\r\n                    rePosition: editor.rePosition,\r\n                    pastedContent: pastedText,\r\n                    srcElement: {baseURI: window.location.href}\r\n                });\r\n            } else {\r\n                aiContents.push(text);\r\n\r\n                sendKeyEvent(\"aiInsert\", {\r\n                    key: \"ai\",\r\n                    keyCode: 0,\r\n                    caretPosition: editor.caretPosition,\r\n                    rePosition: editor.rePosition,\r\n                    aiContent: text,\r\n                    srcElement: {baseURI: window.location.href}\r\n                });\r\n            }\r\n        }\r\n    });\r\n\r\n    editor.on('input', function(e) {\r\n        let position = getCaretPosition(true);\r\n        editor.caretPosition = position.caretPosition;\r\n        editor.rePosition = position.rePosition;\r\n        let aiContent = e.data;\r\n\r\n        if (e.inputType === 'insertReplacementText' || (e.inputType === 'insertText' && aiContent && aiContent.length > 1)) {\r\n\r\n            aiContents.push(aiContent);\r\n\r\n            e.key = \"ai\";\r\n            e.keyCode = 0;\r\n            e.caretPosition = position.caretPosition;\r\n            e.rePosition = position.rePosition;\r\n            e.aiContent = aiContent;\r\n\r\n            sendKeyEvent(\"aiInsert\", e);\r\n        }\r\n    });\r\n\r\n\r\n    /**\r\n     * Constructs a mouse event object with caret position and button information\r\n     * @param {Object} editor - The TinyMCE editor instance\r\n     * @function constructMouseEvent\r\n     * @description Sets caret position, reposition, key and keyCode properties on the editor object based on current mouse state\r\n     */\r\n    function constructMouseEvent(editor) {\r\n        let position = getCaretPosition(false);\r\n        editor.caretPosition = position.caretPosition;\r\n        editor.rePosition = position.rePosition;\r\n        editor.key = getMouseButton(editor);\r\n        editor.keyCode = editor.button;\r\n    }\r\n\r\n    /**\r\n     * Gets the string representation of a mouse button based on its numeric value\r\n     * @param {Object} editor - The editor object containing button information\r\n     * @returns {string} The string representation of the mouse button ('left', 'middle', or 'right')\r\n     */\r\n    function getMouseButton(editor) {\r\n\r\n        switch (editor.button) {\r\n            case 0:\r\n                return 'left';\r\n            case 1:\r\n                return 'middle';\r\n            case 2:\r\n                return 'right';\r\n        }\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     * Gets the current caret position in the editor\r\n     * @param {boolean} skip - If true, returns the last known caret position instead of calculating a new one\r\n     * @returns {Object} Object containing:\r\n     *   - caretPosition: Sequential position number stored in session\r\n     *   - rePosition: Absolute character offset from start of content\r\n     * @throws {Error} Logs warning to console if error occurs during calculation\r\n     */\r\n    function getCaretPosition(skip = false) {\r\n        try {\r\n            if (!editor || !editor.selection) {\r\n            return {caretPosition: 0, rePosition: 0};\r\n            }\r\n\r\n            const range = editor.selection.getRng();\r\n            const body = editor.getBody();\r\n\r\n            // Create a range from start of document to current caret\r\n            const preCaretRange = range.cloneRange();\r\n            preCaretRange.selectNodeContents(body);\r\n            preCaretRange.setEnd(range.endContainer, range.endOffset);\r\n\r\n            const fragment = preCaretRange.cloneContents();\r\n            const tempDiv = document.createElement('div');\r\n            tempDiv.appendChild(fragment);\r\n            let textBeforeCursor = tempDiv.innerText || '';\r\n\r\n            const endContainer = range.endContainer;\r\n            const endOffset = range.endOffset;\r\n\r\n            if (endOffset === 0 &&\r\n                endContainer.nodeType === Node.ELEMENT_NODE &&\r\n                editor.dom.isBlock(endContainer) &&\r\n                endContainer.previousSibling) {\r\n                textBeforeCursor += '\\n';\r\n            }\r\n            const blockElements = tempDiv.querySelectorAll('p, div, h1, h2, h3, h4, h5, h6, li');\r\n            let emptyBlockCount = 0;\r\n            blockElements.forEach(block => {\r\n            const text = block.innerText || block.textContent || '';\r\n            if (text.trim() === '' && block.childNodes.length === 1 &&\r\n                block.childNodes[0].nodeName === 'BR') {\r\n                emptyBlockCount++;\r\n            }\r\n            });\r\n\r\n            // Add newlines for empty blocks (these represent Enter presses that created empty lines)\r\n            if (emptyBlockCount > 0) {\r\n            textBeforeCursor += '\\n'.repeat(emptyBlockCount);\r\n            }\r\n\r\n            const absolutePosition = textBeforeCursor.length;\r\n\r\n            if (skip) {\r\n            return {\r\n                caretPosition: lastCaretPos,\r\n                rePosition: absolutePosition\r\n            };\r\n            }\r\n            // Increment sequential caretPosition\r\n            const storageKey = `${userid}_${resourceId}_${cmid}_position`;\r\n            let storedPos = parseInt(sessionStorage.getItem(storageKey), 10);\r\n            if (isNaN(storedPos)) {\r\n            storedPos = 0;\r\n            }\r\n            storedPos++;\r\n            lastCaretPos = storedPos;\r\n            sessionStorage.setItem(storageKey, storedPos);\r\n\r\n            return {\r\n            caretPosition: storedPos,\r\n            rePosition: absolutePosition\r\n            };\r\n\r\n        } catch (e) {\r\n            window.console.warn('Error getting caret position:', e);\r\n            return {caretPosition: lastCaretPos || 1, rePosition: 0};\r\n        }\r\n    }\r\n\r\n\r\n    /**\r\n     * Synchronizes data from localStorage to server\r\n     * @async\r\n     * @function SyncData\r\n     * @description Retrieves stored keypress data from localStorage and sends it to server\r\n     * @returns {Promise} Returns response from server if data exists and is successfully sent\r\n     * @throws {Error} Logs error to console if data submission fails\r\n     */\r\n    async function syncData() {\r\n        checkIsPdfAnnotator();\r\n        let data = localStorage.getItem(filename);\r\n\r\n        if (!data || data.length === 0) {\r\n            return;\r\n        } else {\r\n            localStorage.removeItem(filename);\r\n            editor.fire('change');\r\n            let originalText = editor.getContent({format: 'text'});\r\n            if (!originalText) {\r\n                originalText = getRawText(editor);\r\n            }\r\n            try {\r\n                Autosave.updateSavingState('saving');\r\n                // eslint-disable-next-line\r\n                return await postOne('cursive_write_local_to_json', {\r\n                    key: ed.key,\r\n                    event: event,\r\n                    keyCode: ed.keyCode,\r\n                    resourceId: resourceId,\r\n                    cmid: cmid,\r\n                    modulename: modulename,\r\n                    editorid: editorid,\r\n                    \"json_data\": data,\r\n                    originalText: originalText\r\n                });\r\n            } catch (error) {\r\n                window.console.error('Error submitting data:', error);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Gets the raw text content from a TinyMCE editor iframe\r\n     * @param {Object} editor - The TinyMCE editor instance\r\n     * @returns {string} The raw text content of the editor body, or empty string if not found\r\n     * @description Attempts to get the raw text content from the editor's iframe body by:\r\n     * 1. Getting the editor ID\r\n     * 2. Finding the associated iframe element\r\n     * 3. Accessing the iframe's document body\r\n     * 4. Returning the text content\r\n     * Returns empty string if any step fails\r\n     */\r\n    function getRawText(editor) {\r\n        let editorId = editor?.id;\r\n        if (editorId) {\r\n            let iframe = document.querySelector(`#${editorId}_ifr`);\r\n            let iframeBody = iframe.contentDocument?.body || iframe.contentWindow?.document?.body;\r\n            return iframeBody?.textContent;\r\n        }\r\n        return \"\";\r\n    }\r\n\r\n    /**\r\n     * Sets up custom tooltip functionality for the Cursive icon\r\n     * Initializes tooltip text, positions the icon in the menubar,\r\n     * and sets up mouse event handlers for showing/hiding the tooltip\r\n     * @function customTooltip\r\n     */\r\n    function customTooltip() {\r\n        try {\r\n            const tooltipText = getTooltipText();\r\n            const menubarDiv = document.querySelectorAll('div[role=\"menubar\"].tox-menubar');\r\n            let classArray = [];\r\n\r\n            if (menubarDiv.length) {\r\n                menubarDiv.forEach(function(element, index) {\r\n                    index += 1;\r\n                    let className = 'cursive-menu-' + index;\r\n                    element.classList.add(className);\r\n                    classArray.push(className);\r\n                });\r\n            }\r\n\r\n            const cursiveIcon = document.createElement('img');\r\n            cursiveIcon.src = hasApiKey ? iconUrl : iconGrayUrl;\r\n\r\n            cursiveIcon.setAttribute('class', 'tiny_cursive_StateButton');\r\n            cursiveIcon.style.display = 'inline-block';\r\n\r\n            cursiveState(cursiveIcon, menubarDiv, classArray);\r\n\r\n            for (let index in classArray) {\r\n                const elementId = \"tiny_cursive_StateIcon\" + index;\r\n                const tooltipId = `tiny_cursive_tooltip${index}`;\r\n\r\n                tooltipText.then((text) => {\r\n                    return setTooltip(text, document.querySelector(`#${elementId}`), tooltipId);\r\n                }).catch(error => window.console.error(error));\r\n\r\n                $(`#${elementId}`).on('mouseenter', function() {\r\n                    $(this).css('position', 'relative');\r\n                    $(`#${tooltipId}`).css(tooltipCss);\r\n                });\r\n\r\n                $(`#${elementId}`).on('mouseleave', function() {\r\n                    $(`#${tooltipId}`).css('display', 'none');\r\n                });\r\n            }\r\n        } catch (error) {\r\n            window.console.error('Error setting up custom tooltip:', error);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Retrieves tooltip text strings from language files\r\n     * @async\r\n     * @function getTooltipText\r\n     * @returns {Promise<Object>} Object containing buttonTitle and buttonDes strings\r\n     */\r\n    async function getTooltipText() {\r\n        const [\r\n            buttonTitle,\r\n            buttonDes,\r\n        ] = await Promise.all([\r\n            getString('cursive:state:active', 'tiny_cursive'),\r\n            getString('cursive:state:active:des', 'tiny_cursive'),\r\n        ]);\r\n        return {buttonTitle, buttonDes};\r\n    }\r\n\r\n    /**\r\n     * Updates the Cursive icon state and positions it in the menubar\r\n     * @param {HTMLElement} cursiveIcon - The Cursive icon element to modify\r\n     * @param {HTMLElement} menubarDiv - The menubar div element\r\n     * @param {Array} classArray - Array of class names for the menubar div elements\r\n     */\r\n    function cursiveState(cursiveIcon, menubarDiv, classArray) {\r\n        if (!menubarDiv) {\r\n            return;\r\n        }\r\n\r\n        for (let index in classArray) {\r\n            const rightWrapper = document.createElement('div');\r\n            const imgWrapper = document.createElement('span');\r\n            const iconClone = cursiveIcon.cloneNode(true);\r\n            const targetMenu = document.querySelector('.' + classArray[index]);\r\n            let elementId = \"tiny_cursive_StateIcon\" + index;\r\n\r\n            rightWrapper.style.cssText = `\r\n                        margin-left: auto;\r\n                        display: flex;\r\n                        align-items: center;\r\n                    `;\r\n\r\n            imgWrapper.id = elementId;\r\n            imgWrapper.style.marginLeft = '.2rem';\r\n            imgWrapper.appendChild(iconClone);\r\n            rightWrapper.appendChild(imgWrapper);\r\n\r\n            let moduleIds = {\r\n                resourceId: resourceId,\r\n                cmid: cmid,\r\n                modulename: modulename,\r\n                questionid: questionid,\r\n                userid: userid,\r\n                courseid: courseid};\r\n            // Document mode, other modules single editor instances\r\n            if (isFullScreen && (modulename === 'assign' || modulename === 'forum'\r\n                || modulename === 'lesson')) {\r\n                let existsElement = document.querySelector('.tox-menubar[class*=\"cursive-menu-\"] > div');\r\n                if (existsElement) {\r\n                    existsElement.remove();\r\n                }\r\n\r\n                if (!document.querySelector(`#${elementId}`)) {\r\n                    rightWrapper.style.marginTop = '3px';\r\n                    document.querySelector('#tiny_cursive-fullpage-right-wrapper').prepend(rightWrapper);\r\n                }\r\n\r\n                Autosave.destroyInstance();\r\n                Autosave.getInstance(editor, rightWrapper, moduleIds, isFullScreen);\r\n            } else if (isFullScreen && modulename === 'quiz') { // Document mode, quiz multiple editor instances\r\n                let existingElement = editor.container?.childNodes[1]?.childNodes[0]?.childNodes[0]?.childNodes[7];\r\n                let newHeader = editor.container?.childNodes[0];\r\n                if (existingElement) {\r\n                    existingElement.remove();\r\n                }\r\n\r\n                if (newHeader && !newHeader.querySelector(`span[id*=tiny_cursive_StateIcon]`)) {\r\n                    rightWrapper.style.marginTop = '3px';\r\n                    document.querySelector('#tiny_cursive-fullpage-right-wrapper').prepend(rightWrapper);\r\n                }\r\n                Autosave.destroyInstance();\r\n                Autosave.getInstance(editor, rightWrapper, moduleIds, isFullScreen);\r\n            } else { // Regular view\r\n                let menubar = editor?.container?.children[0]?.childNodes[0]?.childNodes[0];\r\n\r\n                if (targetMenu && !targetMenu.querySelector(`#${elementId}`)) {\r\n                    targetMenu.appendChild(rightWrapper);\r\n                }\r\n                // Regular view, multiple editor instances\r\n                if (modulename === 'quiz' && menubar) {\r\n                    let wrapper = menubar.querySelector('span[id*=\"tiny_cursive_StateIcon\"]');\r\n\r\n                    if (wrapper) {\r\n                        Autosave.destroyInstance();\r\n                        Autosave.getInstance(editor, wrapper?.parentElement, moduleIds, isFullScreen);\r\n                    }\r\n                } else {\r\n                    Autosave.destroyInstance();\r\n                    Autosave.getInstance(editor, rightWrapper, moduleIds, isFullScreen);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets up tooltip content and styling for the Cursive icon\r\n     * @param {Object} text - Object containing tooltip text strings\r\n     * @param {string} text.buttonTitle - Title text for the tooltip\r\n     * @param {string} text.buttonDes - Description text for the tooltip\r\n     * @param {HTMLElement} cursiveIcon - The Cursive icon element to attach tooltip to\r\n     * @param {string} tooltipId - ID for the tooltip element\r\n     */\r\n    function setTooltip(text, cursiveIcon, tooltipId) {\r\n\r\n        if (document.querySelector(`#${tooltipId}`)) {\r\n            return;\r\n        }\r\n        if (cursiveIcon) {\r\n\r\n            const tooltipSpan = document.createElement('span');\r\n            const description = document.createElement('span');\r\n            const linebreak = document.createElement('br');\r\n            const tooltipTitle = document.createElement('strong');\r\n\r\n            tooltipSpan.style.display = 'none';\r\n            tooltipTitle.textContent = text.buttonTitle;\r\n            tooltipTitle.style.fontSize = '16px';\r\n            tooltipTitle.style.fontWeight = 'bold';\r\n            description.textContent = text.buttonDes;\r\n            description.style.fontSize = '14px';\r\n\r\n            tooltipSpan.id = tooltipId;\r\n            tooltipSpan.classList.add(`shadow`);\r\n            tooltipSpan.appendChild(tooltipTitle);\r\n            tooltipSpan.appendChild(linebreak);\r\n            tooltipSpan.appendChild(description);\r\n            cursiveIcon.appendChild(tooltipSpan);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Extracts module information from URL parameters\r\n     * @param {string} ur - The base URL to analyze\r\n     * @param {URL} parm - URL object containing search parameters\r\n     * @param {Array} MODULES - Array of valid module names to check against\r\n     * @returns {Object|boolean} Object containing resourceId and module name if found, false if no valid module\r\n     */\r\n    function getModulesInfo(ur, parm, MODULES) {\r\n        fetchStrings();\r\n\r\n        if (!MODULES.some(module => ur.includes(module))) {\r\n            return false;\r\n        }\r\n\r\n        if (ur.includes(\"forum\") && !ur.includes(\"assign\")) {\r\n            resourceId = parm.searchParams.get('edit');\r\n        } else {\r\n            resourceId = parm.searchParams.get('attempt');\r\n        }\r\n\r\n        if (resourceId === null) {\r\n            resourceId = 0;\r\n        }\r\n\r\n        for (const module of MODULES) {\r\n            if (ur.includes(module)) {\r\n                modulename = module;\r\n                if (module === \"lesson\" || module === \"assign\") {\r\n                    resourceId = cmid;\r\n                } else if (module === \"oublog\") {\r\n                    resourceId = 0;\r\n                }\r\n                break;\r\n            }\r\n        }\r\n\r\n        checkIsPdfAnnotator();\r\n\r\n        return {resourceId: resourceId, name: modulename};\r\n    }\r\n\r\n    /**\r\n     * Fetches and caches localized strings used in the UI\r\n     * @function fetchStrings\r\n     * @description Retrieves strings for sidebar titles and document sidebar elements if not already cached in localStorage\r\n     * Uses Promise.all to fetch multiple strings in parallel for better performance\r\n     * Stores the fetched strings in localStorage under 'sbTitle' and 'docSideBar' keys\r\n     */\r\n    function fetchStrings() {\r\n        if (!localStorage.getItem('sbTitle')) {\r\n            Promise.all([\r\n                getString('assignment', 'tiny_cursive'),\r\n                getString('discussion', 'tiny_cursive'),\r\n                getString('pluginname', 'mod_quiz'),\r\n                getString('pluginname', 'mod_lesson'),\r\n                getString('description', 'tiny_cursive'),\r\n            ]).then(function(strings) {\r\n                return localStorage.setItem('sbTitle', JSON.stringify(strings));\r\n            }).catch(error => window.console.error(error));\r\n        }\r\n        if (!localStorage.getItem('docSideBar')) {\r\n            Promise.all([\r\n                getString('details', 'tiny_cursive'),\r\n                getString('student_info', 'tiny_cursive'),\r\n                getString('progress', 'tiny_cursive'),\r\n                getString('description', 'tiny_cursive'),\r\n                getString('replyingto', 'tiny_cursive'),\r\n                getString('answeringto', 'tiny_cursive'),\r\n                getString('importantdates', 'tiny_cursive'),\r\n                getString('rubrics', 'tiny_cursive'),\r\n                getString('submission_status', 'tiny_cursive'),\r\n                getString('status', 'tiny_cursive'),\r\n                getString('draft', 'tiny_cursive'),\r\n                getString('draftnot', 'tiny_cursive'),\r\n                getString('last_modified', 'tiny_cursive'),\r\n                getString('gradings', 'tiny_cursive'),\r\n                getString('gradenot', 'tiny_cursive'),\r\n                getString('word_count', 'tiny_cursive'),\r\n                getString('timeleft', 'tiny_cursive'),\r\n                getString('nolimit', 'tiny_cursive'),\r\n                getString('name', 'tiny_cursive'),\r\n                getString('userename', 'tiny_cursive'),\r\n                getString('course', 'tiny_cursive'),\r\n                getString('opened', 'tiny_cursive'),\r\n                getString('due', 'tiny_cursive'),\r\n                getString('overdue', 'tiny_cursive'),\r\n                getString('remaining', 'tiny_cursive'),\r\n                getString('savechanges', 'tiny_cursive'),\r\n                getString('subjectnot', 'tiny_cursive'),\r\n                getString('remaining', 'tiny_cursive'),\r\n            ]).then(function(strings) {\r\n                return localStorage.setItem('docSideBar', JSON.stringify(strings));\r\n            }).catch(error => window.console.error(error));\r\n        }\r\n\r\n    }\r\n\r\n    /**\r\n     * Checks if the current page is a PDF annotator and updates the resourceId accordingly\r\n     * @function checkIsPdfAnnotator\r\n     * @description Checks if URL contains 'pdfannotator' and sets resourceId based on editor ID and editing state:\r\n     * - If editing an existing annotation (editor.id !== 'id_pdfannotator_content' and isEditing is true):\r\n     *   Sets resourceId to the annotation ID extracted from editor.id\r\n     * - Otherwise: Sets resourceId to 0\r\n     */\r\n    function checkIsPdfAnnotator() {\r\n        if (ur.includes('pdfannotator')) {\r\n            if (editor.id !== 'id_pdfannotator_content' && parseInt(localStorage.getItem('isEditing'))) {\r\n                resourceId = parseInt(editor?.id.replace('editarea', ''));\r\n            } else {\r\n                resourceId = 0;\r\n            }\r\n        }\r\n    }\r\n\r\n    window.addEventListener('unload', () => {\r\n        syncData();\r\n    });\r\n\r\n    setInterval(syncData, syncInterval);\r\n};\r\n"],"names":["editor","interval","userId","hasApiKey","MODULES","Rubrics","submission","quizInfo","pasteSetting","isStudent","hasClass","intervention","host","M","cfg","wwwroot","userid","courseid","courseId","editorid","id","cmid","contextInstanceId","ed","event","filename","questionid","quizSubmit","assignSubmit","syncInterval","lastCaretPos","aiContents","isFullScreen","user","ur","window","location","href","parm","URL","modulesInfo","localStorage","getItem","Promise","all","then","strings","setItem","JSON","stringify","catch","error","console","fetchStrings","some","module","includes","resourceId","searchParams","get","modulename","checkIsPdfAnnotator","name","getModulesInfo","errorAlert","PASTE_SETTING","shouldBlockPaste","isPasteAllowed","document","addEventListener","e","target","className","replace","syncData","postOne","async","methodname","args","response","setTimeout","updateSavingState","field","values","done","fail","ex","on","preventDefault","off","click","removeItem","getModal","title","titledes","placeholder","type","body","removeOnClose","modal","getRoot","addClass","show","lastEvent","save","number","getElementById","value","trim","execCommand","str","alert","resourceid","usercomment","timemodified","Date","now","destroy","cancel","hidden","sendKeyEvent","events","split","data","parse","push","key","keyCode","unixTimestamp","clientId","personId","position","caretPosition","rePosition","pastedContent","aiContent","constructMouseEvent","getCaretPosition","button","getMouseButton","skip","selection","range","getRng","getBody","preCaretRange","cloneRange","selectNodeContents","setEnd","endContainer","endOffset","fragment","cloneContents","tempDiv","createElement","appendChild","textBeforeCursor","innerText","nodeType","Node","ELEMENT_NODE","dom","isBlock","previousSibling","blockElements","querySelectorAll","emptyBlockCount","forEach","block","textContent","childNodes","length","nodeName","repeat","absolutePosition","storageKey","storedPos","parseInt","sessionStorage","isNaN","warn","fire","originalText","getContent","format","editorId","iframe","querySelector","iframeBody","contentDocument","contentWindow","_iframe$contentWindow","_iframe$contentWindow2","getRawText","customTooltip","tooltipText","buttonTitle","buttonDes","getTooltipText","menubarDiv","classArray","element","index","classList","add","cursiveIcon","src","iconUrl","iconGrayUrl","setAttribute","style","display","rightWrapper","imgWrapper","iconClone","cloneNode","targetMenu","elementId","cssText","marginLeft","moduleIds","existingElement","container","_editor$container","_editor$container$chi","_editor$container$chi2","_editor$container$chi3","newHeader","_editor$container2","remove","marginTop","prepend","destroyInstance","getInstance","menubar","_editor$container3","children","_editor$container3$ch","_editor$container3$ch2","wrapper","parentElement","existsElement","cursiveState","tooltipId","text","setTooltip","this","css","tooltipCss","tooltipSpan","description","linebreak","tooltipTitle","fontSize","fontWeight","clipboardData","originalEvent","getData","trimmedPastedContent","lastCopyCutContent","isFromOwnEditor","stopPropagation","stopImmediatePropagation","windowManager","ctrlKey","metaKey","selectedContent","view","DocumentView","state","fullPageMode","normalMode","command","contentObj","isPaste","paste","insertedContent","content","innerHTML","pastedText","undoManager","undo","srcElement","baseURI","inputType","setInterval"],"mappings":"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"}