{"version":3,"file":"autosaver.min.js","sources":["../src/autosaver.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module     tiny_cursive/autosaver\n * @category   TinyMCE Editor\n * @copyright  CTI <info@cursivetechnology.com>\n * @author     Brain Station 23 <sales@brainstation-23.com>\n */\n\nimport {call} from 'core/ajax';\nimport {create} from 'core/modal_factory';\nimport {get_string as getString} from 'core/str';\nimport {save, cancel, hidden} from 'core/modal_events';\nimport $ from 'jquery';\nimport {iconSaving, iconSaved, iconOffline, iconUrl, iconGrayUrl, tooltipCss} from 'tiny_cursive/common';\nimport templates from 'core/templates';\n\n\nexport const register = (editor, interval, userId, hasApiKey, MODULES) => {\n\n    var isStudent = !($('#body').hasClass('teacher_admin'));\n    var intervention = $('#body').hasClass('intervention');\n    var host = M.cfg.wwwroot;\n    var userid = userId;\n    var courseid = M.cfg.courseId;\n    var editorid = editor?.id;\n    var cmid = M.cfg.contextInstanceId;\n    var ed = \"\";\n    var event = \"\";\n    var filename = \"\";\n    var modulename = \"\";\n    var questionid = 0;\n    var resourceId = 0;\n    var quizSubmit = $('#mod_quiz-next-nav');\n    let assignSubmit = $('#id_submitbutton');\n    var syncInterval = interval ? interval * 1000 : 10000; // Default: Sync Every 10s.\n    var lastCaretPos = 1;\n    let pastedContents = [];\n    var savingState = ''; // possible values: 'saving', 'saved', 'offline'\n\n    const postOne = async(methodname, args) => {\n        try {\n            const response = await call([{\n                methodname,\n                args,\n            }])[0];\n            if(response) {\n                setTimeout(() => {\n                    updateSavingState('saved');\n                }, 1000);\n            }\n            return response;\n        } catch (error) {\n            updateSavingState('offline');\n            window.console.error('Error in postOne:', error);\n            throw error;\n        }\n    };\n\n    assignSubmit.on('click', async function(e) {\n        e.preventDefault();\n        if (filename) {\n            // eslint-disable-next-line\n            syncData().then(() => {\n                assignSubmit.off('click').click();\n            });\n        } else {\n            assignSubmit.off('click').click();\n        }\n        localStorage.removeItem('lastCopyCutContent');\n    });\n\n    quizSubmit.on('click', async function(e) {\n        e.preventDefault();\n        if (filename) {\n            // eslint-disable-next-line\n            syncData().then(() => {\n                quizSubmit.off('click').click();\n            });\n        } else {\n            quizSubmit.off('click').click();\n        }\n        localStorage.removeItem('lastCopyCutContent');\n    });\n\n    const getModal = (e) => {\n\n        Promise.all([\n            getString('tiny_cursive_srcurl', 'tiny_cursive'),\n            getString('tiny_cursive_srcurl_des', 'tiny_cursive'),\n            getString('tiny_cursive_placeholder', 'tiny_cursive')\n        ]).then(function([title, titledes, placeholder]) {\n\n            return create({\n                type: 'SAVE_CANCEL',\n                title: `<div><div class=\"tiny-cursive-title-text\">${title}</div>\n                <span class=\"tiny-cursive-title-description \">${titledes}</span></div>`,\n                body: `<textarea  class=\"form-control inputUrl\" value=\"\" id=\"inputUrl\" placeholder=\"${placeholder}\"></textarea>`,\n                removeOnClose: true,\n            })\n                .done(modal => {\n                    modal.getRoot().addClass('tiny-cursive-modal');\n                    modal.show();\n                    var lastEvent = '';\n\n                    modal.getRoot().on(save, function() {\n\n                        var number = document.getElementById(\"inputUrl\").value.trim();\n                        let ur = e.srcElement.baseURI;\n                        let parm = new URL(ur);\n                        let modulesInfo = getModulesInfo(ur, parm, MODULES);\n\n                        resourceId = modulesInfo.resourceId;\n                        modulename = modulesInfo.name;\n\n                        if (number === \"\" || number === null || number === undefined) {\n                            editor.execCommand('Undo');\n                            // eslint-disable-next-line\n                            getString('pastewarning', 'tiny_cursive').then(str => alert(str));\n                        } else {\n                            editor.execCommand('Paste');\n                        }\n\n                        postOne('cursive_user_comments', {\n                            modulename: modulename,\n                            cmid: cmid,\n                            resourceid: resourceId,\n                            courseid: courseid,\n                            usercomment: number,\n                            timemodified: Date.now(),\n                            editorid: editorid ? editorid : \"\"\n                        });\n\n                        lastEvent = 'save';\n                        modal.destroy();\n                    });\n                    modal.getRoot().on(cancel, function() {\n                        editor.execCommand('Undo');\n                        lastEvent = 'cancel';\n                    });\n\n                    modal.getRoot().on(hidden, function() {\n                        if (lastEvent != 'cancel' && lastEvent != 'save') {\n                            editor.execCommand('Undo');\n                        }\n                    });\n                    return modal;\n                });\n        }).catch(error => window.console.error(error));\n\n    };\n\n    const sendKeyEvent = (events, editor) => {\n        ed = editor;\n        event = events;\n        let ur = editor.srcElement.baseURI;\n        let parm = new URL(ur);\n        let modulesInfo = getModulesInfo(ur, parm, MODULES);\n\n        resourceId = modulesInfo.resourceId;\n        modulename = modulesInfo.name;\n\n        filename = `${userid}_${resourceId}_${cmid}_${modulename}_attempt`;\n\n        if (modulename === 'quiz') {\n            questionid = editorid.split(':')[1].split('_')[0];\n            filename = `${userid}_${resourceId}_${cmid}_${questionid}_${modulename}_attempt`;\n        }\n\n        if (localStorage.getItem(filename)) {\n            let data = JSON.parse(localStorage.getItem(filename));\n            data.push({\n                resourceId: resourceId,\n                key: editor.key,\n                keyCode: editor.keyCode,\n                event: event,\n                courseId: courseid,\n                unixTimestamp: Date.now(),\n                clientId: host,\n                personId: userid,\n                position: ed.caretPosition,\n                rePosition: ed.rePosition,\n                pastedContent: pastedContents\n            });\n            localStorage.setItem(filename, JSON.stringify(data));\n        } else {\n            let data = [{\n                resourceId: resourceId,\n                key: editor.key,\n                keyCode: editor.keyCode,\n                event: event,\n                courseId: courseid,\n                unixTimestamp: Date.now(),\n                clientId: host,\n                personId: userid,\n                position: ed.caretPosition,\n                rePosition: ed.rePosition,\n                pastedContent: pastedContents\n            }];\n            localStorage.setItem(filename, JSON.stringify(data));\n        }\n    };\n\n    editor.on('keyUp', (editor) => {\n        customTooltip();\n        let position = getCaretPosition(true);\n        editor.caretPosition = position.caretPosition;\n        editor.rePosition = position.rePosition;\n        sendKeyEvent(\"keyUp\", editor);\n    });\n    editor.on('Paste', async(e) => {\n        customTooltip();\n        const pastedContent = (e.clipboardData || e.originalEvent.clipboardData).getData('text');\n        if (!pastedContent) {\n            return;\n        }\n        if (isStudent && intervention) {\n            if (pastedContent !== localStorage.getItem('lastCopyCutContent')) {\n                getModal(e);\n                pastedContents = [];\n                pastedContents.push(pastedContent);\n                let position = getCaretPosition(true);\n                editor.caretPosition = position.caretPosition;\n                editor.rePosition = position.rePosition;\n                sendKeyEvent(\"Paste\", {\n                ...e,\n                        key: \"v\",\n                        keyCode: 86,\n                        caretPosition: editor.caretPosition,\n                        rePosition: editor.rePosition\n                    });\n            }\n        }\n    });\n    editor.on('Redo', async(e) => {\n        customTooltip();\n        if (isStudent && intervention) {\n            getModal(e);\n        }\n    });\n    editor.on('keyDown', (editor) => {\n        customTooltip();\n        let position = getCaretPosition();\n        editor.caretPosition = position.caretPosition;\n        editor.rePosition = position.rePosition;\n        sendKeyEvent(\"keyDown\", editor);\n    });\n     editor.on('Cut', () => {\n        const selectedContent = editor.selection.getContent({format: 'text'});\n        localStorage.setItem('lastCopyCutContent', selectedContent.trim());\n    });\n    editor.on('Copy', () => {\n        const selectedContent = editor.selection.getContent({format: 'text'});\n        localStorage.setItem('lastCopyCutContent', selectedContent.trim());\n    });\n    editor.on('mouseDown', async(editor) => {\n        constructMouseEvent(editor);\n        sendKeyEvent(\"mouseDown\", editor);\n    });\n    editor.on('mouseUp', async(editor) => {\n        constructMouseEvent(editor);\n        sendKeyEvent(\"mouseUp\", editor);\n    });\n    editor.on('init', () => {\n        customTooltip();\n    });\n    editor.on('SetContent', () => {\n        customTooltip();\n    });\n    /**\n     * Constructs a mouse event object with caret position and button information\n     * @param {Object} editor - The TinyMCE editor instance\n     * @function constructMouseEvent\n     * @description Sets caret position, reposition, key and keyCode properties on the editor object based on current mouse state\n     */\n    function constructMouseEvent(editor) {\n        let position = getCaretPosition();\n        editor.caretPosition = position.caretPosition;\n        editor.rePosition = position.rePosition;\n        editor.key = getMouseButton(editor);\n        editor.keyCode = editor.button;\n    }\n\n    /**\n     * Gets the string representation of a mouse button based on its numeric value\n     * @param {Object} editor - The editor object containing button information\n     * @returns {string} The string representation of the mouse button ('left', 'middle', or 'right')\n     */\n    function getMouseButton(editor) {\n\n        switch (editor.button) {\n            case 0:\n                return 'left';\n            case 1:\n                return 'middle';\n            case 2:\n                return 'right';\n        }\n        return null;\n    }\n\n    /**\n     * Gets the current caret position in the editor\n     * @param {boolean} skip - If true, returns the last known caret position instead of calculating a new one\n     * @returns {Object} Object containing:\n     *   - caretPosition: Sequential position number stored in session\n     *   - rePosition: Absolute character offset from start of content\n     * @throws {Error} Logs warning to console if error occurs during calculation\n     */\n    function getCaretPosition(skip = false) {\n        try {\n            if (!editor || !editor.selection) {\n                return {caretPosition: 0, rePosition: 0};\n            }\n            const rng = editor.selection.getRng();\n\n            let absolutePosition = 0;\n            let node = rng.startContainer;\n\n            absolutePosition = rng.startOffset;\n\n            // Calculate position by walking through previous nodes\n            while (node && node !== editor.getBody()) {\n                while (node.previousSibling) {\n                    node = node.previousSibling;\n                    if (node.textContent) {\n                        absolutePosition += node.textContent.length;\n                    }\n                }\n                node = node.parentNode;\n            }\n\n            if (skip) {\n                return {\n                    caretPosition: lastCaretPos,\n                    rePosition: absolutePosition\n                };\n            }\n\n            const storageKey = `${userid}_${resourceId}_${cmid}_position`;\n            let storedPos = parseInt(sessionStorage.getItem(storageKey), 10);\n            if (isNaN(storedPos)) {\n                storedPos = 0;\n            }\n            storedPos++;\n            lastCaretPos = storedPos;\n            sessionStorage.setItem(storageKey, storedPos);\n\n            return {\n                caretPosition: storedPos,\n                rePosition: absolutePosition\n            };\n        } catch (e) {\n            window.console.warn('Error getting caret position:', e);\n            return {caretPosition: 0, rePosition: 0};\n        }\n    }\n\n\n    /**\n     * Synchronizes data from localStorage to server\n     * @async\n     * @function SyncData\n     * @description Retrieves stored keypress data from localStorage and sends it to server\n     * @returns {Promise} Returns response from server if data exists and is successfully sent\n     * @throws {Error} Logs error to console if data submission fails\n     */\n    async function syncData() {\n\n        let data = localStorage.getItem(filename);\n\n        if (!data || data.length === 0) {\n            return;\n        } else {\n            localStorage.removeItem(filename);\n            let originalText = editor.getContent({format: 'text'});\n            try {\n                updateSavingState('saving');\n                // eslint-disable-next-line\n                return await postOne('cursive_write_local_to_json', {\n                    key: ed.key,\n                    event: event,\n                    keyCode: ed.keyCode,\n                    resourceId: resourceId,\n                    cmid: cmid,\n                    modulename: modulename,\n                    editorid: editorid,\n                    \"json_data\": data,\n                    originalText: originalText\n                });\n            } catch (error) {\n                window.console.error('Error submitting data:', error);\n            }\n        }\n    }\n    /**\n     * Sets up custom tooltip functionality for the Cursive icon\n     * Initializes tooltip text, positions the icon in the menubar,\n     * and sets up mouse event handlers for showing/hiding the tooltip\n     * @function customTooltip\n     */\n    function customTooltip() {\n        try {\n            const tooltipText = getTooltipText();\n            const menubarDiv = document.querySelectorAll('div[role=\"menubar\"].tox-menubar');\n            let classArray = [];\n\n            if (menubarDiv.length) {\n                menubarDiv.forEach(function(element, index) {\n                    index += 1;\n                    let className = 'cursive-menu-' + index;\n                    element.classList.add(className);\n                    classArray.push(className);\n                });\n            }\n\n            const cursiveIcon = document.createElement('img');\n            cursiveIcon.src = hasApiKey ? iconUrl : iconGrayUrl;\n\n            cursiveIcon.setAttribute('class', 'tiny_cursive_StateButton');\n            cursiveIcon.style.display = 'inline-block';\n\n            cursiveState(cursiveIcon, menubarDiv, classArray);\n\n            for (let index in classArray) {\n                const elementId = \"tiny_cursive_StateIcon\" + index;\n                const tooltipId = `tiny_cursive_tooltip${index}`;\n\n                tooltipText.then((text) => {\n                    return setTooltip(text, document.querySelector(`#${elementId}`), tooltipId);\n                }).catch(error => window.console.error(error));\n\n                $(`#${elementId}`).on('mouseenter', function() {\n                    $(this).css('position', 'relative');\n                    $(`#${tooltipId}`).css(tooltipCss);\n                });\n\n                $(`#${elementId}`).on('mouseleave', function() {\n                    $(`#${tooltipId}`).css('display', 'none');\n                });\n            }\n        } catch (error) {\n            window.console.error('Error setting up custom tooltip:', error);\n        }\n    }\n\n    /**\n     * Retrieves tooltip text strings from language files\n     * @async\n     * @function getTooltipText\n     * @returns {Promise<Object>} Object containing buttonTitle and buttonDes strings\n     */\n    async function getTooltipText() {\n        const [\n            buttonTitle,\n            buttonDes,\n        ] = await Promise.all([\n            getString('cursive:state:active', 'tiny_cursive'),\n            getString('cursive:state:active:des', 'tiny_cursive'),\n        ]);\n        return {buttonTitle, buttonDes};\n    }\n\n    /**\n     * Updates the Cursive icon state and positions it in the menubar\n     * @param {HTMLElement} cursiveIcon - The Cursive icon element to modify\n     * @param {HTMLElement} menubarDiv - The menubar div element\n     * @param {Array} classArray - Array of class names for the menubar div elements\n     */\n    function cursiveState(cursiveIcon, menubarDiv, classArray) {\n        if (menubarDiv) {\n            for (let index in classArray) {\n                const rightWrapper = document.createElement('div');\n                const imgWrapper = document.createElement('span');\n                const iconClone = cursiveIcon.cloneNode(true);\n                const targetMenu = document.querySelector('.' + classArray[index]);\n                let elementId = \"tiny_cursive_StateIcon\" + index;\n\n                rightWrapper.style.marginLeft = 'auto';\n                rightWrapper.style.display = 'flex';\n                rightWrapper.style.alignItems = 'center';\n                imgWrapper.id = elementId;\n\n                imgWrapper.appendChild(iconClone);\n\n                 if (!targetMenu?.querySelector('.tiny_cursive_savingState')) {\n                    const stateWrapper = SavingState(savingState);\n                    stateWrapper.classList.add('tiny_cursive_savingState', 'btn');\n                    stateWrapper.id = 'tiny_cursive_savingState';\n                    rightWrapper.appendChild(stateWrapper);\n                    stateWrapper.addEventListener('click', fetchSavedContent);\n                }\n                rightWrapper.appendChild(imgWrapper);\n\n                if (targetMenu && !targetMenu.querySelector(`#${elementId}`)) {\n                    targetMenu.appendChild(rightWrapper);\n                }\n            }\n        }\n    }\n\n    /**\n     * Creates a wrapper div containing an icon and text to display the saving state\n     * @param {string} state - The current saving state ('saving', 'saved', or 'offline')\n     * @returns {HTMLElement} A div element containing the state icon and text\n     * @function SavingState\n     * @description Creates and returns a div element with an icon and text span to show the current saving state.\n     * The icon and text are updated based on the provided state parameter.\n     */\n    function SavingState(state) {\n        let wrapperDiv = document.createElement('div');\n        let icon = document.createElement('img');\n        let textSpan = document.createElement('span');\n        let button = document.createElement('button');\n\n        if(state) {\n            textSpan.textContent = getStateText(state);\n            icon.src = getStateIcon(state);\n        }\n        icon.style.width = '28px';\n        icon.style.height = '28px';\n        icon.style.marginRight = '5px';\n        icon.style.display = 'none';\n        wrapperDiv.style.marginRight = '0.5rem';\n        wrapperDiv.style.verticalAlign = 'middle';\n\n        wrapperDiv.appendChild(icon);\n        wrapperDiv.appendChild(textSpan);\n        button.appendChild(wrapperDiv);\n\n        return button;\n    }\n\n    /**\n     * Updates the saving state icon and text in the editor\n     * @param {string} state - The state to update to ('saving', 'saved', or 'offline')\n     * @function updateSavingState\n     * @description Updates the global saving state and modifies the UI elements to reflect the new state\n     */\n    function updateSavingState(state) {\n        savingState = state; // update global\n        let stateWrapper = document.querySelector('.tiny_cursive_savingState');\n\n        if (!stateWrapper) {\n            return;\n        }\n\n        let img = stateWrapper.querySelector('img');\n        let span = stateWrapper.querySelector('span');\n\n        img.style.display = 'inline';\n        span.textContent = getStateText(state);\n        img.src = getStateIcon(state);\n    }\n\n    /**\n     * Gets the display text for a given saving state\n     * @param {string} state - The state to get text for ('saving', 'saved', or 'offline')\n     * @returns {string} The text to display for the given state\n     * @function getStateText\n     * @description Returns appropriate text label based on the current saving state\n     */\n    function getStateText(state) {\n        switch (state) {\n            case 'saving': return 'Saving';\n            case 'saved': return 'Saved';\n            case 'offline': return 'Offline';\n            default: return '';\n        }\n    }\n\n    /**\n     * Gets the icon URL for a given saving state\n     * @param {string} state - The state to get icon for ('saving', 'saved', or 'offline')\n     * @returns {string} The URL of the icon image for the given state\n     * @function getStateIcon\n     * @description Returns appropriate icon URL based on the current saving state\n     */\n    function getStateIcon(state) {\n        switch (state) {\n            case 'saving': return iconSaving;\n            case 'saved': return iconSaved;\n            case 'offline': return iconOffline;\n            default: return '';\n        }\n    }\n\n    async function fetchSavedContent(e) {\n        e.preventDefault();\n\n        const editorWrapper = document.querySelector('#tiny_cursive_savingState');\n\n        call([{\n                methodname: \"cursive_get_autosave_content\",\n                args: {id: cmid, cmid: cmid, modulename: `${modulename}_autosave`, questionid: questionid, userid: userid}\n            }])[0].done((data) => {\n                let context = {comments: JSON.parse(data)};\n\n                templates.render('tiny_cursive/saved_content', context).then((html) => {\n                editorWrapper.style.position = 'relative';\n\n                const tempDiv = document.createElement('div');\n                tempDiv.innerHTML = html.trim();\n                tempDiv.id = 'savedDropdown';\n                tempDiv.classList.add('saved-dropdown');\n\n                if (!tempDiv) {\n                    console.error(\"Saved content template rendered empty or invalid HTML.\");\n                    return;\n                }\n\n                // Add to DOM if not already added\n                let existingPanel = document.querySelector('#savedDropdown');\n\n                if (!existingPanel) {\n                    editorWrapper.appendChild(tempDiv);\n                    existingPanel = tempDiv;\n                }\n\n                // Toggle visibility\n                existingPanel.classList.toggle('active');\n                toggleSavedDropdown();\n\n            }).catch(error => window.console.error(error));\n        }).fail(() => {});\n    }\n\n    function toggleSavedDropdown() {\n        const dropdown = document.querySelector('#savedDropdown');\n        const isVisible = dropdown.classList.contains('show');\n\n        if (isVisible) {\n            closeSavedDropdown();\n        } else {\n            openSavedDropdown();\n        }\n    }\n\n    function openSavedDropdown() {\n        const dropdown = document.querySelector('#savedDropdown');\n\n        // populateSavedItems();\n        dropdown.classList.add('show');\n\n        // Add event listener to close on Escape key\n        document.addEventListener('keydown', handleEscapeKey);\n    }\n\n    function closeSavedDropdown() {\n        const dropdown = document.querySelector('#savedDropdown');\n        dropdown.classList.remove('show');\n        dropdown.remove();\n\n        // Remove event listener\n        document.removeEventListener('keydown', handleEscapeKey);\n    }\n\n    function handleEscapeKey(event) {\n        if (event.key === 'Escape') {\n            closeSavedDropdown();\n        }\n    }\n\n    /**\n     * Sets up tooltip content and styling for the Cursive icon\n     * @param {Object} text - Object containing tooltip text strings\n     * @param {string} text.buttonTitle - Title text for the tooltip\n     * @param {string} text.buttonDes - Description text for the tooltip\n     * @param {HTMLElement} cursiveIcon - The Cursive icon element to attach tooltip to\n     * @param {string} tooltipId - ID for the tooltip element\n     */\n    function setTooltip(text, cursiveIcon, tooltipId) {\n        if (document.querySelector(`#${tooltipId}`)) {\n            return;\n        }\n        if (cursiveIcon) {\n            const tooltipSpan = document.createElement('span');\n            const description = document.createElement('span');\n            const linebreak = document.createElement('br');\n            const tooltipTitle = document.createElement('strong');\n\n            tooltipSpan.style.display = 'none';\n            tooltipTitle.textContent = text.buttonTitle;\n            tooltipTitle.style.fontSize = '16px';\n            tooltipTitle.style.fontWeight = 'bold';\n            description.textContent = text.buttonDes;\n            description.style.fontSize = '14px';\n\n            tooltipSpan.id = tooltipId;\n            tooltipSpan.classList.add(`shadow`);\n            tooltipSpan.appendChild(tooltipTitle);\n            tooltipSpan.appendChild(linebreak);\n            tooltipSpan.appendChild(description);\n            cursiveIcon.appendChild(tooltipSpan);\n        }\n    }\n\n    /**\n     * Extracts module information from URL parameters\n     * @param {string} ur - The base URL to analyze\n     * @param {URL} parm - URL object containing search parameters\n     * @param {Array} MODULES - Array of valid module names to check against\n     * @returns {Object|boolean} Object containing resourceId and module name if found, false if no valid module\n     */\n    function getModulesInfo(ur, parm, MODULES) {\n\n        if (!MODULES.some(module => ur.includes(module))) {\n            return false;\n        }\n\n        if (ur.includes(\"forum\") && !ur.includes(\"assign\")) {\n            resourceId = parm.searchParams.get('edit');\n        } else {\n            resourceId = parm.searchParams.get('attempt');\n        }\n\n        if (resourceId === null) {\n            resourceId = 0;\n        }\n\n        for (const module of MODULES) {\n            if (ur.includes(module)) {\n                modulename = module;\n                if (module === \"lesson\" || module === \"assign\") {\n                    resourceId = cmid;\n                } else if (module === \"oublog\") {\n                    resourceId = 0;\n                }\n                break;\n            }\n        }\n\n        return {resourceId: resourceId, name: modulename};\n    }\n\n    window.addEventListener('unload', () => {\n        syncData();\n    });\n\n    setInterval(syncData, syncInterval);\n};\n"],"names":["editor","interval","userId","hasApiKey","MODULES","isStudent","hasClass","intervention","host","M","cfg","wwwroot","userid","courseid","courseId","editorid","id","cmid","contextInstanceId","ed","event","filename","modulename","questionid","resourceId","quizSubmit","assignSubmit","syncInterval","lastCaretPos","pastedContents","savingState","postOne","async","methodname","args","response","setTimeout","updateSavingState","error","window","console","on","e","preventDefault","syncData","then","off","click","localStorage","removeItem","getModal","Promise","all","title","titledes","placeholder","type","body","removeOnClose","done","modal","getRoot","addClass","show","lastEvent","save","number","document","getElementById","value","trim","ur","srcElement","baseURI","modulesInfo","getModulesInfo","URL","name","execCommand","str","alert","resourceid","usercomment","timemodified","Date","now","destroy","cancel","hidden","catch","sendKeyEvent","events","split","getItem","data","JSON","parse","push","key","keyCode","unixTimestamp","clientId","personId","position","caretPosition","rePosition","pastedContent","setItem","stringify","constructMouseEvent","getCaretPosition","button","getMouseButton","skip","selection","rng","getRng","absolutePosition","node","startContainer","startOffset","getBody","previousSibling","textContent","length","parentNode","storageKey","storedPos","parseInt","sessionStorage","isNaN","warn","originalText","getContent","format","customTooltip","tooltipText","buttonTitle","buttonDes","getTooltipText","menubarDiv","querySelectorAll","classArray","forEach","element","index","className","classList","add","cursiveIcon","createElement","src","iconUrl","iconGrayUrl","setAttribute","style","display","rightWrapper","imgWrapper","iconClone","cloneNode","targetMenu","querySelector","elementId","marginLeft","alignItems","appendChild","stateWrapper","SavingState","addEventListener","fetchSavedContent","cursiveState","tooltipId","text","setTooltip","this","css","tooltipCss","state","wrapperDiv","icon","textSpan","getStateText","getStateIcon","width","height","marginRight","verticalAlign","img","span","iconSaving","iconSaved","iconOffline","editorWrapper","context","comments","render","html","tempDiv","innerHTML","existingPanel","toggle","dropdown","contains","closeSavedDropdown","handleEscapeKey","toggleSavedDropdown","fail","remove","removeEventListener","tooltipSpan","description","linebreak","tooltipTitle","fontSize","fontWeight","parm","some","module","includes","searchParams","get","clipboardData","originalEvent","getData","selectedContent","setInterval"],"mappings":"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"}