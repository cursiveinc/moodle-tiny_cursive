{"version":3,"file":"autosaver.min.js","sources":["../src/autosaver.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module     tiny_cursive/autosaver\n * @category   TinyMCE Editor\n * @copyright  CTI <info@cursivetechnology.com>\n * @author     Brain Station 23 <sales@brainstation-23.com>\n */\n\nimport {call} from 'core/ajax';\nimport {create} from 'core/modal_factory';\nimport {get_string as getString} from 'core/str';\nimport {save, cancel, hidden} from 'core/modal_events';\nimport $ from 'jquery';\nimport {iconUrl, iconGrayUrl, tooltipCss} from 'tiny_cursive/common';\nimport Autosave from 'tiny_cursive/cursive_autosave';\nimport DocumentView from 'tiny_cursive/document_view';\nimport {call as getUser} from \"core/ajax\";\n\nexport const register = (editor, interval, userId, hasApiKey, MODULES, Rubrics, submission, quizInfo, pasteSetting) => {\n\n    var isStudent = !($('#body').hasClass('teacher_admin'));\n    var intervention = $('#body').hasClass('intervention');\n    var host = M.cfg.wwwroot;\n    var userid = userId;\n    var courseid = M.cfg.courseId;\n    var editorid = editor?.id;\n    var cmid = M.cfg.contextInstanceId;\n    var ed = \"\";\n    var event = \"\";\n    var filename = \"\";\n    var questionid = 0;\n    var quizSubmit = $('#mod_quiz-next-nav');\n    let assignSubmit = $('#id_submitbutton');\n    var syncInterval = interval ? interval * 1000 : 10000; // Default: Sync Every 10s.\n    var lastCaretPos = 1;\n    let aiContents = [];\n    var isFullScreen = false;\n    var user = null;\n    let ur = window.location.href;\n    let parm = new URL(ur);\n    let modulesInfo = getModulesInfo(ur, parm, MODULES);\n    var resourceId = modulesInfo.resourceId;\n    var modulename = modulesInfo.name;\n    var errorAlert = true;\n    let PASTE_SETTING = pasteSetting || 'allow';\n    let shouldBlockPaste = false;\n    let isPasteAllowed = false;\n\n    if (modulename !== 'assign') {\n        PASTE_SETTING = 'cite_source';\n    }\n    const postOne = async(methodname, args) => {\n        try {\n            const response = await call([{\n                methodname,\n                args,\n            }])[0];\n            if (response) {\n                setTimeout(() => {\n                    Autosave.updateSavingState('saved');\n                }, 1000);\n            }\n            return response;\n        } catch (error) {\n            Autosave.updateSavingState('offline');\n            window.console.error('Error in postOne:', error);\n            throw error;\n        }\n    };\n\n    getUser([{\n            methodname: 'core_user_get_users_by_field',\n            args: {field: 'id', values: [M.cfg.userId]},\n        }])[0].done(response => {\n            user = response[0];\n        }).fail((ex) => {\n            window.console.error('Error fetching user data:', ex);\n        });\n\n    assignSubmit.on('click', async function(e) {\n        e.preventDefault();\n        if (filename) {\n            // eslint-disable-next-line\n            syncData().then(() => {\n                assignSubmit.off('click').click();\n            });\n        } else {\n            assignSubmit.off('click').click();\n        }\n        localStorage.removeItem('lastCopyCutContent');\n    });\n\n    quizSubmit.on('click', async function(e) {\n        e.preventDefault();\n        if (filename) {\n            // eslint-disable-next-line\n            syncData().then(() => {\n                quizSubmit.off('click').click();\n            });\n        } else {\n            quizSubmit.off('click').click();\n        }\n        localStorage.removeItem('lastCopyCutContent');\n    });\n\n    const getModal = () => {\n\n        Promise.all([\n            getString('tiny_cursive_srcurl', 'tiny_cursive'),\n            getString('tiny_cursive_srcurl_des', 'tiny_cursive'),\n            getString('tiny_cursive_placeholder', 'tiny_cursive')\n        ]).then(function([title, titledes, placeholder]) {\n\n            return create({\n                type: 'SAVE_CANCEL',\n                title: `<div><div class=\"tiny-cursive-title-text\">${title}</div>\n                <span class=\"tiny-cursive-title-description \">${titledes}</span></div>`,\n                body: `<textarea  class=\"form-control inputUrl\" value=\"\" id=\"inputUrl\" placeholder=\"${placeholder}\"></textarea>`,\n                removeOnClose: true,\n            })\n                .done(modal => {\n                    modal.getRoot().addClass('tiny-cursive-modal');\n                    modal.show();\n                    var lastEvent = '';\n\n                    modal.getRoot().on(save, function() {\n\n                        var number = document.getElementById(\"inputUrl\").value.trim();\n\n                        if (number === \"\" || number === null || number === undefined) {\n                            editor.execCommand('Undo');\n                            // eslint-disable-next-line\n                            getString('pastewarning', 'tiny_cursive').then(str => alert(str));\n                        } else {\n                            editor.execCommand('Paste');\n                        }\n\n                        postOne('cursive_user_comments', {\n                            modulename: modulename,\n                            cmid: cmid,\n                            resourceid: resourceId,\n                            courseid: courseid,\n                            usercomment: number,\n                            timemodified: Date.now(),\n                            editorid: editorid ? editorid : \"\"\n                        });\n\n                        lastEvent = 'save';\n                        modal.destroy();\n                    });\n                    modal.getRoot().on(cancel, function() {\n                        editor.execCommand('Undo');\n                        lastEvent = 'cancel';\n                    });\n\n                    modal.getRoot().on(hidden, function() {\n                        if (lastEvent != 'cancel' && lastEvent != 'save') {\n                            editor.execCommand('Undo');\n                        }\n                    });\n                    return modal;\n                });\n        }).catch(error => window.console.error(error));\n\n    };\n\n    const sendKeyEvent = (events, editor) => {\n        ed = editor;\n        event = events;\n\n        filename = `${userid}_${resourceId}_${cmid}_${modulename}_attempt`;\n\n        if (modulename === 'quiz') {\n            questionid = editorid.split(':')[1].split('_')[0];\n            filename = `${userid}_${resourceId}_${cmid}_${questionid}_${modulename}_attempt`;\n        }\n\n        if (localStorage.getItem(filename)) {\n            let data = JSON.parse(localStorage.getItem(filename));\n            data.push({\n                resourceId: resourceId,\n                key: editor.key,\n                keyCode: editor.keyCode,\n                event: event,\n                courseId: courseid,\n                unixTimestamp: Date.now(),\n                clientId: host,\n                personId: userid,\n                position: ed.caretPosition,\n                rePosition: ed.rePosition,\n                pastedContent: editor.pastedContent,\n                aiContent : editor.aiContent\n            });\n            localStorage.setItem(filename, JSON.stringify(data));\n        } else {\n            let data = [{\n                resourceId: resourceId,\n                key: editor.key,\n                keyCode: editor.keyCode,\n                event: event,\n                courseId: courseid,\n                unixTimestamp: Date.now(),\n                clientId: host,\n                personId: userid,\n                position: ed.caretPosition,\n                rePosition: ed.rePosition,\n                pastedContent: editor.pastedContent,\n                aiContent : editor.aiContent\n            }];\n            localStorage.setItem(filename, JSON.stringify(data));\n        }\n    };\n\n    editor.on('keyUp', (editor) => {\n        customTooltip();\n        let position = getCaretPosition(false);\n        editor.caretPosition = position.caretPosition;\n        editor.rePosition = position.rePosition;\n        sendKeyEvent(\"keyUp\", editor);\n    });\n    editor.on('Paste', async(e) => {\n        customTooltip();\n        const pastedContent = (e.clipboardData || e.originalEvent.clipboardData).getData('text');\n        if (!pastedContent) {\n            return;\n        }\n        // Trim both values for consistent comparison\n        const trimmedPastedContent = pastedContent.trim();\n        const lastCopyCutContent = localStorage.getItem('lastCopyCutContent');\n        const isFromOwnEditor = lastCopyCutContent && trimmedPastedContent === lastCopyCutContent;\n\n        if (isStudent && intervention) {\n\n            if (PASTE_SETTING === 'block') {\n                if (!isFromOwnEditor) {\n                    e.preventDefault();\n                    shouldBlockPaste = true;\n                    isPasteAllowed = false;\n                    e.stopPropagation();\n                    e.stopImmediatePropagation();\n                    getString('paste_blocked', 'tiny_cursive').then(str => {\n                        alert(str);\n                    });\n                    setTimeout(() => {\n                        isPasteAllowed = true;\n                        shouldBlockPaste = false;\n                    }, 100);\n                    return;\n                }\n                shouldBlockPaste = false;\n                isPasteAllowed = true;\n                return;\n            }\n            if (PASTE_SETTING === 'cite_source') {\n                if (!isFromOwnEditor) {\n                    e.preventDefault();\n                    e.stopPropagation();\n                    e.stopImmediatePropagation();\n                    getModal(e);\n                }\n                isPasteAllowed = true;\n                return;\n            }\n        }\n        isPasteAllowed = true;\n    });\n    editor.on('Redo', async(e) => {\n        customTooltip();\n        if (isStudent && intervention) {\n            getModal(e);\n        }\n    });\n    editor.on('keyDown', (editor) => {\n        customTooltip();\n        const isPasteAttempt = (editor.key === 'v' || editor.key === 'V') &&\n        (editor.ctrlKey || editor.metaKey);\n        if (isPasteAttempt && isStudent && intervention && PASTE_SETTING === 'block' && !isPasteAllowed) {\n            setTimeout(() => {\n                isPasteAllowed = true;\n            }, 100);\n            return;\n        }\n        let position = getCaretPosition();\n        editor.caretPosition = position.caretPosition;\n        editor.rePosition = position.rePosition;\n        sendKeyEvent(\"keyDown\", editor);\n    });\n     editor.on('Cut', () => {\n        const selectedContent = editor.selection.getContent({format: 'text'});\n        localStorage.setItem('lastCopyCutContent', selectedContent.trim());\n    });\n    editor.on('Copy', () => {\n        const selectedContent = editor.selection.getContent({format: 'text'});\n        localStorage.setItem('lastCopyCutContent', selectedContent.trim());\n    });\n    editor.on('mouseDown', async(editor) => {\n        setTimeout(() => {\n            constructMouseEvent(editor);\n            sendKeyEvent(\"mouseDown\", editor);\n        }, 0);\n    });\n    editor.on('mouseUp', async(editor) => {\n        setTimeout(() => {\n            constructMouseEvent(editor);\n            sendKeyEvent(\"mouseUp\", editor);\n        }, 10);\n    });\n    editor.on('init', () => {\n        customTooltip();\n        localStorage.removeItem('lastCopyCutContent');\n    });\n    editor.on('SetContent', () => {\n        customTooltip();\n    });\n    editor.on('FullscreenStateChanged', (e) => {\n        let view = new DocumentView(user, Rubrics, submission, modulename, editor, quizInfo);\n        isFullScreen = e.state;\n        try {\n            if (!e.state) {\n                view.normalMode();\n            } else {\n                view.fullPageMode();\n            }\n        } catch (error) {\n            if (errorAlert) {\n                errorAlert = false;\n                getString('fullmodeerror', 'tiny_cursive').then(str => {\n                    editor.windowManager.alert(str);\n                });\n            }\n            view.normalMode();\n            window.console.error('Error ResizeEditor event:', error);\n        }\n    });\n\n    editor.on('execcommand', function (e) {\n        if (e.command === \"mceInsertContent\") {\n            const contentObj = e.value;\n\n            const isPaste = contentObj && typeof contentObj === 'object' && contentObj.paste === true;\n\n            let insertedContent = contentObj.content || contentObj;\n            let tempDiv = document.createElement('div');\n            tempDiv.innerHTML = insertedContent;\n            let text = tempDiv.textContent || tempDiv.innerText || '';\n            let pastedText = tempDiv.textContent || tempDiv.innerText || '';\n\n            let position = getCaretPosition(true);\n            editor.caretPosition = position.caretPosition;\n            editor.rePosition = position.rePosition;\n\n            if (isPaste) {\n                if (shouldBlockPaste) {\n                    shouldBlockPaste = false;\n                    e.preventDefault();\n                    editor.undoManager.undo();\n                    return;\n                }\n                const lastCopyCutContent = localStorage.getItem('lastCopyCutContent');\n                const isFromOwnEditor = lastCopyCutContent && pastedText.trim() === lastCopyCutContent;\n\n                if (isStudent && intervention && PASTE_SETTING === 'block' && !isFromOwnEditor) {\n                    isPasteAllowed = false;\n                    editor.undoManager.undo();\n                    return;\n                }\n\n                sendKeyEvent(\"Paste\", {\n                    key: \"v\",\n                    keyCode: 86,\n                    caretPosition: editor.caretPosition,\n                    rePosition: editor.rePosition,\n                    pastedContent: pastedText,\n                    srcElement: { baseURI: window.location.href }\n                });\n            } else {\n                aiContents.push(text);\n\n                sendKeyEvent(\"aiInsert\", {\n                    key: \"ai\",\n                    keyCode: 0,\n                    caretPosition: editor.caretPosition,\n                    rePosition: editor.rePosition,\n                    aiContent: text,\n                    srcElement: { baseURI: window.location.href }\n                });\n            }\n        }\n    });\n\n    editor.on('input', function (e) {\n        let position = getCaretPosition(true);\n        editor.caretPosition = position.caretPosition;\n        editor.rePosition = position.rePosition;\n        let aiContent = e.data;\n\n        if (e.inputType === 'insertReplacementText' || (e.inputType === 'insertText' && aiContent && aiContent.length > 1)) {\n\n            aiContents.push(aiContent);\n\n            e.key = \"ai\";\n            e.keyCode = 0;\n            e.caretPosition = position.caretPosition;\n            e.rePosition = position.rePosition;\n            e.aiContent = aiContent;\n\n            sendKeyEvent(\"aiInsert\", e);\n        }\n    });\n\n\n    /**\n     * Constructs a mouse event object with caret position and button information\n     * @param {Object} editor - The TinyMCE editor instance\n     * @function constructMouseEvent\n     * @description Sets caret position, reposition, key and keyCode properties on the editor object based on current mouse state\n     */\n    function constructMouseEvent(editor) {\n        let position = getCaretPosition(false);\n        editor.caretPosition = position.caretPosition;\n        editor.rePosition = position.rePosition;\n        editor.key = getMouseButton(editor);\n        editor.keyCode = editor.button;\n    }\n\n    /**\n     * Gets the string representation of a mouse button based on its numeric value\n     * @param {Object} editor - The editor object containing button information\n     * @returns {string} The string representation of the mouse button ('left', 'middle', or 'right')\n     */\n    function getMouseButton(editor) {\n\n        switch (editor.button) {\n            case 0:\n                return 'left';\n            case 1:\n                return 'middle';\n            case 2:\n                return 'right';\n        }\n        return null;\n    }\n\n    /**\n     * Gets the current caret position in the editor\n     * @param {boolean} skip - If true, returns the last known caret position instead of calculating a new one\n     * @returns {Object} Object containing:\n     *   - caretPosition: Sequential position number stored in session\n     *   - rePosition: Absolute character offset from start of content\n     * @throws {Error} Logs warning to console if error occurs during calculation\n     */\n    function getCaretPosition(skip = false) {\n        try {\n          if (!editor || !editor.selection) {\n            return { caretPosition: 0, rePosition: 0 };\n          }\n\n          const range = editor.selection.getRng();\n          const body = editor.getBody();\n\n          // Create a range from start of document to current caret\n          const preCaretRange = range.cloneRange();\n          preCaretRange.selectNodeContents(body);\n          preCaretRange.setEnd(range.endContainer, range.endOffset);\n\n          const fragment = preCaretRange.cloneContents();\n          const tempDiv = document.createElement('div');\n          tempDiv.appendChild(fragment);\n          let textBeforeCursor = tempDiv.innerText || '';\n\n          const endContainer = range.endContainer;\n          const endOffset = range.endOffset;\n\n          if (endOffset === 0 &&\n              endContainer.nodeType === Node.ELEMENT_NODE &&\n              editor.dom.isBlock(endContainer) &&\n              endContainer.previousSibling) {\n              textBeforeCursor += '\\n';\n          }\n          const blockElements = tempDiv.querySelectorAll('p, div, h1, h2, h3, h4, h5, h6, li');\n          let emptyBlockCount = 0;\n          blockElements.forEach(block => {\n            const text = block.innerText || block.textContent || '';\n            if (text.trim() === '' && block.childNodes.length === 1 &&\n                block.childNodes[0].nodeName === 'BR') {\n              emptyBlockCount++;\n            }\n          });\n\n          // Add newlines for empty blocks (these represent Enter presses that created empty lines)\n          if (emptyBlockCount > 0) {\n            textBeforeCursor += '\\n'.repeat(emptyBlockCount);\n          }\n\n          const absolutePosition = textBeforeCursor.length;\n\n          if (skip) {\n            return {\n              caretPosition: lastCaretPos,\n              rePosition: absolutePosition\n            };\n          }\n          // Increment sequential caretPosition\n          const storageKey = `${userid}_${resourceId}_${cmid}_position`;\n          let storedPos = parseInt(sessionStorage.getItem(storageKey), 10);\n          if (isNaN(storedPos)) {\n            storedPos = 0;\n          }\n          storedPos++;\n          lastCaretPos = storedPos;\n          sessionStorage.setItem(storageKey, storedPos);\n\n          return {\n            caretPosition: storedPos,\n            rePosition: absolutePosition\n          };\n\n        } catch (e) {\n            window.console.warn('Error getting caret position:', e);\n            return { caretPosition: lastCaretPos || 1, rePosition: 0 };\n        }\n      }\n\n\n    /**\n     * Synchronizes data from localStorage to server\n     * @async\n     * @function SyncData\n     * @description Retrieves stored keypress data from localStorage and sends it to server\n     * @returns {Promise} Returns response from server if data exists and is successfully sent\n     * @throws {Error} Logs error to console if data submission fails\n     */\n    async function syncData() {\n\n        let data = localStorage.getItem(filename);\n\n        if (!data || data.length === 0) {\n            return;\n        } else {\n            localStorage.removeItem(filename);\n            let originalText = editor.getContent({format: 'text'});\n            try {\n                Autosave.updateSavingState('saving');\n                // eslint-disable-next-line\n                return await postOne('cursive_write_local_to_json', {\n                    key: ed.key,\n                    event: event,\n                    keyCode: ed.keyCode,\n                    resourceId: resourceId,\n                    cmid: cmid,\n                    modulename: modulename,\n                    editorid: editorid,\n                    \"json_data\": data,\n                    originalText: originalText\n                });\n            } catch (error) {\n                window.console.error('Error submitting data:', error);\n            }\n        }\n    }\n    /**\n     * Sets up custom tooltip functionality for the Cursive icon\n     * Initializes tooltip text, positions the icon in the menubar,\n     * and sets up mouse event handlers for showing/hiding the tooltip\n     * @function customTooltip\n     */\n    function customTooltip() {\n        try {\n            const tooltipText = getTooltipText();\n            const menubarDiv = document.querySelectorAll('div[role=\"menubar\"].tox-menubar');\n            let classArray = [];\n\n            if (menubarDiv.length) {\n                menubarDiv.forEach(function(element, index) {\n                    index += 1;\n                    let className = 'cursive-menu-' + index;\n                    element.classList.add(className);\n                    classArray.push(className);\n                });\n            }\n\n            const cursiveIcon = document.createElement('img');\n            cursiveIcon.src = hasApiKey ? iconUrl : iconGrayUrl;\n\n            cursiveIcon.setAttribute('class', 'tiny_cursive_StateButton');\n            cursiveIcon.style.display = 'inline-block';\n\n            cursiveState(cursiveIcon, menubarDiv, classArray);\n\n            for (let index in classArray) {\n                const elementId = \"tiny_cursive_StateIcon\" + index;\n                const tooltipId = `tiny_cursive_tooltip${index}`;\n\n                tooltipText.then((text) => {\n                    return setTooltip(text, document.querySelector(`#${elementId}`), tooltipId);\n                }).catch(error => window.console.error(error));\n\n                $(`#${elementId}`).on('mouseenter', function() {\n                    $(this).css('position', 'relative');\n                    $(`#${tooltipId}`).css(tooltipCss);\n                });\n\n                $(`#${elementId}`).on('mouseleave', function() {\n                    $(`#${tooltipId}`).css('display', 'none');\n                });\n            }\n        } catch (error) {\n            window.console.error('Error setting up custom tooltip:', error);\n        }\n    }\n\n    /**\n     * Retrieves tooltip text strings from language files\n     * @async\n     * @function getTooltipText\n     * @returns {Promise<Object>} Object containing buttonTitle and buttonDes strings\n     */\n    async function getTooltipText() {\n        const [\n            buttonTitle,\n            buttonDes,\n        ] = await Promise.all([\n            getString('cursive:state:active', 'tiny_cursive'),\n            getString('cursive:state:active:des', 'tiny_cursive'),\n        ]);\n        return {buttonTitle, buttonDes};\n    }\n\n    /**\n     * Updates the Cursive icon state and positions it in the menubar\n     * @param {HTMLElement} cursiveIcon - The Cursive icon element to modify\n     * @param {HTMLElement} menubarDiv - The menubar div element\n     * @param {Array} classArray - Array of class names for the menubar div elements\n     */\n    function cursiveState(cursiveIcon, menubarDiv, classArray) {\n        if (!menubarDiv) {\n            return;\n        }\n\n        for (let index in classArray) {\n            const rightWrapper = document.createElement('div');\n            const imgWrapper = document.createElement('span');\n            const iconClone = cursiveIcon.cloneNode(true);\n            const targetMenu = document.querySelector('.' + classArray[index]);\n            let elementId = \"tiny_cursive_StateIcon\" + index;\n\n            rightWrapper.style.cssText = `\n                        margin-left: auto;\n                        display: flex;\n                        align-items: center;\n                    `;\n\n            imgWrapper.id = elementId;\n            imgWrapper.style.marginLeft = '.2rem';\n            imgWrapper.appendChild(iconClone);\n            rightWrapper.appendChild(imgWrapper);\n\n            let moduleIds = {\n                resourceId: resourceId,\n                cmid: cmid,\n                modulename: modulename,\n                questionid: questionid,\n                userid: userid,\n                courseid: courseid};\n            // Document mode, other modules single editor instances\n            if (isFullScreen && (modulename === 'assign' || modulename === 'forum'\n                || modulename === 'lesson')) {\n                let existsElement = document.querySelector('.tox-menubar[class*=\"cursive-menu-\"] > div');\n                if (existsElement) {\n                    existsElement.remove();\n                }\n\n                if (!document.querySelector(`#${elementId}`)) {\n                    rightWrapper.style.marginTop = '3px';\n                    document.querySelector('#tiny_cursive-fullpage-right-wrapper').prepend(rightWrapper);\n                }\n\n                Autosave.destroyInstance();\n                Autosave.getInstance(editor, rightWrapper, moduleIds, isFullScreen);\n            } else if (isFullScreen && modulename === 'quiz') { // Document mode, quiz multiple editor instances\n                let existingElement = editor.container?.childNodes[1]?.childNodes[0]?.childNodes[0]?.childNodes[7];\n                let newHeader = editor.container?.childNodes[0];\n                if (existingElement) {\n                    existingElement.remove();\n                }\n\n                if (newHeader && !newHeader.querySelector(`span[id*=tiny_cursive_StateIcon]`)) {\n                    rightWrapper.style.marginTop = '3px';\n                    document.querySelector('#tiny_cursive-fullpage-right-wrapper').prepend(rightWrapper);\n                }\n                Autosave.destroyInstance();\n                Autosave.getInstance(editor, rightWrapper, moduleIds, isFullScreen);\n            } else { // Regular view\n                let menubar = editor?.container?.children[0]?.childNodes[0]?.childNodes[0];\n\n                if (targetMenu && !targetMenu.querySelector(`#${elementId}`)) {\n                    targetMenu.appendChild(rightWrapper);\n                }\n                // Regular view, multiple editor instances\n                if (modulename === 'quiz' && menubar) {\n                    let wrapper = menubar.querySelector('span[id*=\"tiny_cursive_StateIcon\"]');\n\n                    if (wrapper) {\n                        Autosave.destroyInstance();\n                        Autosave.getInstance(editor, wrapper?.parentElement, moduleIds, isFullScreen);\n                    }\n                } else {\n                    Autosave.destroyInstance();\n                    Autosave.getInstance(editor, rightWrapper, moduleIds, isFullScreen);\n                }\n            }\n        }\n    }\n\n    /**\n     * Sets up tooltip content and styling for the Cursive icon\n     * @param {Object} text - Object containing tooltip text strings\n     * @param {string} text.buttonTitle - Title text for the tooltip\n     * @param {string} text.buttonDes - Description text for the tooltip\n     * @param {HTMLElement} cursiveIcon - The Cursive icon element to attach tooltip to\n     * @param {string} tooltipId - ID for the tooltip element\n     */\n    function setTooltip(text, cursiveIcon, tooltipId) {\n\n        if (document.querySelector(`#${tooltipId}`)) {\n            return;\n        }\n        if (cursiveIcon) {\n\n            const tooltipSpan = document.createElement('span');\n            const description = document.createElement('span');\n            const linebreak = document.createElement('br');\n            const tooltipTitle = document.createElement('strong');\n\n            tooltipSpan.style.display = 'none';\n            tooltipTitle.textContent = text.buttonTitle;\n            tooltipTitle.style.fontSize = '16px';\n            tooltipTitle.style.fontWeight = 'bold';\n            description.textContent = text.buttonDes;\n            description.style.fontSize = '14px';\n\n            tooltipSpan.id = tooltipId;\n            tooltipSpan.classList.add(`shadow`);\n            tooltipSpan.appendChild(tooltipTitle);\n            tooltipSpan.appendChild(linebreak);\n            tooltipSpan.appendChild(description);\n            cursiveIcon.appendChild(tooltipSpan);\n        }\n    }\n\n    /**\n     * Extracts module information from URL parameters\n     * @param {string} ur - The base URL to analyze\n     * @param {URL} parm - URL object containing search parameters\n     * @param {Array} MODULES - Array of valid module names to check against\n     * @returns {Object|boolean} Object containing resourceId and module name if found, false if no valid module\n     */\n    function getModulesInfo(ur, parm, MODULES) {\n        fetchStrings();\n        if (!MODULES.some(module => ur.includes(module))) {\n            return false;\n        }\n\n        if (ur.includes(\"forum\") && !ur.includes(\"assign\")) {\n            resourceId = parm.searchParams.get('edit');\n        } else {\n            resourceId = parm.searchParams.get('attempt');\n        }\n\n        if (resourceId === null) {\n            resourceId = 0;\n        }\n\n        for (const module of MODULES) {\n            if (ur.includes(module)) {\n                modulename = module;\n                if (module === \"lesson\" || module === \"assign\") {\n                    resourceId = cmid;\n                } else if (module === \"oublog\") {\n                    resourceId = 0;\n                }\n                break;\n            }\n        }\n\n        return {resourceId: resourceId, name: modulename};\n    }\n\n    /**\n     * Fetches and caches localized strings used in the UI\n     * @function fetchStrings\n     * @description Retrieves strings for sidebar titles and document sidebar elements if not already cached in localStorage\n     * Uses Promise.all to fetch multiple strings in parallel for better performance\n     * Stores the fetched strings in localStorage under 'sbTitle' and 'docSideBar' keys\n     */\n    function fetchStrings() {\n        if (!localStorage.getItem('sbTitle')) {\n            Promise.all([\n                getString('assignment', 'tiny_cursive'),\n                getString('discussion', 'tiny_cursive'),\n                getString('pluginname', 'mod_quiz'),\n                getString('pluginname', 'mod_lesson'),\n                getString('description', 'tiny_cursive'),\n            ]).then(function (strings) {\n                localStorage.setItem('sbTitle', JSON.stringify(strings));\n            });\n        }\n        if (!localStorage.getItem('docSideBar')) {\n            Promise.all([\n                getString('details', 'tiny_cursive'),\n                getString('student_info', 'tiny_cursive'),\n                getString('progress', 'tiny_cursive'),\n                getString('description', 'tiny_cursive'),\n                getString('replyingto', 'tiny_cursive'),\n                getString('answeringto', 'tiny_cursive'),\n                getString('importantdates', 'tiny_cursive'),\n                getString('rubrics', 'tiny_cursive'),\n                getString('submission_status', 'tiny_cursive'),\n                getString('status', 'tiny_cursive'),\n                getString('draft', 'tiny_cursive'),\n                getString('draftnot', 'tiny_cursive'),\n                getString('last_modified', 'tiny_cursive'),\n                getString('gradings', 'tiny_cursive'),\n                getString('gradenot', 'tiny_cursive'),\n                getString('word_count', 'tiny_cursive'),\n                getString('timeleft', 'tiny_cursive'),\n                getString('nolimit', 'tiny_cursive'),\n                getString('name', 'tiny_cursive'),\n                getString('userename', 'tiny_cursive'),\n                getString('course', 'tiny_cursive'),\n                getString('opened', 'tiny_cursive'),\n                getString('due', 'tiny_cursive'),\n                getString('overdue', 'tiny_cursive'),\n                getString('remaining', 'tiny_cursive'),\n                getString('savechanges', 'tiny_cursive'),\n                getString('subjectnot', 'tiny_cursive'),\n                getString('remaining', 'tiny_cursive'),\n            ]).then(function (strings) {\n                localStorage.setItem('docSideBar', JSON.stringify(strings));\n            });\n        }\n    }\n\n    window.addEventListener('unload', () => {\n        syncData();\n    });\n\n    setInterval(syncData, syncInterval);\n};\n"],"names":["editor","interval","userId","hasApiKey","MODULES","Rubrics","submission","quizInfo","pasteSetting","isStudent","hasClass","intervention","host","M","cfg","wwwroot","userid","courseid","courseId","editorid","id","cmid","contextInstanceId","ed","event","filename","questionid","quizSubmit","assignSubmit","syncInterval","lastCaretPos","aiContents","isFullScreen","user","ur","window","location","href","modulesInfo","parm","localStorage","getItem","Promise","all","then","strings","setItem","JSON","stringify","fetchStrings","some","module","includes","resourceId","searchParams","get","modulename","name","getModulesInfo","URL","errorAlert","PASTE_SETTING","shouldBlockPaste","isPasteAllowed","postOne","async","methodname","args","response","setTimeout","updateSavingState","error","console","field","values","done","fail","ex","on","e","preventDefault","syncData","off","click","removeItem","getModal","title","titledes","placeholder","type","body","removeOnClose","modal","getRoot","addClass","show","lastEvent","save","number","document","getElementById","value","trim","execCommand","str","alert","resourceid","usercomment","timemodified","Date","now","destroy","cancel","hidden","catch","sendKeyEvent","events","split","data","parse","push","key","keyCode","unixTimestamp","clientId","personId","position","caretPosition","rePosition","pastedContent","aiContent","constructMouseEvent","getCaretPosition","button","getMouseButton","skip","selection","range","getRng","getBody","preCaretRange","cloneRange","selectNodeContents","setEnd","endContainer","endOffset","fragment","cloneContents","tempDiv","createElement","appendChild","textBeforeCursor","innerText","nodeType","Node","ELEMENT_NODE","dom","isBlock","previousSibling","blockElements","querySelectorAll","emptyBlockCount","forEach","block","textContent","childNodes","length","nodeName","repeat","absolutePosition","storageKey","storedPos","parseInt","sessionStorage","isNaN","warn","originalText","getContent","format","customTooltip","tooltipText","buttonTitle","buttonDes","getTooltipText","menubarDiv","classArray","element","index","className","classList","add","cursiveIcon","src","iconUrl","iconGrayUrl","setAttribute","style","display","rightWrapper","imgWrapper","iconClone","cloneNode","targetMenu","querySelector","elementId","cssText","marginLeft","moduleIds","existingElement","container","_editor$container","_editor$container$chi","_editor$container$chi2","_editor$container$chi3","newHeader","_editor$container2","remove","marginTop","prepend","destroyInstance","getInstance","menubar","_editor$container3","children","_editor$container3$ch","_editor$container3$ch2","wrapper","parentElement","existsElement","cursiveState","tooltipId","text","setTooltip","this","css","tooltipCss","tooltipSpan","description","linebreak","tooltipTitle","fontSize","fontWeight","clipboardData","originalEvent","getData","trimmedPastedContent","lastCopyCutContent","isFromOwnEditor","stopPropagation","stopImmediatePropagation","ctrlKey","metaKey","selectedContent","view","DocumentView","state","fullPageMode","normalMode","windowManager","command","contentObj","isPaste","paste","insertedContent","content","innerHTML","pastedText","undoManager","undo","srcElement","baseURI","inputType","addEventListener","setInterval"],"mappings":"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"}