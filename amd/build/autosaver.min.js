define("tiny_cursive/autosaver",["exports","core/ajax","core/modal_factory","core/str","core/modal_events"],(function(_exports,_ajax,_modal_factory,_str,_modal_events){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.register=void 0;_exports.register=(editor,interval,userId)=>{var is_student,intervention,quizSubmit,assignSubmit;quizSubmit=document.querySelector("#responseform"),assignSubmit=document.querySelector("#id_submitbutton");var bodyElement=document.querySelector("#body");bodyElement?(is_student=!bodyElement.classList.contains("teacher_admin"),intervention=bodyElement.classList.contains("intervention")):console.error("#body element not found");var userid=userId,host=M.cfg.wwwroot,courseid=M.cfg.courseId,filename="",resourceId=0,modulename="",editorid=null==editor?void 0:editor.id,cmid=M.cfg.contextInstanceId,questionid=0,syncInterval=interval?1e3*interval:1e4;const postOne=async(methodname,args)=>{try{return await(0,_ajax.call)([{methodname:methodname,args:args}])[0]}catch(error){throw console.error("Error in postOne:",error),error}};(document.getElementById("page-mod-assign-editsubmission")||document.getElementById("page-mod-forum-post")||document.getElementById("page-mod-forum-view"))&&assignSubmit&&assignSubmit.addEventListener("click",(async function(e){e.preventDefault(),filename?await SyncData().then((res=>{assignSubmit.removeEventListener("click",arguments.callee),assignSubmit.click(),assignSubmit.removeEventListener("click",arguments.callee)})):(assignSubmit.removeEventListener("click",arguments.callee),assignSubmit.click(),assignSubmit.removeEventListener("click",arguments.callee))})),document.getElementById("page-mod-quiz-attempt")&&quizSubmit&&quizSubmit.addEventListener("click",(async e=>{filename&&await SyncData().then((res=>{document.querySelector("#responseform").submit()}))}));const getModal=e=>{Promise.all([(0,_str.get_string)("tiny_cursive_srcurl","tiny_cursive"),(0,_str.get_string)("tiny_cursive_srcurl_des","tiny_cursive"),(0,_str.get_string)("tiny_cursive_placeholder","tiny_cursive")]).then((function(_ref){let[title,titledes,placeholder]=_ref;return(0,_modal_factory.create)({type:"SAVE_CANCEL",title:`<div><div style='color:dark;font-weight:500;line-height:0.5'>${title}</div><span style='color: gray;font-weight: 400;line-height: 1.2;font-size: 14px;display: inline-block;margin-top: .5rem;'>${titledes}</span></div>`,body:`<textarea  class="form-control inputUrl" value="" id="inputUrl" placeholder="${placeholder}"></textarea>`,removeOnClose:!0}).done((modal=>{modal.getRoot().append("<style>.close{ display: none ! important; }</style>"),modal.show();var lastEvent="";return modal.getRoot().on(_modal_events.save,(function(){var number=document.getElementById("inputUrl").value;""===number||null==number?(editor.execCommand("Undo"),alert("You cannot paste text without providing source")):editor.execCommand("Paste");let ur=e.srcElement.baseURI,resourceId=0,parm=new URL(ur),modulename="",editorid=null==editor?void 0:editor.id,courseid=M.cfg.courseId,cmid=M.cfg.contextInstanceId;if(!(ur.includes("attempt.php")||ur.includes("forum")||ur.includes("assign")))return!1;ur.includes("forum")&&!ur.includes("assign")&&(resourceId=parm.searchParams.get("edit")),ur.includes("forum")||ur.includes("assign")||(resourceId=parm.searchParams.get("attempt")),null===resourceId&&(resourceId=0),ur.includes("forum")&&(modulename="forum"),ur.includes("assign")&&(modulename="assign",resourceId=cmid),ur.includes("attempt")&&(modulename="quiz"),null===cmid&&(cmid=0),postOne("cursive_user_comments",{modulename:modulename,cmid:cmid,resourceid:resourceId,courseid:courseid,usercomment:number,timemodified:Date.now(),editorid:editorid||""}),lastEvent="save",modal.destroy()})),modal.getRoot().on(_modal_events.cancel,(function(){editor.execCommand("Undo"),lastEvent="cancel"})),modal.getRoot().on(_modal_events.hidden,(function(){"cancel"!=lastEvent&&"save"!=lastEvent&&editor.execCommand("Undo")})),modal}))}))},sendKeyEvent=(event,ed)=>{let ur=ed.srcElement.baseURI,parm=new URL(ur);if(ed=ed,event=event,!(ur.includes("attempt.php")||ur.includes("forum")||ur.includes("assign")))return!1;if(null===(resourceId=ur.includes("forum")&&!ur.includes("assign")?parm.searchParams.get("edit"):parm.searchParams.get("attempt"))&&(resourceId=0),ur.includes("forum")&&(modulename="forum"),ur.includes("assign")&&(modulename="assign",resourceId=cmid),ur.includes("attempt")&&(modulename="quiz"),filename=`${userid}_${resourceId}_${cmid}_${modulename}_attempt`,"quiz"===modulename&&(questionid=editorid.split(":")[1].split("_")[0],filename=`${userid}_${resourceId}_${cmid}_${questionid}_${modulename}_attempt`),"Process"!==ed.key)if(localStorage.getItem(filename)){let data=JSON.parse(localStorage.getItem(filename));data.push({resourceId:resourceId,key:ed.key,keyCode:ed.keyCode,event:event,courseId:courseid,unixTimestamp:Date.now(),clientId:host,personId:userid}),localStorage.setItem(filename,JSON.stringify(data))}else{let data=[];data.push({resourceId:resourceId,key:ed.key,keyCode:ed.keyCode,event:event,courseId:courseid,unixTimestamp:Date.now(),clientId:host,personId:userid}),localStorage.setItem(filename,JSON.stringify(data))}};async function SyncData(){let data=localStorage.getItem(filename);if(data&&0!==data.length){localStorage.removeItem(filename);let originalText=editor.getContent({format:"text"});try{return await postOne("cursive_write_local_to_json",{key:"".key,event:"",keyCode:"".keyCode,resourceId:resourceId,cmid:cmid,modulename:modulename,editorid:editorid,json_data:data,originalText:originalText})}catch(error){console.error("Error submitting data:",error)}}}editor.on("keyUp",(editor=>{sendKeyEvent("keyUp",editor)})),editor.on("Paste",(async e=>{is_student&&intervention&&getModal(e)})),editor.on("Redo",(async e=>{is_student&&intervention&&getModal(e)})),editor.on("keyDown",(editor=>{sendKeyEvent("keyDown",editor)})),editor.on("init",(()=>{})),window.addEventListener("unload",(e=>{SyncData()})),setInterval(SyncData,syncInterval)}}));

//# sourceMappingURL=autosaver.min.js.map