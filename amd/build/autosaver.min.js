define("tiny_cursive/autosaver",["exports","core/ajax","core/modal_factory","core/str","core/modal_events","jquery","tiny_cursive/common"],(function(_exports,_ajax,_modal_factory,_str,_modal_events,_jquery,_common){var obj;Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.register=void 0,_jquery=(obj=_jquery)&&obj.__esModule?obj:{default:obj};_exports.register=(editor,interval,userId,hasApiKey)=>{var isStudent=!(0,_jquery.default)("#body").hasClass("teacher_admin"),intervention=(0,_jquery.default)("#body").hasClass("intervention"),userid=userId,host=M.cfg.wwwroot,courseid=M.cfg.courseId,filename="",quizSubmit=(0,_jquery.default)("#mod_quiz-next-nav"),ed="",event="",resourceId=0,modulename="",editorid=null==editor?void 0:editor.id,cmid=M.cfg.contextInstanceId,questionid=0;let assignSubmit=(0,_jquery.default)("#id_submitbutton");var syncInterval=interval?1e3*interval:1e4;const postOne=async(methodname,args)=>{try{return await(0,_ajax.call)([{methodname:methodname,args:args}])[0]}catch(error){throw window.console.error("Error in postOne:",error),error}};assignSubmit.on("click",(async function(e){e.preventDefault(),filename?syncData().then((()=>{assignSubmit.off("click").click()})):assignSubmit.off("click").click()})),quizSubmit.on("click",(async function(e){e.preventDefault(),filename?syncData().then((()=>{quizSubmit.off("click").click()})):quizSubmit.off("click").click()}));const getModal=e=>{Promise.all([(0,_str.get_string)("tiny_cursive_srcurl","tiny_cursive"),(0,_str.get_string)("tiny_cursive_srcurl_des","tiny_cursive"),(0,_str.get_string)("tiny_cursive_placeholder","tiny_cursive")]).then((function(_ref){let[title,titledes,placeholder]=_ref;return(0,_modal_factory.create)({type:"SAVE_CANCEL",title:"<div><div style='color:dark;font-weight:500;line-height:0.5'>".concat(title,"</div><span style='color:\n                        gray;font-weight: 400;line-height: 1.2;font-size: 14px;display: inline-block;\n                        margin-top: .5rem;'>").concat(titledes,"</span></div>"),body:'<textarea  class="form-control inputUrl" value="" id="inputUrl" placeholder="'.concat(placeholder,'"></textarea>'),removeOnClose:!0}).done((modal=>{modal.getRoot().append("\n                        <style>\n                                .close {\n                                    display: none ! important;\n                                }\n                                body.tox-fullscreen .modal-dialog {\n                                    max-width: 500px;\n                                    max-height:300px;\n                                    padding:1rem;\n                                }\n                                body.tox-fullscreen .modal-dialog .modal-header {\n                                    height: auto;\n                                    padding: 1rem\n                                }\n                         </style>"),modal.show();var lastEvent="";return modal.getRoot().on(_modal_events.save,(function(){var number=document.getElementById("inputUrl").value.trim();""===number||null==number?(editor.execCommand("Undo"),(0,_str.get_string)("pastewarning","tiny_cursive").then((str=>alert(str)))):editor.execCommand("Paste");let ur=e.srcElement.baseURI,resourceId=0,parm=new URL(ur),modulename="",editorid=null==editor?void 0:editor.id,courseid=M.cfg.courseId,cmid=M.cfg.contextInstanceId;if(!(ur.includes("attempt.php")||ur.includes("forum")||ur.includes("assign")||ur.includes("lesson")|ur.includes("oublog")))return!1;ur.includes("forum")&&!ur.includes("assign")&&(resourceId=parm.searchParams.get("edit")),ur.includes("forum")||ur.includes("assign")||(resourceId=parm.searchParams.get("attempt")),null===resourceId&&(resourceId=0),ur.includes("forum")&&(modulename="forum"),ur.includes("assign")&&(modulename="assign",resourceId=cmid),ur.includes("attempt")&&(modulename="quiz"),ur.includes("lesson")&&(modulename="lesson",resourceId=cmid),ur.includes("oublog")&&(modulename="oublog",resourceId=0),null===cmid&&(cmid=0),postOne("cursive_user_comments",{modulename:modulename,cmid:cmid,resourceid:resourceId,courseid:courseid,usercomment:number,timemodified:Date.now(),editorid:editorid||""}),lastEvent="save",modal.destroy()})),modal.getRoot().on(_modal_events.cancel,(function(){editor.execCommand("Undo"),lastEvent="cancel"})),modal.getRoot().on(_modal_events.hidden,(function(){"cancel"!=lastEvent&&"save"!=lastEvent&&editor.execCommand("Undo")})),modal}))})).catch((error=>window.console.error(error)))},sendKeyEvent=(events,eds)=>{let ur=eds.srcElement.baseURI,parm=new URL(ur);if(ed=eds,event=events,!(ur.includes("attempt.php")||ur.includes("forum")||ur.includes("assign")||ur.includes("lesson")||ur.includes("oublog")))return!1;if(null===(resourceId=ur.includes("forum")&&!ur.includes("assign")?parm.searchParams.get("edit"):parm.searchParams.get("attempt"))&&(resourceId=0),ur.includes("forum")&&(modulename="forum"),ur.includes("assign")&&(modulename="assign",resourceId=cmid),ur.includes("attempt")&&(modulename="quiz"),ur.includes("lesson")&&(modulename="lesson",resourceId=cmid),ur.includes("oublog")&&(modulename="oublog",resourceId=0),filename="".concat(userid,"_").concat(resourceId,"_").concat(cmid,"_").concat(modulename,"_attempt"),"quiz"===modulename&&(questionid=editorid.split(":")[1].split("_")[0],filename="".concat(userid,"_").concat(resourceId,"_").concat(cmid,"_").concat(questionid,"_").concat(modulename,"_attempt")),localStorage.getItem(filename)){let data=JSON.parse(localStorage.getItem(filename));data.push({resourceId:resourceId,key:ed.key,keyCode:ed.keyCode,event:event,courseId:courseid,unixTimestamp:Date.now(),clientId:host,personId:userid}),localStorage.setItem(filename,JSON.stringify(data))}else{let data=[];data.push({resourceId:resourceId,key:ed.key,keyCode:ed.keyCode,event:event,courseId:courseid,unixTimestamp:Date.now(),clientId:host,personId:userid}),localStorage.setItem(filename,JSON.stringify(data))}};async function syncData(){let data=localStorage.getItem(filename);if(data&&0!==data.length){localStorage.removeItem(filename);let originalText=editor.getContent({format:"text"});try{return await postOne("cursive_write_local_to_json",{key:ed.key,event:event,keyCode:ed.keyCode,resourceId:resourceId,cmid:cmid,modulename:modulename,editorid:editorid,json_data:data,originalText:originalText})}catch(error){window.console.error("Error submitting data:",error)}}}function customTooltip(){if(!document.querySelector("#tiny_cursive_StateIcon"))try{const tooltipText=async function(){const[buttonTitle,buttonDes]=await Promise.all([(0,_str.get_string)("cursive:state:active","tiny_cursive"),(0,_str.get_string)("cursive:state:active:des","tiny_cursive")]);return{buttonTitle:buttonTitle,buttonDes:buttonDes}}(),menubarDiv=document.querySelector('div[role="menubar"].tox-menubar'),cursiveIcon=document.createElement("img");cursiveIcon.src=hasApiKey?_common.iconUrl:_common.iconGrayUrl,cursiveIcon.setAttribute("class","tiny_cursive_StateButton"),cursiveIcon.style.display="inline-block",function(cursiveIcon,menubarDiv){if(menubarDiv){const rightWrapper=document.createElement("div"),imgWrapper=document.createElement("span");rightWrapper.style.marginLeft="auto",rightWrapper.style.display="flex",rightWrapper.style.alignItems="center",imgWrapper.id="tiny_cursive_StateIcon",imgWrapper.appendChild(cursiveIcon),rightWrapper.appendChild(imgWrapper),menubarDiv.appendChild(rightWrapper)}}(cursiveIcon,menubarDiv),tooltipText.then((text=>{!function(text,cursiveIcon){const tooltipSpan=document.createElement("span"),description=document.createElement("span"),linebreak=document.createElement("br"),tooltipTitle=document.createElement("strong");tooltipSpan.style.display="none",cursiveIcon.style.width="auto",tooltipTitle.textContent=text.buttonTitle,tooltipTitle.style.fontSize="16px",tooltipTitle.style.fontWeight="bold",description.textContent=text.buttonDes,description.style.fontSize="14px",tooltipSpan.setAttribute("class","tiny_cursive_tooltip shadow"),tooltipSpan.appendChild(tooltipTitle),tooltipSpan.appendChild(linebreak),tooltipSpan.appendChild(description),cursiveIcon.appendChild(tooltipSpan)}(text,document.querySelector("#tiny_cursive_StateIcon"))})),(0,_jquery.default)("#tiny_cursive_StateIcon").on("mouseenter",(function(){(0,_jquery.default)(this).css("position","relative"),(0,_jquery.default)(".tiny_cursive_tooltip").css({display:"block",position:"absolute",transform:"translateX(-100%)",backgroundColor:"white",color:"black",border:"1px solid #ccc",marginBottom:"6px",padding:"10px",textAlign:"justify",minWidth:"200px",borderRadius:"1px",pointerEvents:"none",zIndex:1e4})})),(0,_jquery.default)("#tiny_cursive_StateIcon").on("mouseleave",(function(){(0,_jquery.default)(".tiny_cursive_tooltip").css("display","none")}))}catch(error){window.console.error("Error setting up custom tooltip:",error)}}editor.on("keyUp",(editor=>{customTooltip(),sendKeyEvent("keyUp",editor)})),editor.on("Paste",(async e=>{customTooltip(),isStudent&&intervention&&getModal(e)})),editor.on("Redo",(async e=>{customTooltip(),isStudent&&intervention&&getModal(e)})),editor.on("keyDown",(editor=>{sendKeyEvent("keyDown",editor),customTooltip()})),editor.on("init",(()=>{customTooltip()})),editor.on("SkinLoaded",(()=>{customTooltip()})),window.addEventListener("unload",(()=>{syncData()})),setInterval(syncData,syncInterval)}}));

//# sourceMappingURL=autosaver.min.js.map