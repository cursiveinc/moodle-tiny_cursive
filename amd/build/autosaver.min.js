define("tiny_cursive/autosaver",["exports","core/ajax","core/modal_factory","core/str","core/modal_events","jquery","tiny_cursive/common","core/templates"],(function(_exports,_ajax,_modal_factory,_str,_modal_events,_jquery,_common,_templates){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.register=void 0,_jquery=_interopRequireDefault(_jquery),_templates=_interopRequireDefault(_templates);_exports.register=(editor,interval,userId,hasApiKey,MODULES)=>{var isStudent=!(0,_jquery.default)("#body").hasClass("teacher_admin"),intervention=(0,_jquery.default)("#body").hasClass("intervention"),host=M.cfg.wwwroot,userid=userId,courseid=M.cfg.courseId,editorid=null==editor?void 0:editor.id,cmid=M.cfg.contextInstanceId,ed="",event="",filename="",modulename="",questionid=0,resourceId=0,quizSubmit=(0,_jquery.default)("#mod_quiz-next-nav");let assignSubmit=(0,_jquery.default)("#id_submitbutton");var syncInterval=interval?1e3*interval:1e4,lastCaretPos=1;let pastedContents=[];var savingState="";const postOne=async(methodname,args)=>{try{const response=await(0,_ajax.call)([{methodname:methodname,args:args}])[0];return response&&setTimeout((()=>{updateSavingState("saved")}),1e3),response}catch(error){throw updateSavingState("offline"),window.console.error("Error in postOne:",error),error}};assignSubmit.on("click",(async function(e){e.preventDefault(),filename?syncData().then((()=>{assignSubmit.off("click").click()})):assignSubmit.off("click").click(),localStorage.removeItem("lastCopyCutContent")})),quizSubmit.on("click",(async function(e){e.preventDefault(),filename?syncData().then((()=>{quizSubmit.off("click").click()})):quizSubmit.off("click").click(),localStorage.removeItem("lastCopyCutContent")}));const getModal=e=>{Promise.all([(0,_str.get_string)("tiny_cursive_srcurl","tiny_cursive"),(0,_str.get_string)("tiny_cursive_srcurl_des","tiny_cursive"),(0,_str.get_string)("tiny_cursive_placeholder","tiny_cursive")]).then((function(_ref){let[title,titledes,placeholder]=_ref;return(0,_modal_factory.create)({type:"SAVE_CANCEL",title:`<div><div class="tiny-cursive-title-text">${title}</div>\n                <span class="tiny-cursive-title-description ">${titledes}</span></div>`,body:`<textarea  class="form-control inputUrl" value="" id="inputUrl" placeholder="${placeholder}"></textarea>`,removeOnClose:!0}).done((modal=>{modal.getRoot().addClass("tiny-cursive-modal"),modal.show();var lastEvent="";return modal.getRoot().on(_modal_events.save,(function(){var number=document.getElementById("inputUrl").value.trim();let ur=e.srcElement.baseURI,modulesInfo=getModulesInfo(ur,new URL(ur),MODULES);resourceId=modulesInfo.resourceId,modulename=modulesInfo.name,""===number||null==number?(editor.execCommand("Undo"),(0,_str.get_string)("pastewarning","tiny_cursive").then((str=>alert(str)))):editor.execCommand("Paste"),postOne("cursive_user_comments",{modulename:modulename,cmid:cmid,resourceid:resourceId,courseid:courseid,usercomment:number,timemodified:Date.now(),editorid:editorid||""}),lastEvent="save",modal.destroy()})),modal.getRoot().on(_modal_events.cancel,(function(){editor.execCommand("Undo"),lastEvent="cancel"})),modal.getRoot().on(_modal_events.hidden,(function(){"cancel"!=lastEvent&&"save"!=lastEvent&&editor.execCommand("Undo")})),modal}))})).catch((error=>window.console.error(error)))},sendKeyEvent=(events,editor)=>{ed=editor,event=events;let ur=editor.srcElement.baseURI,modulesInfo=getModulesInfo(ur,new URL(ur),MODULES);if(resourceId=modulesInfo.resourceId,modulename=modulesInfo.name,filename=`${userid}_${resourceId}_${cmid}_${modulename}_attempt`,"quiz"===modulename&&(questionid=editorid.split(":")[1].split("_")[0],filename=`${userid}_${resourceId}_${cmid}_${questionid}_${modulename}_attempt`),localStorage.getItem(filename)){let data=JSON.parse(localStorage.getItem(filename));data.push({resourceId:resourceId,key:editor.key,keyCode:editor.keyCode,event:event,courseId:courseid,unixTimestamp:Date.now(),clientId:host,personId:userid,position:ed.caretPosition,rePosition:ed.rePosition,pastedContent:pastedContents}),localStorage.setItem(filename,JSON.stringify(data))}else{let data=[{resourceId:resourceId,key:editor.key,keyCode:editor.keyCode,event:event,courseId:courseid,unixTimestamp:Date.now(),clientId:host,personId:userid,position:ed.caretPosition,rePosition:ed.rePosition,pastedContent:pastedContents}];localStorage.setItem(filename,JSON.stringify(data))}};function constructMouseEvent(editor){let position=getCaretPosition();editor.caretPosition=position.caretPosition,editor.rePosition=position.rePosition,editor.key=function(editor){switch(editor.button){case 0:return"left";case 1:return"middle";case 2:return"right"}return null}(editor),editor.keyCode=editor.button}function getCaretPosition(){let skip=arguments.length>0&&void 0!==arguments[0]&&arguments[0];try{if(!editor||!editor.selection)return{caretPosition:0,rePosition:0};const rng=editor.selection.getRng();let absolutePosition=0,node=rng.startContainer;for(absolutePosition=rng.startOffset;node&&node!==editor.getBody();){for(;node.previousSibling;)node=node.previousSibling,node.textContent&&(absolutePosition+=node.textContent.length);node=node.parentNode}if(skip)return{caretPosition:lastCaretPos,rePosition:absolutePosition};const storageKey=`${userid}_${resourceId}_${cmid}_position`;let storedPos=parseInt(sessionStorage.getItem(storageKey),10);return isNaN(storedPos)&&(storedPos=0),storedPos++,lastCaretPos=storedPos,sessionStorage.setItem(storageKey,storedPos),{caretPosition:storedPos,rePosition:absolutePosition}}catch(e){return window.console.warn("Error getting caret position:",e),{caretPosition:0,rePosition:0}}}async function syncData(){let data=localStorage.getItem(filename);if(data&&0!==data.length){localStorage.removeItem(filename);let originalText=editor.getContent({format:"text"});try{return updateSavingState("saving"),await postOne("cursive_write_local_to_json",{key:ed.key,event:event,keyCode:ed.keyCode,resourceId:resourceId,cmid:cmid,modulename:modulename,editorid:editorid,json_data:data,originalText:originalText})}catch(error){window.console.error("Error submitting data:",error)}}}function customTooltip(){try{const tooltipText=async function(){const[buttonTitle,buttonDes]=await Promise.all([(0,_str.get_string)("cursive:state:active","tiny_cursive"),(0,_str.get_string)("cursive:state:active:des","tiny_cursive")]);return{buttonTitle:buttonTitle,buttonDes:buttonDes}}(),menubarDiv=document.querySelectorAll('div[role="menubar"].tox-menubar');let classArray=[];menubarDiv.length&&menubarDiv.forEach((function(element,index){let className="cursive-menu-"+(index+=1);element.classList.add(className),classArray.push(className)}));const cursiveIcon=document.createElement("img");cursiveIcon.src=hasApiKey?_common.iconUrl:_common.iconGrayUrl,cursiveIcon.setAttribute("class","tiny_cursive_StateButton"),cursiveIcon.style.display="inline-block",function(cursiveIcon,menubarDiv,classArray){if(menubarDiv)for(let index in classArray){const rightWrapper=document.createElement("div"),imgWrapper=document.createElement("span"),iconClone=cursiveIcon.cloneNode(!0),targetMenu=document.querySelector("."+classArray[index]);let elementId="tiny_cursive_StateIcon"+index;if(rightWrapper.style.marginLeft="auto",rightWrapper.style.display="flex",rightWrapper.style.alignItems="center",imgWrapper.id=elementId,imgWrapper.appendChild(iconClone),null==targetMenu||!targetMenu.querySelector(".tiny_cursive_savingState")){const stateWrapper=SavingState(savingState);stateWrapper.classList.add("tiny_cursive_savingState","btn"),stateWrapper.id="tiny_cursive_savingState",rightWrapper.appendChild(stateWrapper),stateWrapper.addEventListener("click",fetchSavedContent)}rightWrapper.appendChild(imgWrapper),targetMenu&&!targetMenu.querySelector(`#${elementId}`)&&targetMenu.appendChild(rightWrapper)}}(cursiveIcon,menubarDiv,classArray);for(let index in classArray){const elementId="tiny_cursive_StateIcon"+index,tooltipId=`tiny_cursive_tooltip${index}`;tooltipText.then((text=>setTooltip(text,document.querySelector(`#${elementId}`),tooltipId))).catch((error=>window.console.error(error))),(0,_jquery.default)(`#${elementId}`).on("mouseenter",(function(){(0,_jquery.default)(this).css("position","relative"),(0,_jquery.default)(`#${tooltipId}`).css(_common.tooltipCss)})),(0,_jquery.default)(`#${elementId}`).on("mouseleave",(function(){(0,_jquery.default)(`#${tooltipId}`).css("display","none")}))}}catch(error){window.console.error("Error setting up custom tooltip:",error)}}function SavingState(state){let wrapperDiv=document.createElement("div"),icon=document.createElement("img"),textSpan=document.createElement("span"),button=document.createElement("button");return state&&(textSpan.textContent=getStateText(state),icon.src=getStateIcon(state)),icon.style.width="28px",icon.style.height="28px",icon.style.marginRight="5px",icon.style.display="none",wrapperDiv.style.marginRight="0.5rem",wrapperDiv.style.verticalAlign="middle",wrapperDiv.appendChild(icon),wrapperDiv.appendChild(textSpan),button.appendChild(wrapperDiv),button}function updateSavingState(state){savingState=state;let stateWrapper=document.querySelector(".tiny_cursive_savingState");if(!stateWrapper)return;let img=stateWrapper.querySelector("img"),span=stateWrapper.querySelector("span");img.style.display="inline",span.textContent=getStateText(state),img.src=getStateIcon(state)}function getStateText(state){switch(state){case"saving":return"Saving";case"saved":return"Saved";case"offline":return"Offline";default:return""}}function getStateIcon(state){switch(state){case"saving":return _common.iconSaving;case"saved":return _common.iconSaved;case"offline":return _common.iconOffline;default:return""}}async function fetchSavedContent(e){e.preventDefault();const editorWrapper=document.querySelector("#tiny_cursive_savingState");(0,_ajax.call)([{methodname:"cursive_get_autosave_content",args:{id:cmid,cmid:cmid,modulename:`${modulename}_autosave`,questionid:questionid,userid:userid}}])[0].done((data=>{let context={comments:JSON.parse(data)};_templates.default.render("tiny_cursive/saved_content",context).then((html=>{editorWrapper.style.position="relative";const tempDiv=document.createElement("div");if(tempDiv.innerHTML=html.trim(),tempDiv.id="savedDropdown",tempDiv.classList.add("saved-dropdown"),!tempDiv)return void console.error("Saved content template rendered empty or invalid HTML.");let existingPanel=document.querySelector("#savedDropdown");existingPanel||(editorWrapper.appendChild(tempDiv),existingPanel=tempDiv),existingPanel.classList.toggle("active"),function(){const dropdown=document.querySelector("#savedDropdown");dropdown.classList.contains("show")?closeSavedDropdown():(document.querySelector("#savedDropdown").classList.add("show"),document.addEventListener("keydown",handleEscapeKey))}()})).catch((error=>window.console.error(error)))})).fail((()=>{}))}function closeSavedDropdown(){const dropdown=document.querySelector("#savedDropdown");dropdown.classList.remove("show"),dropdown.remove(),document.removeEventListener("keydown",handleEscapeKey)}function handleEscapeKey(event){"Escape"===event.key&&closeSavedDropdown()}function setTooltip(text,cursiveIcon,tooltipId){if(!document.querySelector(`#${tooltipId}`)&&cursiveIcon){const tooltipSpan=document.createElement("span"),description=document.createElement("span"),linebreak=document.createElement("br"),tooltipTitle=document.createElement("strong");tooltipSpan.style.display="none",tooltipTitle.textContent=text.buttonTitle,tooltipTitle.style.fontSize="16px",tooltipTitle.style.fontWeight="bold",description.textContent=text.buttonDes,description.style.fontSize="14px",tooltipSpan.id=tooltipId,tooltipSpan.classList.add("shadow"),tooltipSpan.appendChild(tooltipTitle),tooltipSpan.appendChild(linebreak),tooltipSpan.appendChild(description),cursiveIcon.appendChild(tooltipSpan)}}function getModulesInfo(ur,parm,MODULES){if(!MODULES.some((module=>ur.includes(module))))return!1;null===(resourceId=ur.includes("forum")&&!ur.includes("assign")?parm.searchParams.get("edit"):parm.searchParams.get("attempt"))&&(resourceId=0);for(const module of MODULES)if(ur.includes(module)){modulename=module,"lesson"===module||"assign"===module?resourceId=cmid:"oublog"===module&&(resourceId=0);break}return{resourceId:resourceId,name:modulename}}editor.on("keyUp",(editor=>{customTooltip();let position=getCaretPosition(!0);editor.caretPosition=position.caretPosition,editor.rePosition=position.rePosition,sendKeyEvent("keyUp",editor)})),editor.on("Paste",(async e=>{customTooltip();const pastedContent=(e.clipboardData||e.originalEvent.clipboardData).getData("text");if(pastedContent&&isStudent&&intervention&&pastedContent!==localStorage.getItem("lastCopyCutContent")){getModal(e),pastedContents=[],pastedContents.push(pastedContent);let position=getCaretPosition(!0);editor.caretPosition=position.caretPosition,editor.rePosition=position.rePosition,sendKeyEvent("Paste",{...e,key:"v",keyCode:86,caretPosition:editor.caretPosition,rePosition:editor.rePosition})}})),editor.on("Redo",(async e=>{customTooltip(),isStudent&&intervention&&getModal(e)})),editor.on("keyDown",(editor=>{customTooltip();let position=getCaretPosition();editor.caretPosition=position.caretPosition,editor.rePosition=position.rePosition,sendKeyEvent("keyDown",editor)})),editor.on("Cut",(()=>{const selectedContent=editor.selection.getContent({format:"text"});localStorage.setItem("lastCopyCutContent",selectedContent.trim())})),editor.on("Copy",(()=>{const selectedContent=editor.selection.getContent({format:"text"});localStorage.setItem("lastCopyCutContent",selectedContent.trim())})),editor.on("mouseDown",(async editor=>{constructMouseEvent(editor),sendKeyEvent("mouseDown",editor)})),editor.on("mouseUp",(async editor=>{constructMouseEvent(editor),sendKeyEvent("mouseUp",editor)})),editor.on("init",(()=>{customTooltip()})),editor.on("SetContent",(()=>{customTooltip()})),window.addEventListener("unload",(()=>{syncData()})),setInterval(syncData,syncInterval)}}));

//# sourceMappingURL=autosaver.min.js.map