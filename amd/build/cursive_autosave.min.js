define("tiny_cursive/cursive_autosave",["exports","tiny_cursive/common","core/templates","core/ajax","tiny_cursive/svg_repo"],(function(_exports,_common,_templates,_ajax,_svg_repo){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * TODO describe module cursive_autosave
   *
   * @module     tiny_cursive/cursive_autosave
   * @copyright  2025 Cursive Technology, Inc. <info@cursivetechnology.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_templates=_interopRequireDefault(_templates),_svg_repo=_interopRequireDefault(_svg_repo);class CursiveAutosave{static instance=null;constructor(editor,rightWrapper,modules,isFullScreen){if(CursiveAutosave.instance)return CursiveAutosave.instance;this.editor=editor,this.module=modules,this.savingState="",this.rightWrapper=rightWrapper,this.isFullScreen=isFullScreen,this.fetchSavedContent=this.fetchSavedContent.bind(this),this.handleEscapeKey=this.handleEscapeKey.bind(this),this._savingTimer=null,CursiveAutosave.instance=this}static getInstance(editor,rightWrapper,modules,isFullScreen){return this.instance||(this.instance=new CursiveAutosave(editor,rightWrapper,modules,isFullScreen)),this.isFullScreen=isFullScreen,document.querySelector("#tiny_cursive_savingState")||this.instance.init(),this.instance}init(){const stateWrapper=this.cursiveSavingState(this.savingState);stateWrapper.classList.add("tiny_cursive_savingState","btn"),stateWrapper.id="tiny_cursive_savingState",this.isFullScreen?this.rightWrapper.prepend(stateWrapper):this.rightWrapper.appendChild(stateWrapper),stateWrapper.addEventListener("click",this.fetchSavedContent)}destroy(){CursiveAutosave.instance=null}static destroyInstance(){this.instance&&(this.instance.destroy(),this.instance=null)}cursiveSavingState(state){let wrapperDiv=document.createElement("div"),icon=document.createElement("img"),textSpan=document.createElement("span"),button=document.createElement("button");return button.style.padding=".3rem",textSpan.style.fontSize="0.75rem",textSpan.style.color="gray",textSpan.id="CursiveStateText",state&&(textSpan.textContent=this.getStateText(state),icon.src=this.getStateIcon(state)),icon.style.width="20px",icon.style.height="20px",icon.style.marginRight="5px",icon.style.display="none",wrapperDiv.style.verticalAlign="middle",wrapperDiv.appendChild(icon),wrapperDiv.appendChild(textSpan),button.appendChild(wrapperDiv),button}static updateSavingState(state){const instance=this.instance;instance.savingState=state;let stateWrapper=document.querySelector(".tiny_cursive_savingState"),stateTextEl=document.getElementById("CursiveStateText");if(!stateWrapper)return;let img=stateWrapper.querySelector("img"),span=stateWrapper.querySelector("span");img.style.display="inline",span.textContent=instance.getStateText(state),img.src=instance.getStateIcon(state),instance._savingTimer&&clearTimeout(instance._savingTimer),"saved"===state&&stateTextEl&&(instance._savingTimer=setTimeout((()=>{stateTextEl.textContent=""}),5e3))}getStateText(state){switch(state){case"saving":return"saving";case"saved":return"saved";case"offline":return"offline";default:return""}}getStateIcon(state){switch(state){case"saving":case"saved":return _common.iconSaved;case"offline":return"data:image/svg+xml;base64,"+btoa(_svg_repo.default.offline);default:return""}}async fetchSavedContent(e){var _dropdown$classList;e.preventDefault();let dropdown=document.querySelector("#savedDropdown");if(null==dropdown||null===(_dropdown$classList=dropdown.classList)||void 0===_dropdown$classList?void 0:_dropdown$classList.contains("show"))return void this.closeSavedDropdown();const editorWrapper=document.querySelector("#tiny_cursive_savingState");let args={id:this.module.resourceId,cmid:this.module.cmid,modulename:`${this.module.modulename}_autosave`,questionid:this.module.questionid,userid:this.module.userid,courseid:this.module.courseid};(0,_ajax.call)([{methodname:"cursive_get_autosave_content",args:args}])[0].done((data=>{let context={comments:JSON.parse(data)};Object.values(context.comments).forEach((content=>{content.time=this.timeAgo(content.timemodified)})),this.renderCommentList(context,editorWrapper)})).fail((error=>{this.editor.windowManager.alert("You are currently offline. Saved content\n                                    cannot be retrieved until you are back online."),window.console.error("Error fetching saved content:",error)}))}toggleSavedDropdown(){var _dropdown$classList2;const dropdown=document.querySelector("#savedDropdown");(null==dropdown||null===(_dropdown$classList2=dropdown.classList)||void 0===_dropdown$classList2?void 0:_dropdown$classList2.contains("show"))?this.closeSavedDropdown():this.openSavedDropdown()}openSavedDropdown(){document.querySelector("#savedDropdown").classList.add("show"),document.addEventListener("keydown",this.handleEscapeKey)}closeSavedDropdown(){const dropdown=document.querySelector("#savedDropdown");dropdown.classList.remove("show"),dropdown.remove(),document.removeEventListener("keydown",this.handleEscapeKey)}handleEscapeKey(event){"Escape"===event.key&&this.closeSavedDropdown()}timeAgo(unixTime){const seconds=Math.floor(Date.now()/1e3)-unixTime;if(seconds<5)return"just now";if(seconds<60)return`${seconds} sec ago`;const minutes=Math.floor(seconds/60);if(minutes<60)return`${minutes} min ago`;const hours=Math.floor(minutes/60);if(hours<24)return`${hours} hour${hours>1?"s":""} ago`;const days=Math.floor(hours/24);if(days<7)return`${days} day${days>1?"s":""} ago`;const weeks=Math.floor(days/7);if(weeks<4)return`${weeks} week${weeks>1?"s":""} ago`;const months=Math.floor(days/30);if(months<12)return`${months} month${months>1?"s":""} ago`;const years=Math.floor(days/365);return`${years} year${years>1?"s":""} ago`}renderCommentList(context,editorWrapper){_templates.default.render("tiny_cursive/saved_content",context).then((html=>{editorWrapper.style.position="relative";const tempDiv=document.createElement("div");if(tempDiv.innerHTML=html.trim(),tempDiv.id="savedDropdown",tempDiv.classList.add("saved-dropdown"),!tempDiv)return window.console.error("Saved content template rendered empty or invalid HTML."),!1;let existingPanel=document.querySelector("#savedDropdown");return existingPanel||(editorWrapper.appendChild(tempDiv),existingPanel=tempDiv),existingPanel.classList.toggle("active"),this.toggleSavedDropdown(),this.insertSavedItems(this.editor),!0})).catch((error=>window.console.error(error)))}insertSavedItems(editor){document.querySelectorAll(".item-preview").forEach((element=>{element.addEventListener("click",(function(){editor.insertContent(" "+this.textContent)}))}))}}return _exports.default=CursiveAutosave,_exports.default}));

//# sourceMappingURL=cursive_autosave.min.js.map