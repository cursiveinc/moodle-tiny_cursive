{"version":3,"file":"append_oublogs_post.min.js","sources":["../src/append_oublogs_post.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module provides functionality to append blog posts in the OU Blogs plugin for TinyMCE editor\n *\n * @module     tiny_cursive/append_oublogs_post\n * @copyright  2025  CTI <info@cursivetechnology.com>\n * @author     Brain Station 23 <sales@brainstation-23.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from 'jquery';\nimport {call as getData} from 'core/ajax';\nimport templates from 'core/templates';\nimport AnalyticEvents from './analytic_events';\nimport analyticButton from './analytic_button';\nimport replayButton from './replay_button';\nimport replayModal from './replay_modal';\nimport Replay from './replay';\n\nexport const init = (scoreSetting, comments, hasApiKey) => {\n    const replayInstances = {};\n    // eslint-disable-next-line camelcase\n    window.video_playback = function(mid, filepath) {\n        if (filepath !== '') {\n            const replay = new Replay(\n                'content' + mid,\n                filepath,\n                10,\n                false,\n                'player_' + mid\n            );\n            replayInstances[mid] = replay;\n        } else {\n            templates.render('tiny_cursive/no_submission').then(html => {\n                $('#content' + mid).html(html);\n                return true;\n            }).catch(e => window.console.error(e));\n        }\n        return false;\n\n    };\n\n    const ouBlogPosts = $('.oublog-post');\n    const cmid = M.cfg.contextInstanceId;\n    ouBlogPosts.each(function() {\n\n        var Element = $(this);\n        var postedByLink = Element.find('.oublog-postedby a').attr('href');\n        var permalink = Element.find('.oublog-post-links a').attr('href');\n        var resourceId = parseInt(new URLSearchParams(permalink.split('?')[1]).get('post'));\n        var userid = parseInt(new URLSearchParams(postedByLink.split('?')[1]).get('id'));\n        var filepath = '';\n\n        if (userid && resourceId) {\n            let args = {id: userid, resourceid: resourceId, modulename: \"oublog\", cmid: cmid};\n            let methodname = 'cursive_get_oublog_submission_data';\n            let com = getData([{methodname, args}]);\n            com[0].done(function(json) {\n                var data = JSON.parse(json);\n\n                if (data.res.filename) {\n                    filepath = data.res.filename;\n                }\n\n                if (!hasApiKey) {\n                    Element.find('.oublog-post-links').append(replayButton(userid));\n\n                    $(document).off('click', '#replay' + userid).on('click', '#replay' + userid, function(e) {\n                        e.preventDefault();\n\n                        const context = {\n                            mid: userid\n                        };\n\n                        replayModal.create({templateContext: context}).then(modal => {\n                            modal.show();\n                            window.video_playback(userid, filepath);\n\n                            return modal;\n                        }).catch(error => {\n                            window.console.error('Failed to create replay modal:', error);\n                        });\n                    });\n\n                    return;\n                }\n\n                Element.find('.oublog-post-links').append(analyticButton(hasApiKey ? data.res.effort_ratio : \"\", userid));\n\n                let myEvents = new AnalyticEvents();\n                var context = {\n                    tabledata: data.res,\n                    formattime: myEvents.formatedTime(data.res),\n                    page: scoreSetting,\n                    userid: userid,\n                    apikey: hasApiKey\n                };\n\n                let authIcon = myEvents.authorshipStatus(data.res.first_file, data.res.score, scoreSetting);\n                myEvents.createModal(userid, context, '', replayInstances, authIcon);\n                myEvents.analytics(userid, templates, context, '', replayInstances, authIcon);\n                myEvents.checkDiff(userid, data.res.file_id, '', replayInstances);\n                myEvents.replyWriting(userid, filepath, '', replayInstances);\n\n            });\n            com[0].fail((error) => {\n                window.console.error(error);\n            });\n        }\n    });\n\n};"],"names":["scoreSetting","comments","hasApiKey","replayInstances","window","video_playback","mid","filepath","replay","Replay","render","then","html","catch","e","console","error","ouBlogPosts","cmid","M","cfg","contextInstanceId","each","Element","this","postedByLink","find","attr","permalink","resourceId","parseInt","URLSearchParams","split","get","userid","args","id","resourceid","modulename","methodname","com","done","json","data","JSON","parse","res","filename","append","document","off","on","preventDefault","context","create","templateContext","modal","show","effort_ratio","myEvents","AnalyticEvents","tabledata","formattime","formatedTime","page","apikey","authIcon","authorshipStatus","first_file","score","createModal","analytics","templates","checkDiff","file_id","replyWriting","fail"],"mappings":";;;;;;;;4bAiCoB,CAACA,aAAcC,SAAUC,mBACnCC,gBAAkB,GAExBC,OAAOC,eAAiB,SAASC,IAAKC,aACjB,KAAbA,SAAiB,OACXC,OAAS,IAAIC,gBACf,UAAYH,IACZC,SACA,IACA,EACA,UAAYD,KAEhBH,gBAAgBG,KAAOE,+BAEbE,OAAO,8BAA8BC,MAAKC,2BAC9C,WAAaN,KAAKM,KAAKA,OAClB,KACRC,OAAMC,GAAKV,OAAOW,QAAQC,MAAMF,YAEhC,SAILG,aAAc,mBAAE,gBAChBC,KAAOC,EAAEC,IAAIC,kBACnBJ,YAAYK,MAAK,eAETC,SAAU,mBAAEC,MACZC,aAAeF,QAAQG,KAAK,sBAAsBC,KAAK,QACvDC,UAAYL,QAAQG,KAAK,wBAAwBC,KAAK,QACtDE,WAAaC,SAAS,IAAIC,gBAAgBH,UAAUI,MAAM,KAAK,IAAIC,IAAI,SACvEC,OAASJ,SAAS,IAAIC,gBAAgBN,aAAaO,MAAM,KAAK,IAAIC,IAAI,OACtE1B,SAAW,MAEX2B,QAAUL,WAAY,KAClBM,KAAO,CAACC,GAAIF,OAAQG,WAAYR,WAAYS,WAAY,SAAUpB,KAAMA,MACxEqB,WAAa,qCACbC,KAAM,cAAQ,CAAC,CAACD,WAAAA,WAAYJ,KAAAA,QAChCK,IAAI,GAAGC,MAAK,SAASC,UACbC,KAAOC,KAAKC,MAAMH,SAElBC,KAAKG,IAAIC,WACTxC,SAAWoC,KAAKG,IAAIC,WAGnB7C,iBACDqB,QAAQG,KAAK,sBAAsBsB,QAAO,0BAAad,iCAErDe,UAAUC,IAAI,QAAS,UAAYhB,QAAQiB,GAAG,QAAS,UAAYjB,QAAQ,SAASpB,GAClFA,EAAEsC,uBAEIC,QAAU,CACZ/C,IAAK4B,8BAGGoB,OAAO,CAACC,gBAAiBF,UAAU1C,MAAK6C,QAChDA,MAAMC,OACNrD,OAAOC,eAAe6B,OAAQ3B,UAEvBiD,SACR3C,OAAMG,QACLZ,OAAOW,QAAQC,MAAM,iCAAkCA,aAOnEO,QAAQG,KAAK,sBAAsBsB,QAAO,4BAAe9C,UAAYyC,KAAKG,IAAIY,aAAe,GAAIxB,aAE7FyB,SAAW,IAAIC,6BACfP,QAAU,CACVQ,UAAWlB,KAAKG,IAChBgB,WAAYH,SAASI,aAAapB,KAAKG,KACvCkB,KAAMhE,aACNkC,OAAQA,OACR+B,OAAQ/D,eAGRgE,SAAWP,SAASQ,iBAAiBxB,KAAKG,IAAIsB,WAAYzB,KAAKG,IAAIuB,MAAOrE,cAC9E2D,SAASW,YAAYpC,OAAQmB,QAAS,GAAIlD,gBAAiB+D,UAC3DP,SAASY,UAAUrC,OAAQsC,mBAAWnB,QAAS,GAAIlD,gBAAiB+D,UACpEP,SAASc,UAAUvC,OAAQS,KAAKG,IAAI4B,QAAS,GAAIvE,iBACjDwD,SAASgB,aAAazC,OAAQ3B,SAAU,GAAIJ,oBAGhDqC,IAAI,GAAGoC,MAAM5D,QACTZ,OAAOW,QAAQC,MAAMA"}