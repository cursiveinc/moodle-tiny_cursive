{"version":3,"file":"analytic_events.min.js","sources":["../src/analytic_events.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module for handling analytics events in the Tiny Cursive plugin.\n * Provides functionality for displaying analytics data, replaying writing,\n * checking differences and showing quality metrics.\n *\n * @module     tiny_cursive/analytic_events\n * @copyright  2024 CTI <info@cursivetechnology.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport myModal from \"./analytic_modal\";\nimport {call as getContent} from \"core/ajax\";\nimport $ from 'jquery';\nimport {get_string as getString} from 'core/str';\nimport {get_strings as getStrings} from 'core/str';\n\nexport default class AnalyticEvents {\n\n    constructor() {\n        getString('notenoughtinfo', 'tiny_cursive').then(str => {\n            localStorage.setItem('notenoughtinfo', str);\n            return str;\n        });\n    }\n\n    createModal(userid, context, questionid = '', replayInstances = null, authIcon) {\n        $('#analytics' + userid + questionid).on('click', function(e) {\n            e.preventDefault();\n\n            // Create Moodle modal\n            myModal.create({templateContext: context}).then(modal => {\n                $('#content' + userid + ' .tiny_cursive_table  tbody tr:first-child td:nth-child(2)').html(authIcon);\n                modal.show();\n\n                let moreBtn = $('body #more' + userid + questionid);\n                if (moreBtn.length > 0) {\n                    $('.tiny_cursive-nav-tab').find('.active').removeClass('active');\n                    $('#analytic' + userid + questionid).prop('disabled', true);\n                    $('#diff' + userid + questionid).prop('disabled', true);\n                    $('#analytic' + userid + questionid).css({\n                            'background-color': 'rgba(168, 168, 168, 0.133)',\n                            'cursor': 'not-allowed'\n                        });\n                    $('#diff' + userid + questionid).css({\n                            'background-color': 'rgba(168, 168, 168, 0.133)',\n                            'cursor': 'not-allowed'\n                    });\n                    moreBtn.on('click', function() {\n                        $('.tiny_cursive-nav-tab').find('.active').removeClass('active');\n                        $(this).addClass('active');\n                        $('#rep' + userid + questionid).prop('disabled', false);\n                        if (replayInstances && replayInstances[userid]) {\n                            replayInstances[userid].stopReplay();\n                        }\n                    });\n                }\n\n                return true;\n            }).catch(error => {\n                window.console.error(\"Failed to create modal:\", error);\n            });\n\n        });\n    }\n\n    analytics(userid, templates, context, questionid = '', replayInstances = null, authIcon) {\n\n        $('body').on('click', '#analytic' + userid + questionid, function(e) {\n            $('#rep' + userid + questionid).prop('disabled', false);\n            $('#quality' + userid + questionid).prop('disabled', false);\n            $('#content' + userid).attr('data-label', 'analytics');\n            $('#player_' + userid + questionid).css({'display': 'none'});\n            $('#content' + userid).removeClass('tiny_cursive_outputElement')\n                                  .addClass('tiny_cursive').attr('data-label', 'analytics');\n            e.preventDefault();\n            $('#content' + userid).html($('<div>').addClass('d-flex justify-content-center my-5')\n                .append($('<div>').addClass('tiny_cursive-loader')));\n            if (replayInstances && replayInstances[userid]) {\n                replayInstances[userid].stopReplay();\n            }\n            $('.tiny_cursive-nav-tab').find('.active').removeClass('active');\n            $(this).addClass('active'); // Add 'active' class to the clicked element\n\n            templates.render('tiny_cursive/analytics_table', context).then(function(html) {\n                $('#content' + userid).html(html);\n                $('#content' + userid + ' .tiny_cursive_table  tbody tr:first-child td:nth-child(2)').html(authIcon);\n                return true;\n            }).fail(function(error) {\n                window.console.error(\"Failed to render template:\", error);\n            });\n        });\n    }\n\n    checkDiff(userid, fileid, questionid = '', replayInstances = null) {\n        const nodata = document.createElement('p');\n        nodata.classList.add('tiny_cursive_nopayload', 'bg-light');\n        getString('nopaylod', 'tiny_cursive').then(str => {\n            nodata.textContent = str;\n            return true;\n        }).catch(error => window.console.log(error));\n        $('body').on('click', '#diff' + userid + questionid, function(e) {\n            $('#rep' + userid + questionid).prop('disabled', false);\n            $('#quality' + userid + questionid).prop('disabled', false);\n            $('#content' + userid).attr('data-label', 'diff');\n            $('#player_' + userid + questionid).css({\n                'display': 'none'\n            });\n            $('#content' + userid).removeClass('tiny_cursive_outputElement').addClass('tiny_cursive').attr('data-label', 'diff');\n            e.preventDefault();\n            $('#content' + userid).html($('<div>').addClass('d-flex justify-content-center my-5')\n                .append($('<div>').addClass('tiny_cursive-loader')));\n            $('.tiny_cursive-nav-tab').find('.active').removeClass('active');\n            $(this).addClass('active');\n            if (replayInstances && replayInstances[userid]) {\n                replayInstances[userid].stopReplay();\n            }\n            if (!fileid) {\n                $('#content' + userid).html(nodata);\n                throw new Error('Missing file id or Difference Content not received yet');\n            }\n            getContent([{\n                methodname: 'cursive_get_writing_differences',\n                args: {fileid: fileid},\n            }])[0].done(response => {\n                let responsedata = JSON.parse(response.data);\n                if (responsedata) {\n                    let submittedText = atob(responsedata.submitted_text);\n\n                    // Fetch the dynamic strings.\n                    getStrings([\n                        {key: 'original_text', component: 'tiny_cursive'},\n                        {key: 'editspastesai', component: 'tiny_cursive'}\n                    ]).done(strings => {\n                        const originalTextString = strings[0];\n                        const editsPastesAIString = strings[1];\n\n                        const commentBox = $('<div class=\"p-2 border rounded mb-2\">');\n                        var pasteCountDiv = $('<div></div>');\n                        getString('pastecount', 'tiny_cursive').then(str => {\n                            pasteCountDiv.append('<div><strong>' + str + ' :</strong> ' + responsedata.commentscount + '</div>');\n                            return true;\n                        }).catch(error => window.console.log(error));\n\n                        var commentsDiv = $('<div class=\"border-bottom\"></div>');\n                        getString('comments', 'tiny_cursive').then(str => {\n                            commentsDiv.append('<strong>' + str + '</strong>');\n                            return true;\n                        }).catch(error => window.console.error(error));\n\n                        var commentsList = $('<div></div>');\n\n                        let comments = responsedata.comments;\n                        for (let index in comments) {\n                            var commentDiv = $(`<div style=\"word-wrap: break-word; word-break: break-word\"\n                                class=\"shadow-sm p-1 my-1\"></div>`).text(comments[index].usercomment);\n                            commentsList.append(commentDiv);\n                        }\n                        commentBox.append(pasteCountDiv).append(commentsDiv).append(commentsList);\n\n                        const $legend = $('<div class=\"d-flex p-2 border rounded mb-2\">');\n\n                        // Create the first legend item\n                        const $attributedItem = $('<div>', {\"class\": \"tiny_cursive-legend-item\"});\n                        const $attributedBox = $('<div>', {\"class\": \"tiny_cursive-box attributed\"});\n                        const $attributedText = $('<span>').text(originalTextString);\n                        $attributedItem.append($attributedBox).append($attributedText);\n\n                        // Create the second legend item\n                        const $unattributedItem = $('<div>', {\"class\": 'tiny_cursive-legend-item'});\n                        const $unattributedBox = $('<div>', {\"class\": 'tiny_cursive-box tiny_cursive_added'});\n                        const $unattributedText = $('<span>').text(editsPastesAIString);\n                        $unattributedItem.append($unattributedBox).append($unattributedText);\n\n                        // Append the legend items to the legend container.\n                        $legend.append($attributedItem).append($unattributedItem);\n\n                        let contents = $('<div>').addClass('tiny_cursive-comparison-content');\n                        let textBlock2 = $('<div>').addClass('tiny_cursive-text-block').append(\n                            $('<div>').attr('id', 'tiny_cursive-reconstructed_text').html(JSON.parse(submittedText))\n                        );\n\n                        contents.append(commentBox, $legend, textBlock2);\n                        $('#content' + userid).html(contents); // Update content.\n                    }).fail(error => {\n                        window.console.error(\"Failed to load language strings:\", error);\n                        $('#content' + userid).html(nodata);\n                    });\n                } else {\n                    $('#content' + userid).html(nodata);\n                }\n            }).fail(error => {\n                $('#content' + userid).html(nodata);\n                throw new Error('Error loading JSON file: ' + error.message);\n            });\n        });\n    }\n\n    replyWriting(userid, filepath, questionid = '', replayInstances = null) {\n        $('body').on('click', '#rep' + userid + questionid, function(e) {\n\n            if (filepath) {\n                $('#replayControls_' + userid + questionid).removeClass('d-none');\n                $('#content' + userid).addClass('tiny_cursive_outputElement');\n            }\n\n            $(this).prop('disabled', true);\n            $('#quality' + userid + questionid).prop('disabled', false);\n            $('#content' + userid).attr('data-label', 'replay');\n            $('#player_' + userid + questionid).css({\n                'display': 'block',\n                'padding-right': '8px'\n            });\n            e.preventDefault();\n            $('#content' + userid).html($('<div>').addClass('d-flex justify-content-center my-5')\n                .append($('<div>').addClass('tiny_cursive-loader')));\n            $('.tiny_cursive-nav-tab').find('.active').removeClass('active');\n            $(this).addClass('active'); // Add 'active' class to the clicked element\n            if (replayInstances && replayInstances[userid]) {\n                replayInstances[userid].stopReplay();\n            }\n            if (questionid) {\n                // eslint-disable-next-line\n                video_playback(userid, filepath, questionid);\n            } else {\n                // eslint-disable-next-line\n                video_playback(userid, filepath);\n            }\n        });\n    }\n\n    formatedTime(data) {\n        if (data.total_time_seconds) {\n            let totalTimeSeconds = data.total_time_seconds;\n            let hours = Math.floor(totalTimeSeconds / 3600).toString().padStart(2, 0);\n            let minutes = Math.floor((totalTimeSeconds % 3600) / 60).toString().padStart(2, 0);\n            let seconds = (totalTimeSeconds % 60).toString().padStart(2, 0);\n            return `${hours}h ${minutes}m ${seconds}s`;\n        } else {\n            return \"0h 0m 0s\";\n        }\n    }\n\n    authorshipStatus(firstFile, score, scoreSetting) {\n        var icon = 'fa fa-circle-o';\n        var color = 'font-size:32px;color:black';\n        score = parseFloat(score);\n\n        if (firstFile) {\n            icon = 'fa fa-solid fa-info-circle';\n            color = 'font-size:32px;color:#000000';\n        } else if (score >= scoreSetting) {\n            icon = 'fa fa-check-circle';\n            color = 'font-size:32px;color:green';\n        }\n        if (score < scoreSetting) {\n            icon = 'fa fa-question-circle';\n            color = 'font-size:32px;color:#A9A9A9';\n            return $('<i>').addClass(icon).attr('style', color).attr('title', localStorage.getItem('notenoughtinfo'));\n        } else {\n            return $('<i>').addClass(icon).attr('style', color);\n        }\n\n    }\n}\n"],"names":["constructor","then","str","localStorage","setItem","createModal","userid","context","questionid","replayInstances","authIcon","on","e","preventDefault","create","templateContext","modal","html","show","moreBtn","length","find","removeClass","prop","css","this","addClass","stopReplay","catch","error","window","console","analytics","templates","attr","append","render","fail","checkDiff","fileid","nodata","document","createElement","classList","add","textContent","log","Error","methodname","args","done","response","responsedata","JSON","parse","data","submittedText","atob","submitted_text","key","component","strings","originalTextString","editsPastesAIString","commentBox","pasteCountDiv","commentscount","commentsDiv","commentsList","comments","index","commentDiv","text","usercomment","$legend","$attributedItem","$attributedBox","$attributedText","$unattributedItem","$unattributedBox","$unattributedText","contents","textBlock2","message","replyWriting","filepath","video_playback","formatedTime","total_time_seconds","totalTimeSeconds","hours","Math","floor","toString","padStart","minutes","seconds","authorshipStatus","firstFile","score","scoreSetting","icon","color","parseFloat","getItem"],"mappings":"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"}