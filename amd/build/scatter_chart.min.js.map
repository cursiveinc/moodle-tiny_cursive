{"version":3,"file":"scatter_chart.min.js","sources":["../src/scatter_chart.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * A module that creates a scatter chart to visualize student effort data using Chart.js.\n * The chart displays effort scores against time spent, with tooltips showing additional metrics.\n *\n * @module     tiny_cursive/scatter_chart\n * @copyright  2025 Cursive Technology, Inc. <info@cursivetechnology.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Chart from 'core/chartjs';\nimport {get_strings as getStrings} from 'core/str';\nexport const init = async(data, apiKey, caption) => {\n\n    const ctx = document.getElementById('effortScatterChart').getContext('2d');\n    if (data) {\n        data = JSON.parse(document.getElementById('scatter-chart-data').dataset.data);\n    }\n\n    let display = true;\n    let isEmpty = \"\";\n    var dataset = [];\n\n    const [\n        applyFilter,\n        noSubmission,\n        noPayload,\n        freemium,\n        time,\n        words,\n        effortratio,\n        wpm,\n        effortscore,\n        timespent,\n    ] = await getStrings([\n        {key: 'apply_filter', component: 'tiny_cursive'},\n        {key: 'no_submission', component: 'tiny_cursive'},\n        {key: 'nopaylod', component: 'tiny_cursive'},\n        {key: 'freemium', component: 'tiny_cursive'},\n        {key: 'time', component: 'tiny_cursive'},\n        {key: 'words', component: 'tiny_cursive'},\n        {key: 'effort_ratio', component: 'tiny_cursive'},\n        {key: 'wpm', component: 'tiny_cursive'},\n        {key: 'effort_score', component: 'tiny_cursive'},\n        {key: 'timespent', component: 'tiny_cursive'},\n    ]);\n\n    if (Array.isArray(data) && !data.state && apiKey) {\n        dataset = data;\n        isEmpty = data.some(ds =>\n            Array.isArray(ds.data) &&\n            ds.data.some(point =>\n                point && typeof point === 'object' && Object.keys(point).length > 0\n            )\n        );\n    }\n\n    if (!apiKey || data.length === 0 || !isEmpty || data === false) {\n        display = false;\n    }\n\n    const fallbackMessagePlugin = {\n        id: 'fallbackMessagePlugin',\n        afterDraw(chart) {\n            // ⚠ Case 1: Freemium user\n            if (!apiKey) {\n                drawMessage('⚠ ' + freemium, chart);\n                return;\n            }\n            // ⚠ Case 2: Apply filter (data is empty array)\n            if (data.state == \"apply_filter\") {\n                drawMessage('⚠ ' + applyFilter, chart);\n                return;\n            }\n            if (data.state === \"no_submission\") {\n                drawMessage('⚠ ' + noSubmission, chart);\n                return;\n            }\n            // ⚠ Case 3: No payload data (all `data` arrays are empty or full of empty objects)\n            if (!isEmpty && !data.state) {\n                drawMessage('⚠ ' + noPayload, chart);\n            }\n\n        }\n    };\n\n    new Chart(ctx, {\n        type: 'scatter',\n        data: {\n            datasets: dataset,\n        },\n        options: {\n            plugins: {\n                title: {\n                    display: display,\n                    text: caption,\n                    font: {\n                        size: 16,\n                        weight: 'bold',\n                    },\n                    color: '#333',\n                    padding: {\n                        top: 10,\n                        bottom: 20\n                    },\n                    align: 'center'\n                },\n                legend: {\n                    display: true,\n                    position: 'bottom',\n                    labels: {\n                        usePointStyle: true,\n                        pointStyle: 'circle',\n                        padding: 20\n                    }\n                },\n                tooltip: {\n                    backgroundColor: 'rgba(252, 252, 252, 0.8)',\n                    titleColor: '#000',\n                    bodyColor: '#000',\n                    borderColor: '#cccccc',\n                    borderWidth: 1,\n                    displayColors: false,\n                    callbacks: {\n                        title: function(context) {\n                            const d = context[0].raw;\n                            return d.label; // This appears as bold title.\n                        },\n                        label: function(context) {\n                            const d = context.raw;\n                            return [\n                                `${time}: ${formatTime(d.x)}`,\n                                `${effortratio}: ${Math.round(d.effort * 100 * 100) / 100}%`,\n                                `${words}: ${d.words}`,\n                                `${wpm}: ${d.wpm}`\n                            ];\n                        }\n                    }\n                }\n            },\n            scales: {\n                x: {\n                    title: {\n                        display: true,\n                        text: timespent\n                    },\n                    min: 0,\n                    ticks: {\n                        callback: function(value) {\n                            return formatTime(value);\n                        }\n                    }\n                },\n                y: {\n                    title: {\n                        display: true,\n                        text: effortscore\n                    },\n                    min: 0,\n                    ticks: {\n                        stepSize: 0.5\n                    }\n                }\n            }\n        },\n        plugins: [fallbackMessagePlugin]\n    });\n\n    /**\n     * Formats a time value in seconds to a mm:ss string format\n     * @param {number} value - The time value in seconds\n     * @returns {string} The formatted time string in mm:ss format\n     */\n    function formatTime(value) {\n        const minutes = Math.floor(value / 60);\n        const seconds = value % 60;\n        return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;\n    }\n\n    /**\n     * Draws a message on the chart canvas\n     * @param {string} text - The message to be displayed\n     * @param {Chart} chart - The Chart.js chart object\n     */\n    function drawMessage(text, chart) {\n\n        const {ctx, chartArea: {left, right, top, bottom}} = chart;\n        ctx.save();\n        ctx.textAlign = 'center';\n        ctx.textBaseline = 'middle';\n        ctx.font = 'bold 16px \"Segoe UI\", Arial';\n        ctx.fillStyle = '#666';\n\n        const centerX = (left + right) / 2;\n        const centerY = (top + bottom) / 2;\n\n        ctx.fillText(text, centerX, centerY);\n        ctx.restore();\n    }\n};"],"names":["async","data","apiKey","caption","ctx","document","getElementById","getContext","JSON","parse","dataset","display","isEmpty","applyFilter","noSubmission","noPayload","freemium","time","words","effortratio","wpm","effortscore","timespent","key","component","Array","isArray","state","some","ds","point","Object","keys","length","fallbackMessagePlugin","id","afterDraw","chart","drawMessage","formatTime","value","minutes","Math","floor","seconds","String","padStart","text","chartArea","left","right","top","bottom","save","textAlign","textBaseline","font","fillStyle","centerX","centerY","fillText","restore","Chart","type","datasets","options","plugins","title","size","weight","color","padding","align","legend","position","labels","usePointStyle","pointStyle","tooltip","backgroundColor","titleColor","bodyColor","borderColor","borderWidth","displayColors","callbacks","context","raw","label","d","x","round","effort","scales","min","ticks","callback","y","stepSize"],"mappings":";;;;;;;;0JA0BoBA,MAAMC,KAAMC,OAAQC,iBAE9BC,IAAMC,SAASC,eAAe,sBAAsBC,WAAW,MACjEN,OACAA,KAAOO,KAAKC,MAAMJ,SAASC,eAAe,sBAAsBI,QAAQT,WAGxEU,SAAU,EACVC,QAAU,OACVF,QAAU,SAGVG,YACAC,aACAC,UACAC,SACAC,KACAC,MACAC,YACAC,IACAC,YACAC,iBACM,oBAAW,CACjB,CAACC,IAAK,eAAgBC,UAAW,gBACjC,CAACD,IAAK,gBAAiBC,UAAW,gBAClC,CAACD,IAAK,WAAYC,UAAW,gBAC7B,CAACD,IAAK,WAAYC,UAAW,gBAC7B,CAACD,IAAK,OAAQC,UAAW,gBACzB,CAACD,IAAK,QAASC,UAAW,gBAC1B,CAACD,IAAK,eAAgBC,UAAW,gBACjC,CAACD,IAAK,MAAOC,UAAW,gBACxB,CAACD,IAAK,eAAgBC,UAAW,gBACjC,CAACD,IAAK,YAAaC,UAAW,kBAG9BC,MAAMC,QAAQzB,QAAUA,KAAK0B,OAASzB,SACtCQ,QAAUT,KACVW,QAAUX,KAAK2B,MAAKC,IAChBJ,MAAMC,QAAQG,GAAG5B,OACjB4B,GAAG5B,KAAK2B,MAAKE,OACTA,OAA0B,iBAAVA,OAAsBC,OAAOC,KAAKF,OAAOG,OAAS,OAKzE/B,QAA0B,IAAhBD,KAAKgC,QAAiBrB,UAAoB,IAATX,OAC5CU,SAAU,SAGRuB,sBAAwB,CAC1BC,GAAI,wBACJC,UAAUC,OAEDnC,OAKa,gBAAdD,KAAK0B,MAIU,kBAAf1B,KAAK0B,MAKJf,SAAYX,KAAK0B,OAClBW,YAAY,KAAOvB,UAAWsB,OAL9BC,YAAY,KAAOxB,aAAcuB,OAJjCC,YAAY,KAAOzB,YAAawB,OALhCC,YAAY,KAAOtB,SAAUqB,kBA2GhCE,WAAWC,aACVC,QAAUC,KAAKC,MAAMH,MAAQ,IAC7BI,QAAUJ,MAAQ,SAChB,GAAEK,OAAOJ,SAASK,SAAS,EAAG,QAAQD,OAAOD,SAASE,SAAS,EAAG,gBAQrER,YAAYS,KAAMV,aAEjBjC,IAACA,IAAK4C,WAAWC,KAACA,KAADC,MAAOA,MAAPC,IAAcA,IAAdC,OAAmBA,SAAWf,MACrDjC,IAAIiD,OACJjD,IAAIkD,UAAY,SAChBlD,IAAImD,aAAe,SACnBnD,IAAIoD,KAAO,8BACXpD,IAAIqD,UAAY,aAEVC,SAAWT,KAAOC,OAAS,EAC3BS,SAAWR,IAAMC,QAAU,EAEjChD,IAAIwD,SAASb,KAAMW,QAASC,SAC5BvD,IAAIyD,cA/GJC,iBAAM1D,IAAK,CACX2D,KAAM,UACN9D,KAAM,CACF+D,SAAUtD,SAEduD,QAAS,CACLC,QAAS,CACLC,MAAO,CACHxD,QAASA,QACToC,KAAM5C,QACNqD,KAAM,CACFY,KAAM,GACNC,OAAQ,QAEZC,MAAO,OACPC,QAAS,CACLpB,IAAK,GACLC,OAAQ,IAEZoB,MAAO,UAEXC,OAAQ,CACJ9D,SAAS,EACT+D,SAAU,SACVC,OAAQ,CACJC,eAAe,EACfC,WAAY,SACZN,QAAS,KAGjBO,QAAS,CACLC,gBAAiB,2BACjBC,WAAY,OACZC,UAAW,OACXC,YAAa,UACbC,YAAa,EACbC,eAAe,EACfC,UAAW,CACPlB,MAAO,SAASmB,gBACFA,QAAQ,GAAGC,IACZC,OAEbA,MAAO,SAASF,eACNG,EAAIH,QAAQC,UACX,CACF,GAAEtE,SAASsB,WAAWkD,EAAEC,KACxB,GAAEvE,gBAAgBuB,KAAKiD,MAAiB,IAAXF,EAAEG,OAAe,KAAO,OACrD,GAAE1E,UAAUuE,EAAEvE,QACd,GAAEE,QAAQqE,EAAErE,WAMjCyE,OAAQ,CACJH,EAAG,CACCvB,MAAO,CACHxD,SAAS,EACToC,KAAMzB,WAEVwE,IAAK,EACLC,MAAO,CACHC,SAAU,SAASxD,cACRD,WAAWC,UAI9ByD,EAAG,CACC9B,MAAO,CACHxD,SAAS,EACToC,KAAM1B,aAEVyE,IAAK,EACLC,MAAO,CACHG,SAAU,OAK1BhC,QAAS,CAAChC"}