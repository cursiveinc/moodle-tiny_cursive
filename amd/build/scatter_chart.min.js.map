{"version":3,"file":"scatter_chart.min.js","sources":["../src/scatter_chart.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * A module that creates a scatter chart to visualize student effort data using Chart.js.\r\n * The chart displays effort scores against time spent, with tooltips showing additional metrics.\r\n *\r\n * @module     tiny_cursive/scatter_chart\r\n * @copyright  2025 Cursive Technology, Inc. <info@cursivetechnology.com>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport Chart from 'core/chartjs';\r\nimport {get_strings as getStrings} from 'core/str';\r\nexport const init = async(data, apiKey, caption) => {\r\n\r\n    const ctx = document.getElementById('effortScatterChart').getContext('2d');\r\n    if (data) {\r\n        data = JSON.parse(document.getElementById('scatter-chart-data').dataset.data);\r\n    }\r\n\r\n    let display = true;\r\n    let isEmpty = \"\";\r\n    var dataset = [];\r\n\r\n    const [\r\n        applyFilter,\r\n        noSubmission,\r\n        noPayload,\r\n        freemium,\r\n    ] = await getStrings([\r\n        {key: 'apply_filter', component: 'tiny_cursive'},\r\n        {key: 'no_submission', component: 'tiny_cursive'},\r\n        {key: 'nopaylod', component: 'tiny_cursive'},\r\n        {key: 'freemium', component: 'tiny_cursive'},\r\n        {key: 'chart_result', component: 'tiny_cursive'}\r\n    ]);\r\n\r\n    if (Array.isArray(data) && !data.state && apiKey) {\r\n        dataset = data;\r\n        isEmpty = data.some(ds =>\r\n            Array.isArray(ds.data) &&\r\n            ds.data.some(point =>\r\n                point && typeof point === 'object' && Object.keys(point).length > 0\r\n            )\r\n        );\r\n    }\r\n\r\n    if (!apiKey || data.length === 0 || !isEmpty || data === false) {\r\n        display = false;\r\n    }\r\n\r\n    const fallbackMessagePlugin = {\r\n        id: 'fallbackMessagePlugin',\r\n        afterDraw(chart) {\r\n            // ⚠ Case 1: Freemium user\r\n            if (!apiKey) {\r\n                drawMessage('⚠ ' + freemium, chart);\r\n                return;\r\n            }\r\n            // ⚠ Case 2: Apply filter (data is empty array)\r\n            if (data.state == \"apply_filter\") {\r\n                drawMessage('⚠ ' + applyFilter, chart);\r\n                return;\r\n            }\r\n            if (data.state === \"no_submission\") {\r\n                drawMessage('⚠ ' + noSubmission, chart);\r\n                return;\r\n            }\r\n            // ⚠ Case 3: No payload data (all `data` arrays are empty or full of empty objects)\r\n            if (!isEmpty && !data.state) {\r\n                drawMessage('⚠ ' + noPayload, chart);\r\n            }\r\n\r\n        }\r\n    };\r\n\r\n    new Chart(ctx, {\r\n        type: 'scatter',\r\n        data: {\r\n            datasets: dataset,\r\n        },\r\n        options: {\r\n            plugins: {\r\n                title: {\r\n                    display: display,\r\n                    text: caption,\r\n                    font: {\r\n                        size: 16,\r\n                        weight: 'bold',\r\n                    },\r\n                    color: '#333',\r\n                    padding: {\r\n                        top: 10,\r\n                        bottom: 20\r\n                    },\r\n                    align: 'center'\r\n                },\r\n                legend: {\r\n                    display: true,\r\n                    position: 'bottom',\r\n                    labels: {\r\n                        usePointStyle: true,\r\n                        pointStyle: 'circle',\r\n                        padding: 20\r\n                    }\r\n                },\r\n                tooltip: {\r\n                    backgroundColor: 'rgba(252, 252, 252, 0.8)',\r\n                    titleColor: '#000',\r\n                    bodyColor: '#000',\r\n                    borderColor: '#cccccc',\r\n                    borderWidth: 1,\r\n                    displayColors: false,\r\n                    callbacks: {\r\n                        title: function(context) {\r\n                            const d = context[0].raw;\r\n                            return d.label; // This appears as bold title.\r\n                        },\r\n                        label: function(context) {\r\n                            const d = context.raw;\r\n                            return [\r\n                                `Time: ${formatTime(d.x)}`,\r\n                                `Effort: ${Math.round(d.effort * 100 * 100) / 100}%`,\r\n                                `Words: ${d.words}`,\r\n                                `WPM: ${d.wpm}`\r\n                            ];\r\n                        }\r\n                    }\r\n                }\r\n            },\r\n            scales: {\r\n                x: {\r\n                    title: {\r\n                        display: true,\r\n                        text: 'Time Spent (mm:ss)'\r\n                    },\r\n                    min: 0,\r\n                    ticks: {\r\n                        callback: function(value) {\r\n                            return formatTime(value);\r\n                        }\r\n                    }\r\n                },\r\n                y: {\r\n                    title: {\r\n                        display: true,\r\n                        text: 'Effort Score'\r\n                    },\r\n                    min: 0,\r\n                    ticks: {\r\n                        stepSize: 0.5\r\n                    }\r\n                }\r\n            }\r\n        },\r\n        plugins: [fallbackMessagePlugin]\r\n    });\r\n\r\n    /**\r\n     * Formats a time value in seconds to a mm:ss string format\r\n     * @param {number} value - The time value in seconds\r\n     * @returns {string} The formatted time string in mm:ss format\r\n     */\r\n    function formatTime(value) {\r\n        const minutes = Math.floor(value / 60);\r\n        const seconds = value % 60;\r\n        return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;\r\n    }\r\n\r\n    /**\r\n     * Draws a message on the chart canvas\r\n     * @param {string} text - The message to be displayed\r\n     * @param {Chart} chart - The Chart.js chart object\r\n     */\r\n    function drawMessage(text, chart) {\r\n\r\n        const {ctx, chartArea: {left, right, top, bottom}} = chart;\r\n        ctx.save();\r\n        ctx.textAlign = 'center';\r\n        ctx.textBaseline = 'middle';\r\n        ctx.font = 'bold 16px \"Segoe UI\", Arial';\r\n        ctx.fillStyle = '#666';\r\n\r\n        const centerX = (left + right) / 2;\r\n        const centerY = (top + bottom) / 2;\r\n\r\n        ctx.fillText(text, centerX, centerY);\r\n        ctx.restore();\r\n    }\r\n};"],"names":["async","data","apiKey","caption","ctx","document","getElementById","getContext","JSON","parse","dataset","display","isEmpty","applyFilter","noSubmission","noPayload","freemium","key","component","Array","isArray","state","some","ds","point","Object","keys","length","fallbackMessagePlugin","id","afterDraw","chart","drawMessage","formatTime","value","minutes","Math","floor","seconds","String","padStart","text","chartArea","left","right","top","bottom","save","textAlign","textBaseline","font","fillStyle","centerX","centerY","fillText","restore","Chart","type","datasets","options","plugins","title","size","weight","color","padding","align","legend","position","labels","usePointStyle","pointStyle","tooltip","backgroundColor","titleColor","bodyColor","borderColor","borderWidth","displayColors","callbacks","context","raw","label","d","x","round","effort","words","wpm","scales","min","ticks","callback","y","stepSize"],"mappings":";;;;;;;;0JA0BoBA,MAAMC,KAAMC,OAAQC,iBAE9BC,IAAMC,SAASC,eAAe,sBAAsBC,WAAW,MACjEN,OACAA,KAAOO,KAAKC,MAAMJ,SAASC,eAAe,sBAAsBI,QAAQT,WAGxEU,SAAU,EACVC,QAAU,OACVF,QAAU,SAGVG,YACAC,aACAC,UACAC,gBACM,oBAAW,CACjB,CAACC,IAAK,eAAgBC,UAAW,gBACjC,CAACD,IAAK,gBAAiBC,UAAW,gBAClC,CAACD,IAAK,WAAYC,UAAW,gBAC7B,CAACD,IAAK,WAAYC,UAAW,gBAC7B,CAACD,IAAK,eAAgBC,UAAW,kBAGjCC,MAAMC,QAAQnB,QAAUA,KAAKoB,OAASnB,SACtCQ,QAAUT,KACVW,QAAUX,KAAKqB,MAAKC,IAChBJ,MAAMC,QAAQG,GAAGtB,OACjBsB,GAAGtB,KAAKqB,MAAKE,OACTA,OAA0B,iBAAVA,OAAsBC,OAAOC,KAAKF,OAAOG,OAAS,OAKzEzB,QAA0B,IAAhBD,KAAK0B,QAAiBf,UAAoB,IAATX,OAC5CU,SAAU,SAGRiB,sBAAwB,CAC1BC,GAAI,wBACJC,UAAUC,OAED7B,OAKa,gBAAdD,KAAKoB,MAIU,kBAAfpB,KAAKoB,MAKJT,SAAYX,KAAKoB,OAClBW,YAAY,KAAOjB,UAAWgB,OAL9BC,YAAY,KAAOlB,aAAciB,OAJjCC,YAAY,KAAOnB,YAAakB,OALhCC,YAAY,KAAOhB,SAAUe,kBA2GhCE,WAAWC,aACVC,QAAUC,KAAKC,MAAMH,MAAQ,IAC7BI,QAAUJ,MAAQ,SAChB,GAAEK,OAAOJ,SAASK,SAAS,EAAG,QAAQD,OAAOD,SAASE,SAAS,EAAG,gBAQrER,YAAYS,KAAMV,aAEjB3B,IAACA,IAAKsC,WAAWC,KAACA,KAADC,MAAOA,MAAPC,IAAcA,IAAdC,OAAmBA,SAAWf,MACrD3B,IAAI2C,OACJ3C,IAAI4C,UAAY,SAChB5C,IAAI6C,aAAe,SACnB7C,IAAI8C,KAAO,8BACX9C,IAAI+C,UAAY,aAEVC,SAAWT,KAAOC,OAAS,EAC3BS,SAAWR,IAAMC,QAAU,EAEjC1C,IAAIkD,SAASb,KAAMW,QAASC,SAC5BjD,IAAImD,cA/GJC,iBAAMpD,IAAK,CACXqD,KAAM,UACNxD,KAAM,CACFyD,SAAUhD,SAEdiD,QAAS,CACLC,QAAS,CACLC,MAAO,CACHlD,QAASA,QACT8B,KAAMtC,QACN+C,KAAM,CACFY,KAAM,GACNC,OAAQ,QAEZC,MAAO,OACPC,QAAS,CACLpB,IAAK,GACLC,OAAQ,IAEZoB,MAAO,UAEXC,OAAQ,CACJxD,SAAS,EACTyD,SAAU,SACVC,OAAQ,CACJC,eAAe,EACfC,WAAY,SACZN,QAAS,KAGjBO,QAAS,CACLC,gBAAiB,2BACjBC,WAAY,OACZC,UAAW,OACXC,YAAa,UACbC,YAAa,EACbC,eAAe,EACfC,UAAW,CACPlB,MAAO,SAASmB,gBACFA,QAAQ,GAAGC,IACZC,OAEbA,MAAO,SAASF,eACNG,EAAIH,QAAQC,UACX,CACF,SAAQhD,WAAWkD,EAAEC,KACrB,WAAUhD,KAAKiD,MAAiB,IAAXF,EAAEG,OAAe,KAAO,OAC7C,UAASH,EAAEI,QACX,QAAOJ,EAAEK,WAM9BC,OAAQ,CACJL,EAAG,CACCvB,MAAO,CACHlD,SAAS,EACT8B,KAAM,sBAEViD,IAAK,EACLC,MAAO,CACHC,SAAU,SAAS1D,cACRD,WAAWC,UAI9B2D,EAAG,CACChC,MAAO,CACHlD,SAAS,EACT8B,KAAM,gBAEViD,IAAK,EACLC,MAAO,CACHG,SAAU,OAK1BlC,QAAS,CAAChC"}