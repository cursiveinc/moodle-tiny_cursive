{"version":3,"file":"append_pdfannotator.min.js","sources":["../src/append_pdfannotator.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Module for handling PDF annotator functionality,\r\n *\r\n * @module     tiny_cursive/append_pdfannotator\r\n * @copyright  2025 Cursive Technology, Inc. <info@cursivetechnology.com>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport {call} from 'core/ajax';\r\nimport analyticButton from 'tiny_cursive/analytic_button';\r\nimport replayButton from 'tiny_cursive/replay_button';\r\nimport AnalyticEvents from 'tiny_cursive/analytic_events';\r\nimport templates from 'core/templates';\r\nimport Replay from 'tiny_cursive/replay';\r\nexport const init = (scoreSetting, comments, hasApiKey, userid) => {\r\n    const replayInstances = {};\r\n    // eslint-disable-next-line camelcase\r\n    window.video_playback = function(mid, filepath) {\r\n        if (filepath !== '') {\r\n            const replay = new Replay(\r\n                'content' + mid,\r\n                filepath,\r\n                10,\r\n                false,\r\n                'player_' + mid\r\n            );\r\n            replayInstances[mid] = replay;\r\n        } else {\r\n            templates.render('tiny_cursive/no_submission').then(html => {\r\n                document.getElementById('content' + mid).innerHTML = html;\r\n                return true;\r\n            }).catch(e => window.console.error(e));\r\n        }\r\n        return false;\r\n    };\r\n\r\n    let container = document.querySelector('.comment-list-container');\r\n    const overviewTable = document.querySelector('table[id^=\"mod-pdfannotator-\"]');\r\n\r\n    document.addEventListener('click', handleSubmit);\r\n    const moduleName = document.body.id.split('-')[2];\r\n    var pendingSubmit = false;\r\n    var buttonElement = \"\";\r\n\r\n    if (container) {\r\n        const observer = new MutationObserver(() => {\r\n            if (container?.lastChild?.id) {\r\n                extractResourceId(container.lastChild.id);\r\n            }\r\n        });\r\n\r\n        observer.observe(container, {\r\n            subtree: true,\r\n            childList: true\r\n        });\r\n    }\r\n\r\n    if (overviewTable) {\r\n        let newChild = document.createElement('th');\r\n        newChild.textContent = 'Analytics';\r\n        let header = overviewTable.querySelector('thead>tr>th:first-child');\r\n        header.insertAdjacentElement('afterend', newChild);\r\n        setReplayButton(overviewTable);\r\n    }\r\n\r\n    /**\r\n     * Sets up replay buttons and analytics for each row in the overview table\r\n     * @param {HTMLTableElement} overviewTable - The table element containing the overview data\r\n     * @description This function:\r\n     * 1. Gets all rows from the table\r\n     * 2. For each row:\r\n     *    - Extracts comment ID and user ID from relevant links\r\n     *    - Adds analytics column with replay/analytics buttons\r\n     *    - Sets up cursive analytics functionality\r\n     */\r\n    function setReplayButton(overviewTable) {\r\n        const rows = overviewTable.querySelectorAll('tbody > tr');\r\n        const action = new URL(window.location.href).searchParams.get('action');\r\n\r\n        rows.forEach(row => {\r\n            const cols = {\r\n                col1: row.querySelector('td:nth-child(1)'),\r\n                col2: row.querySelector('td:nth-child(2)'),\r\n                col3: row.querySelector('td:nth-child(3)')\r\n            };\r\n\r\n            const links = {\r\n                link1: cols.col1?.querySelector('a'),\r\n                link2: cols.col2?.querySelector('a'),\r\n                link3: cols.col3?.querySelector('a')\r\n            };\r\n\r\n            // Extract comment ID safely\r\n            const commentId = links.link1?.href ?\r\n                new URL(links.link1.href).searchParams.get('commid') : null;\r\n            const cmid = links.link1?.href ?\r\n                new URL(links.link1.href).searchParams.get('id') : M.cfg.contextInstanceId;\r\n            // Extract user ID based on action\r\n            let userId = null;\r\n            let userLink = null;\r\n\r\n            switch (action) {\r\n                case 'overviewquestions':\r\n                    userLink = links.link2;\r\n                    break;\r\n                case 'overviewanswers':\r\n                    userLink = links.link3;\r\n                    break;\r\n                default:\r\n                    userId = userid;\r\n            }\r\n\r\n            if (userLink?.href) {\r\n                try {\r\n                    userId = new URL(userLink.href).searchParams.get('id');\r\n                } catch (e) {\r\n                    window.console.warn('Error parsing user URL:', e);\r\n                }\r\n            }\r\n\r\n            getCursiveAnalytics(userId, commentId, cmid, cols.col1);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Handles the submission and cancellation of comments\r\n     * @param {Event} e - The click event object\r\n     * @description When comment is submitted or cancelled:\r\n     * - Removes 'isEditing' flag from localStorage\r\n     * - Sets pendingSubmit flag appropriately (true for submit, false for cancel)\r\n     */\r\n    function handleSubmit(e) {\r\n        if (e.target.id === 'commentSubmit') {\r\n            localStorage.removeItem('isEditing');\r\n            buttonElement = e.target.value;\r\n            pendingSubmit = true;\r\n        }\r\n        if (e.target.id === 'commentCancel') {\r\n            localStorage.removeItem('isEditing');\r\n            pendingSubmit = false;\r\n        }\r\n    }\r\n\r\n    const updateEntries = async(methodname, args) => {\r\n        try {\r\n            const response = await call([{\r\n                methodname,\r\n                args,\r\n            }])[0];\r\n            return response;\r\n        } catch (error) {\r\n            window.console.error('updating Entries:', error);\r\n            throw error;\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Extracts the resource ID from a comment ID and updates entries if submission is pending\r\n     * @param {string} id - The ID string to extract resource ID from, expected format: 'prefix_number'\r\n     * @description This function:\r\n     * 1. Parses the resource ID from the given ID string\r\n     * 2. If resource ID exists and there's a pending submission:\r\n     *    - Resets the pending submission flag\r\n     *    - Constructs arguments with context info\r\n     *    - Calls updateEntries to process the PDF annotation\r\n     */\r\n    function extractResourceId(id) {\r\n\r\n        // Prevent updating ID while editing a existing entry.\r\n        if (buttonElement === 'Save') {\r\n\r\n            pendingSubmit = false;\r\n            return;\r\n        }\r\n\r\n        let resourceId = parseInt(id?.split('_')[1]);\r\n        if (resourceId && pendingSubmit) {\r\n            pendingSubmit = false;\r\n            let args = {\r\n                cmid: M.cfg.contextInstanceId,\r\n                userid: M.cfg.userId ?? 0,\r\n                courseid: M.cfg.courseId,\r\n                modulename: moduleName,\r\n                resourceid: resourceId\r\n            };\r\n            updateEntries('cursive_update_pdf_annote_id', args);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Retrieves and displays cursive analytics for a given resource\r\n     * @param {number} userid - The ID of the user\r\n     * @param {number} resourceid - The ID of the resource to get analytics for\r\n     * @param {number} cmid - The course module ID\r\n     * @param {HTMLElement} place - The DOM element where analytics should be placed\r\n     * @description This function:\r\n     * 1. Makes an AJAX call to get forum comment data\r\n     * 2. Creates and inserts analytics/replay buttons\r\n     * 3. Sets up analytics events and modal functionality\r\n     * 4. Handles both API key and non-API key scenarios\r\n     */\r\n    function getCursiveAnalytics(userid, resourceid, cmid, place) {\r\n        let args = {id: resourceid, modulename: \"pdfannotator\", cmid: cmid};\r\n        let methodname = 'cursive_get_forum_comment_link';\r\n        let com = call([{methodname, args}]);\r\n        com[0].done(function(json) {\r\n            var data = JSON.parse(json);\r\n\r\n            var filepath = '';\r\n            if (data.data.filename) {\r\n                filepath = data.data.filename;\r\n            }\r\n\r\n            let analyticButtonDiv = document.createElement('div');\r\n            let analyticsColumn = document.createElement('td');\r\n\r\n            if (!hasApiKey) {\r\n                analyticButtonDiv.append(replayButton(resourceid));\r\n            } else {\r\n                analyticButtonDiv.append(analyticButton(data.data.effort_ratio, resourceid));\r\n            }\r\n\r\n            analyticButtonDiv.dataset.region = \"analytic-div\" + userid;\r\n            analyticsColumn.append(analyticButtonDiv);\r\n            place.insertAdjacentElement('afterend', analyticsColumn);\r\n\r\n            let myEvents = new AnalyticEvents();\r\n            var context = {\r\n                tabledata: data.data,\r\n                formattime: myEvents.formatedTime(data.data),\r\n                page: scoreSetting,\r\n                userid: resourceid,\r\n                apikey: hasApiKey\r\n            };\r\n\r\n            let authIcon = myEvents.authorshipStatus(data.data.first_file, data.data.score, scoreSetting);\r\n            myEvents.createModal(resourceid, context, '', replayInstances, authIcon);\r\n            myEvents.analytics(resourceid, templates, context, '', replayInstances, authIcon);\r\n            myEvents.checkDiff(resourceid, data.data.file_id, '', replayInstances);\r\n            myEvents.replyWriting(resourceid, filepath, '', replayInstances);\r\n\r\n        });\r\n        com[0].fail((error) => {\r\n            window.console.error('Error getting cursive config:', error);\r\n        });\r\n    }\r\n};"],"names":["scoreSetting","comments","hasApiKey","userid","replayInstances","window","video_playback","mid","filepath","replay","Replay","render","then","html","document","getElementById","innerHTML","catch","e","console","error","container","querySelector","overviewTable","addEventListener","target","id","localStorage","removeItem","buttonElement","value","pendingSubmit","moduleName","body","split","MutationObserver","lastChild","_container$lastChild","resourceId","parseInt","async","methodname","args","updateEntries","cmid","M","cfg","contextInstanceId","userId","courseid","courseId","modulename","resourceid","extractResourceId","observe","subtree","childList","newChild","createElement","textContent","insertAdjacentElement","rows","querySelectorAll","action","URL","location","href","searchParams","get","forEach","row","cols","col1","col2","col3","links","link1","_cols$col","link2","_cols$col2","link3","_cols$col3","commentId","userLink","_userLink","warn","place","com","done","json","data","JSON","parse","filename","analyticButtonDiv","analyticsColumn","append","effort_ratio","dataset","region","myEvents","AnalyticEvents","context","tabledata","formattime","formatedTime","page","apikey","authIcon","authorshipStatus","first_file","score","createModal","analytics","templates","checkDiff","file_id","replyWriting","fail","getCursiveAnalytics","setReplayButton"],"mappings":"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"}