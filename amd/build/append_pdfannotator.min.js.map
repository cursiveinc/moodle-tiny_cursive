{"version":3,"file":"append_pdfannotator.min.js","sources":["../src/append_pdfannotator.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module for handling PDF annotator functionality,\n *\n * @module     tiny_cursive/append_pdfannotator\n * @copyright  2025 Cursive Technology, Inc. <info@cursivetechnology.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {call} from 'core/ajax';\nimport analyticButton from 'tiny_cursive/analytic_button';\nimport replayButton from 'tiny_cursive/replay_button';\nimport AnalyticEvents from 'tiny_cursive/analytic_events';\nimport templates from 'core/templates';\nimport Replay from 'tiny_cursive/replay';\nexport const init = (scoreSetting, comments, hasApiKey, userid) => {\n    const replayInstances = {};\n    // eslint-disable-next-line camelcase\n    window.video_playback = function(mid, filepath) {\n        if (filepath !== '') {\n            const replay = new Replay(\n                'content' + mid,\n                filepath,\n                10,\n                false,\n                'player_' + mid\n            );\n            replayInstances[mid] = replay;\n        } else {\n            templates.render('tiny_cursive/no_submission').then(html => {\n                document.getElementById('content' + mid).innerHTML = html;\n                return true;\n            }).catch(e => window.console.error(e));\n        }\n        return false;\n    };\n\n    let container = document.querySelector('.comment-list-container');\n    const overviewTable = document.querySelector('table[id^=\"mod-pdfannotator-\"]');\n\n    document.addEventListener('click', handleSubmit);\n    const moduleName = document.body.id.split('-')[2];\n    var pendingSubmit = false;\n    var buttonElement = \"\";\n\n    if (container) {\n        const observer = new MutationObserver(() => {\n            if (container?.lastChild?.id) {\n                extractResourceId(container.lastChild.id);\n            }\n        });\n\n        observer.observe(container, {\n            subtree: true,\n            childList: true\n        });\n    }\n\n    if (overviewTable) {\n        let newChild = document.createElement('th');\n        newChild.textContent = 'Analytics';\n        let header = overviewTable.querySelector('thead>tr>th:first-child');\n        header.insertAdjacentElement('afterend', newChild);\n        setReplayButton(overviewTable);\n    }\n\n    /**\n     * Sets up replay buttons and analytics for each row in the overview table\n     * @param {HTMLTableElement} overviewTable - The table element containing the overview data\n     * @description This function:\n     * 1. Gets all rows from the table\n     * 2. For each row:\n     *    - Extracts comment ID and user ID from relevant links\n     *    - Adds analytics column with replay/analytics buttons\n     *    - Sets up cursive analytics functionality\n     */\n    function setReplayButton(overviewTable) {\n        const rows = overviewTable.querySelectorAll('tbody > tr');\n        const action = new URL(window.location.href).searchParams.get('action');\n\n        rows.forEach(row => {\n            const cols = {\n                col1: row.querySelector('td:nth-child(1)'),\n                col2: row.querySelector('td:nth-child(2)'),\n                col3: row.querySelector('td:nth-child(3)')\n            };\n\n            const links = {\n                link1: cols.col1?.querySelector('a'),\n                link2: cols.col2?.querySelector('a'),\n                link3: cols.col3?.querySelector('a')\n            };\n\n            // Extract comment ID safely\n            const commentId = links.link1?.href ?\n                new URL(links.link1.href).searchParams.get('commid') : null;\n            const cmid = links.link1?.href ?\n                new URL(links.link1.href).searchParams.get('id') : M.cfg.contextInstanceId;\n            // Extract user ID based on action\n            let userId = null;\n            let userLink = null;\n\n            switch(action) {\n                case 'overviewquestions':\n                    userLink = links.link2;\n                    break;\n                case 'overviewanswers':\n                    userLink = links.link3;\n                    break;\n                default:\n                    userId = userid;\n            }\n\n            if (userLink?.href) {\n                try {\n                    userId = new URL(userLink.href).searchParams.get('id');\n                } catch (e) {\n                    window.console.warn('Error parsing user URL:', e);\n                }\n            }\n\n            getCursiveAnalytics(userId, commentId, cmid, cols.col1);\n        });\n    }\n\n    /**\n     * Handles the submission and cancellation of comments\n     * @param {Event} e - The click event object\n     * @description When comment is submitted or cancelled:\n     * - Removes 'isEditing' flag from localStorage\n     * - Sets pendingSubmit flag appropriately (true for submit, false for cancel)\n     */\n    function handleSubmit(e) {\n        if (e.target.id === 'commentSubmit') {\n            localStorage.removeItem('isEditing');\n            buttonElement = e.target.value;\n            pendingSubmit = true;\n        }\n        if (e.target.id === 'commentCancel') {\n            localStorage.removeItem('isEditing');\n            pendingSubmit = false;\n        }\n    }\n\n    const updateEntries = async (methodname, args) => {\n        try {\n            const response = await call([{\n                methodname,\n                args,\n            }])[0];\n            return response;\n        } catch (error) {\n            window.console.error('updating Entries:', error);\n            throw error;\n        }\n    };\n\n    /**\n     * Extracts the resource ID from a comment ID and updates entries if submission is pending\n     * @param {string} id - The ID string to extract resource ID from, expected format: 'prefix_number'\n     * @description This function:\n     * 1. Parses the resource ID from the given ID string\n     * 2. If resource ID exists and there's a pending submission:\n     *    - Resets the pending submission flag\n     *    - Constructs arguments with context info\n     *    - Calls updateEntries to process the PDF annotation\n     */\n    function extractResourceId(id) {\n\n        // prevent updating ID while editing a existing entry.\n        if (buttonElement === 'Save') {\n\n            pendingSubmit = false;\n            return;\n        }\n\n        let resourceId = parseInt(id?.split('_')[1]);\n        if (resourceId && pendingSubmit) {\n            pendingSubmit = false;\n            let args = {\n                cmid: M.cfg.contextInstanceId,\n                userid: M.cfg.userId ?? 0,\n                courseid: M.cfg.courseId,\n                modulename: moduleName,\n                resourceid: resourceId\n            };\n            updateEntries('cursive_update_pdf_annote_id', args);\n        }\n    }\n\n    /**\n     * Retrieves and displays cursive analytics for a given resource\n     * @param {number} userid - The ID of the user\n     * @param {number} resourceid - The ID of the resource to get analytics for\n     * @param {number} cmid - The course module ID\n     * @param {HTMLElement} place - The DOM element where analytics should be placed\n     * @description This function:\n     * 1. Makes an AJAX call to get forum comment data\n     * 2. Creates and inserts analytics/replay buttons\n     * 3. Sets up analytics events and modal functionality\n     * 4. Handles both API key and non-API key scenarios\n     */\n    function getCursiveAnalytics(userid, resourceid, cmid, place) {\n        let args = {id: resourceid, modulename: \"pdfannotator\", cmid: cmid};\n        let methodname = 'cursive_get_forum_comment_link';\n        let com = call([{methodname, args}]);\n        com[0].done(function(json) {\n            var data = JSON.parse(json);\n\n            var filepath = '';\n            if (data.data.filename) {\n                filepath = data.data.filename;\n            }\n\n            let analyticButtonDiv = document.createElement('div');\n            let analyticsColumn = document.createElement('td');\n\n            if (!hasApiKey) {\n                analyticButtonDiv.append(replayButton(resourceid));\n            } else {\n                analyticButtonDiv.append(analyticButton(data.data.effort_ratio, resourceid));\n            }\n\n            analyticButtonDiv.dataset.region = \"analytic-div\" + userid;\n            analyticsColumn.append(analyticButtonDiv);\n            place.insertAdjacentElement('afterend', analyticsColumn);\n\n            let myEvents = new AnalyticEvents();\n            var context = {\n                tabledata: data.data,\n                formattime: myEvents.formatedTime(data.data),\n                page: scoreSetting,\n                userid: resourceid,\n                apikey: hasApiKey\n            };\n\n            let authIcon = myEvents.authorshipStatus(data.data.first_file, data.data.score, scoreSetting);\n            myEvents.createModal(resourceid, context, '', replayInstances, authIcon);\n            myEvents.analytics(resourceid, templates, context, '', replayInstances, authIcon);\n            myEvents.checkDiff(resourceid, data.data.file_id, '', replayInstances);\n            myEvents.replyWriting(resourceid, filepath, '', replayInstances);\n\n        });\n        com[0].fail((error) => {\n            window.console.error('Error getting cursive config:', error);\n        });\n    }\n};"],"names":["scoreSetting","comments","hasApiKey","userid","replayInstances","window","video_playback","mid","filepath","replay","Replay","render","then","html","document","getElementById","innerHTML","catch","e","console","error","container","querySelector","overviewTable","addEventListener","target","id","localStorage","removeItem","buttonElement","value","pendingSubmit","moduleName","body","split","MutationObserver","lastChild","_container$lastChild","resourceId","parseInt","async","methodname","args","updateEntries","cmid","M","cfg","contextInstanceId","userId","courseid","courseId","modulename","resourceid","extractResourceId","observe","subtree","childList","newChild","createElement","textContent","insertAdjacentElement","rows","querySelectorAll","action","URL","location","href","searchParams","get","forEach","row","cols","col1","col2","col3","links","link1","_cols$col","link2","_cols$col2","link3","_cols$col3","commentId","userLink","_userLink","warn","place","com","done","json","data","JSON","parse","filename","analyticButtonDiv","analyticsColumn","append","effort_ratio","dataset","region","myEvents","AnalyticEvents","context","tabledata","formattime","formatedTime","page","apikey","authIcon","authorshipStatus","first_file","score","createModal","analytics","templates","checkDiff","file_id","replyWriting","fail","getCursiveAnalytics","setReplayButton"],"mappings":"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"}