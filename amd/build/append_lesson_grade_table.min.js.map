{"version":3,"file":"append_lesson_grade_table.min.js","sources":["../src/append_lesson_grade_table.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module to append analytics and grade table data for lesson submissions\n * Handles the display of analytics, replay functionality and grade information\n * for lesson submissions in the Moodle gradebook interface\n *\n * @module     tiny_cursive/append_lesson_grade_table\n * @copyright  2025  CTI <info@cursivetechnology.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport Replay from './replay';\nimport {call as getData} from 'core/ajax';\nimport templates from 'core/templates';\nimport AnalyticEvents from './analytic_events';\nimport analyticButton from './analytic_button';\nimport * as Str from 'core/str';\n\nexport const init = (scoreSetting, showcomment, hasApiKey) => {\n    const replayInstances = {};\n\n    // eslint-disable-next-line camelcase\n    window.video_playback = function(mid, filepath) {\n        if (filepath !== '') {\n            const replay = new Replay(\n                'content' + mid,\n                filepath,\n                10,\n                false,\n                'player_' + mid\n            );\n            replayInstances[mid] = replay;\n        } else {\n            templates.render('tiny_cursive/no_submission').then(html => {\n                const contentElement = document.getElementById('content' + mid);\n                if (contentElement) {\n                    contentElement.innerHTML = html;\n                }\n                return contentElement;\n            }).catch(e => window.console.error(e));\n        }\n        return false;\n    };\n\n    const cmid = M.cfg.contextInstanceId;\n    const emailLinks = document.querySelectorAll('#page-content div[role=\"main\"] td.lastcol a');\n    const headColumns = document.querySelectorAll('#region-main div[role=\"main\"] table thead tr');\n    let url = new URL(window.location.href);\n    let mode = url.searchParams.get('mode');\n    let user = url.searchParams.get('user');\n\n    Str.get_string('analytics', 'tiny_cursive').then((strs) => {\n        headColumns.forEach(function(row) {\n            const secondTh = row.querySelector('th:nth-child(2)');\n            if (secondTh) {\n                const newTh = document.createElement('th');\n                newTh.className = 'header';\n                newTh.innerHTML = strs;\n                secondTh.insertAdjacentElement('afterend', newTh);\n            }\n        });\n        return true;\n    }).catch(e => window.console.error(e));\n\n    if (mode && mode === \"grade\") {\n        analytics(user, cmid, \"\", true);\n    }\n\n    emailLinks.forEach(function(emailLink) {\n        const href = emailLink.getAttribute('href');\n        let userid = 0;\n\n        if (href) {\n            const urlParams = new URLSearchParams(href.split('?')[1]);\n            const useridParam = urlParams.get('userid');\n            userid = useridParam ? parseInt(useridParam) : 0;\n\n            if (!userid) {\n                // For aligning the table column\n                const closestTr = emailLink.closest('tr');\n                const secondTd = closestTr.querySelector('td:nth-child(2)');\n                if (secondTd) {\n                    const emptyTd = document.createElement('td');\n                    secondTd.insertAdjacentElement('afterend', emptyTd);\n                }\n            } else {\n                document.querySelector('#region-main').addEventListener('click', e => {\n                    const a = e.target.closest('table tbody tr td.cell.c1 a');\n                    if (!a) {\n                      return;\n                    }\n\n                    e.preventDefault();\n                    const url = new URL(a.href);\n                    url.searchParams.append('user', userid);\n                    window.location.href = url;\n                  });\n                  analytics(userid, cmid, emailLink, false);\n            }\n        }\n    });\n\n    /**\n     * Fetches and displays analytics data for lesson submissions\n     * @param {number} userid - The ID of the user whose analytics to fetch\n     * @param {number} cmid - The course module ID\n     * @param {jQuery|string} emailLink - jQuery object of email link or empty string\n     * @param {boolean} grade - Whether this is being called from grade view\n     */\n    function analytics(userid, cmid, emailLink, grade) {\n        let args = { id: userid, modulename: \"lesson\", cmid: cmid };\n        let methodname = 'cursive_get_lesson_submission_data';\n        let com = getData([{ methodname, args }]);\n\n        com[0].done(function (json) {\n          var data = JSON.parse(json);\n          var filepath = data.res.filename || '';\n\n          let analyticButtonDiv = document.createElement('div');\n          let analyticsColumn = document.createElement('td');\n          analyticButtonDiv.append(\n            analyticButton(hasApiKey ? data.res.effort_ratio : \"\", userid)\n          );\n          analyticButtonDiv.dataset.region = \"analytic-div\" + userid;\n          analyticsColumn.append(analyticButtonDiv);\n\n          if (grade) {\n            analyticButtonDiv.classList.add('w-100');\n            const felement = document.querySelector('#fitem_id_response_editor .felement');\n            if (felement) {\n              felement.insertBefore(analyticButtonDiv, felement.firstChild);\n            }\n          } else {\n            const tr = emailLink.closest('tr');\n            if (tr) {\n              const cells = tr.querySelectorAll('td');\n              if (cells[1]) {\n                cells[1].insertAdjacentElement('afterend', analyticsColumn);\n              }\n            }\n          }\n\n          let myEvents = new AnalyticEvents();\n          var context = {\n            tabledata: data.res,\n            formattime: myEvents.formatedTime(data.res),\n            page: scoreSetting,\n            userid: userid,\n            apikey: hasApiKey\n          };\n\n          let authIcon = myEvents.authorshipStatus(\n            data.res.first_file,\n            data.res.score,\n            scoreSetting\n          );\n          myEvents.createModal(userid, context, '', replayInstances, authIcon);\n          myEvents.analytics(userid, templates, context, '', replayInstances, authIcon);\n          myEvents.checkDiff(userid, data.res.file_id, '', replayInstances);\n          myEvents.replyWriting(userid, filepath, '', replayInstances);\n        });\n\n        com[0].fail((error) => {\n          window.console.error('Error getting cursive config:', error);\n        });\n      }\n\n};"],"names":["scoreSetting","showcomment","hasApiKey","replayInstances","window","video_playback","mid","filepath","replay","Replay","render","then","html","contentElement","document","getElementById","innerHTML","catch","e","console","error","cmid","M","cfg","contextInstanceId","emailLinks","querySelectorAll","headColumns","url","URL","location","href","mode","searchParams","get","user","analytics","userid","emailLink","grade","args","id","modulename","com","methodname","done","json","data","JSON","parse","res","filename","analyticButtonDiv","createElement","analyticsColumn","append","effort_ratio","dataset","region","classList","add","felement","querySelector","insertBefore","firstChild","tr","closest","cells","insertAdjacentElement","myEvents","AnalyticEvents","context","tabledata","formattime","formatedTime","page","apikey","authIcon","authorshipStatus","first_file","score","createModal","templates","checkDiff","file_id","replyWriting","fail","Str","get_string","strs","forEach","row","secondTh","newTh","className","getAttribute","useridParam","URLSearchParams","split","parseInt","addEventListener","a","target","preventDefault","secondTd","emptyTd"],"mappings":";;;;;;;;;g8BA+BoB,CAACA,aAAcC,YAAaC,mBACtCC,gBAAkB,GAGxBC,OAAOC,eAAiB,SAASC,IAAKC,aACjB,KAAbA,SAAiB,OACXC,OAAS,IAAIC,gBACf,UAAYH,IACZC,SACA,IACA,EACA,UAAYD,KAEhBH,gBAAgBG,KAAOE,+BAEbE,OAAO,8BAA8BC,MAAKC,aAC1CC,eAAiBC,SAASC,eAAe,UAAYT,YACvDO,iBACAA,eAAeG,UAAYJ,MAExBC,kBACRI,OAAMC,GAAKd,OAAOe,QAAQC,MAAMF,YAEhC,SAGLG,KAAOC,EAAEC,IAAIC,kBACbC,WAAaX,SAASY,iBAAiB,+CACvCC,YAAcb,SAASY,iBAAiB,oDAC1CE,IAAM,IAAIC,IAAIzB,OAAO0B,SAASC,MAC9BC,KAAOJ,IAAIK,aAAaC,IAAI,QAC5BC,KAAOP,IAAIK,aAAaC,IAAI,iBA4DvBE,UAAUC,OAAQhB,KAAMiB,UAAWC,WACpCC,KAAO,CAAEC,GAAIJ,OAAQK,WAAY,SAAUrB,KAAMA,MAEjDsB,KAAM,cAAQ,CAAC,CAAEC,WADJ,qCACgBJ,KAAAA,QAEjCG,IAAI,GAAGE,MAAK,SAAUC,UAChBC,KAAOC,KAAKC,MAAMH,MAClBvC,SAAWwC,KAAKG,IAAIC,UAAY,OAEhCC,kBAAoBtC,SAASuC,cAAc,OAC3CC,gBAAkBxC,SAASuC,cAAc,SAC7CD,kBAAkBG,QAChB,4BAAerD,UAAY6C,KAAKG,IAAIM,aAAe,GAAInB,SAEzDe,kBAAkBK,QAAQC,OAAS,eAAiBrB,OACpDiB,gBAAgBC,OAAOH,mBAEnBb,MAAO,CACTa,kBAAkBO,UAAUC,IAAI,eAC1BC,SAAW/C,SAASgD,cAAc,uCACpCD,UACFA,SAASE,aAAaX,kBAAmBS,SAASG,gBAE/C,OACCC,GAAK3B,UAAU4B,QAAQ,SACzBD,GAAI,OACAE,MAAQF,GAAGvC,iBAAiB,MAC9ByC,MAAM,IACRA,MAAM,GAAGC,sBAAsB,WAAYd,sBAK7Ce,SAAW,IAAIC,6BACfC,QAAU,CACZC,UAAWzB,KAAKG,IAChBuB,WAAYJ,SAASK,aAAa3B,KAAKG,KACvCyB,KAAM3E,aACNqC,OAAQA,OACRuC,OAAQ1E,eAGN2E,SAAWR,SAASS,iBACtB/B,KAAKG,IAAI6B,WACThC,KAAKG,IAAI8B,MACThF,cAEFqE,SAASY,YAAY5C,OAAQkC,QAAS,GAAIpE,gBAAiB0E,UAC3DR,SAASjC,UAAUC,OAAQ6C,mBAAWX,QAAS,GAAIpE,gBAAiB0E,UACpER,SAASc,UAAU9C,OAAQU,KAAKG,IAAIkC,QAAS,GAAIjF,iBACjDkE,SAASgB,aAAahD,OAAQ9B,SAAU,GAAIJ,oBAG9CwC,IAAI,GAAG2C,MAAMlE,QACXhB,OAAOe,QAAQC,MAAM,gCAAiCA,UAhH5DmE,IAAIC,WAAW,YAAa,gBAAgB7E,MAAM8E,OAC9C9D,YAAY+D,SAAQ,SAASC,WACnBC,SAAWD,IAAI7B,cAAc,sBAC/B8B,SAAU,OACJC,MAAQ/E,SAASuC,cAAc,MACrCwC,MAAMC,UAAY,SAClBD,MAAM7E,UAAYyE,KAClBG,SAASxB,sBAAsB,WAAYyB,YAG5C,KACR5E,OAAMC,GAAKd,OAAOe,QAAQC,MAAMF,KAE/Bc,MAAiB,UAATA,MACRI,UAAUD,KAAMd,KAAM,IAAI,GAG9BI,WAAWiE,SAAQ,SAASpD,iBAClBP,KAAOO,UAAUyD,aAAa,YAChC1D,OAAS,KAETN,KAAM,OAEAiE,YADY,IAAIC,gBAAgBlE,KAAKmE,MAAM,KAAK,IACxBhE,IAAI,aAClCG,OAAS2D,YAAcG,SAASH,aAAe,EAE1C3D,OASDvB,SAASgD,cAAc,gBAAgBsC,iBAAiB,SAASlF,UACvDmF,EAAInF,EAAEoF,OAAOpC,QAAQ,mCACtBmC,SAILnF,EAAEqF,uBACI3E,IAAM,IAAIC,IAAIwE,EAAEtE,MACtBH,IAAIK,aAAasB,OAAO,OAAQlB,QAChCjC,OAAO0B,SAASC,KAAOH,OAEzBQ,UAAUC,OAAQhB,KAAMiB,WAAW,OApB5B,OAGHkE,SADYlE,UAAU4B,QAAQ,MACTJ,cAAc,sBACrC0C,SAAU,OACJC,QAAU3F,SAASuC,cAAc,MACvCmD,SAASpC,sBAAsB,WAAYqC"}