{"version":3,"file":"append_lesson_grade_table.min.js","sources":["../src/append_lesson_grade_table.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module to append analytics and grade table data for lesson submissions\n * Handles the display of analytics, replay functionality and grade information\n * for lesson submissions in the Moodle gradebook interface\n *\n * @module     tiny_cursive/append_lesson_grade_table\n * @copyright  2025  CTI <info@cursivetechnology.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Replay from './replay';\nimport $ from 'jquery';\nimport {call as getData} from 'core/ajax';\nimport templates from 'core/templates';\nimport AnalyticEvents from './analytic_events';\nimport analyticButton from './analytic_button';\nimport replayButton from './replay_button';\nimport replayModal from './replay_modal';\nimport * as Str from 'core/str';\n\nexport const init = (scoreSetting, showcomment, hasApiKey) => {\n    const replayInstances = {};\n    // eslint-disable-next-line camelcase\n    window.video_playback = function(mid, filepath) {\n        if (filepath !== '') {\n            const replay = new Replay(\n                'content' + mid,\n                filepath,\n                10,\n                false,\n                'player_' + mid\n            );\n            replayInstances[mid] = replay;\n        } else {\n            templates.render('tiny_cursive/no_submission').then(html => {\n                $('#content' + mid).html(html);\n                return true;\n            }).catch(e => window.console.error(e));\n        }\n        return false;\n\n    };\n\n\n    var cmid = M.cfg.contextInstanceId;\n    var emailLink = $('#page-content div[role=\"main\"] td.lastcol a');\n    var headcolumn = $('#region-main div[role=\"main\"] table thead tr');\n    let url = new URL(window.location.href);\n    let mode = url.searchParams.get('mode');\n    let user = url.searchParams.get('user');\n\n    Str.get_string('analytics', 'tiny_cursive').then((strs) => {\n        headcolumn.each(function() {\n            $(this).find('th:eq(1)').after(`<th class=\"header\">${strs}</th>`);\n        });\n        return true;\n    }).catch(e => window.console.error(e));\n\n    if (mode && mode === \"grade\") {\n        analytics(user, cmid, \"\", true);\n    }\n\n    emailLink.each(function() {\n        let href = $(this).attr('href');\n        const $emailLink = $(this);\n        let userid = 0;\n        if (href) {\n            userid = parseInt(new URLSearchParams(href.split('?')[1]).get('userid'));\n            if (!userid) {\n                $emailLink.closest('tr').find('td:eq(1)').after(\"<td></td>\"); // For aligning the table column\n            } else {\n\n                $('#region-main').on('click', 'table tbody tr td.cell.c1 a', function(e) {\n                    e.preventDefault();\n                    const link = e.target.href;\n                    const url = new URL(link);\n                    url.searchParams.append('user', userid);\n                    window.location.href = url.toString();\n                });\n\n                analytics(userid, cmid, $emailLink, false);\n            }\n        }\n    });\n\n    /**\n     * Fetches and displays analytics data for lesson submissions\n     * @param {number} userid - The ID of the user whose analytics to fetch\n     * @param {number} cmid - The course module ID\n     * @param {jQuery|string} $emailLink - jQuery object of email link or empty string\n     * @param {boolean} grade - Whether this is being called from grade view\n     */\n    function analytics(userid, cmid, $emailLink, grade) {\n\n        let args = {id: userid, modulename: \"lesson\", cmid: cmid};\n        let methodname = 'cursive_get_lesson_submission_data';\n        let com = getData([{methodname, args}]);\n        com[0].done(function(json) {\n            var data = JSON.parse(json);\n            var filepath = '';\n            if (data.res.filename) {\n                filepath = data.res.filename;\n            }\n\n            let analyticButtonDiv = document.createElement('div');\n            let analyticsColumn = document.createElement('td');\n\n            // If no API key, show only replay button\n            if (!hasApiKey) {\n                $(analyticButtonDiv).html(replayButton(userid));\n                analyticButtonDiv.dataset.region = \"analytic-div\" + userid;\n                analyticsColumn.append(analyticButtonDiv);\n\n                if (grade) {\n                    analyticButtonDiv.classList.add('w-100');\n                    $('#fitem_id_response_editor .felement').prepend(analyticButtonDiv);\n                } else {\n                    $emailLink.closest('tr').find('td:eq(1)').after(analyticsColumn);\n                }\n\n                $(document).off('click', '#replay' + userid).on('click', '#replay' + userid, function(e) {\n                    e.preventDefault();\n\n                    const context = {\n                        mid: userid\n                    };\n\n                    replayModal.create({templateContext: context}).then(modal => {\n                        modal.show();\n                        window.video_playback(userid, filepath);\n\n                        return modal;\n                    }).catch(error => {\n                        window.console.error('Failed to create replay modal:', error);\n                    });\n                });\n\n                return;\n            }\n\n            analyticButtonDiv.append(analyticButton(hasApiKey ? data.res.effort_ratio : \"\", userid));\n            analyticButtonDiv.dataset.region = \"analytic-div\" + userid;\n            analyticsColumn.append(analyticButtonDiv);\n            if (grade) {\n                analyticButtonDiv.classList.add('w-100');\n                $('#fitem_id_response_editor .felement').prepend(analyticButtonDiv);\n            } else {\n                $emailLink.closest('tr').find('td:eq(1)').after(analyticsColumn);\n            }\n\n\n            let myEvents = new AnalyticEvents();\n            var context = {\n                tabledata: data.res,\n                formattime: myEvents.formatedTime(data.res),\n                page: scoreSetting,\n                userid: userid,\n                apikey: hasApiKey\n            };\n\n            let authIcon = myEvents.authorshipStatus(data.res.first_file, data.res.score, scoreSetting);\n            myEvents.createModal(userid, context, '', replayInstances, authIcon);\n            myEvents.analytics(userid, templates, context, '', replayInstances, authIcon);\n            myEvents.checkDiff(userid, data.res.file_id, '', replayInstances);\n            myEvents.replyWriting(userid, filepath, '', replayInstances);\n\n        });\n        com[0].fail((error) => {\n            window.console.error('Error getting cursive config:', error);\n        });\n    }\n};"],"names":["scoreSetting","showcomment","hasApiKey","replayInstances","window","video_playback","mid","filepath","replay","Replay","render","then","html","catch","e","console","error","cmid","M","cfg","contextInstanceId","emailLink","headcolumn","url","URL","location","href","mode","searchParams","get","user","analytics","userid","$emailLink","grade","args","id","modulename","com","methodname","done","json","data","JSON","parse","res","filename","analyticButtonDiv","document","createElement","analyticsColumn","dataset","region","append","classList","add","prepend","closest","find","after","off","on","preventDefault","context","create","templateContext","modal","show","effort_ratio","myEvents","AnalyticEvents","tabledata","formattime","formatedTime","page","apikey","authIcon","authorshipStatus","first_file","score","createModal","templates","checkDiff","file_id","replyWriting","fail","Str","get_string","strs","each","this","attr","parseInt","URLSearchParams","split","link","target","toString"],"mappings":"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"}