{"version":3,"file":"append_lesson_grade_table.min.js","sources":["../src/append_lesson_grade_table.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module to append analytics and grade table data for lesson submissions\n * Handles the display of analytics, replay functionality and grade information\n * for lesson submissions in the Moodle gradebook interface\n *\n * @module     tiny_cursive/append_lesson_grade_table\n * @copyright  2025  CTI <info@cursivetechnology.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport Replay from './replay';\nimport {call as getData} from 'core/ajax';\nimport templates from 'core/templates';\nimport AnalyticEvents from './analytic_events';\nimport analyticButton from './analytic_button';\nimport * as Str from 'core/str';\n\nexport const init = (scoreSetting) => {\n    const replayInstances = {};\n\n    // eslint-disable-next-line camelcase\n    window.video_playback = function(mid, filepath) {\n        if (filepath !== '') {\n            const replay = new Replay(\n                'content' + mid,\n                filepath,\n                10,\n                false,\n                'player_' + mid\n            );\n            replayInstances[mid] = replay;\n        } else {\n            templates.render('tiny_cursive/no_submission').then(html => {\n                const contentElement = document.getElementById('content' + mid);\n                if (contentElement) {\n                    contentElement.innerHTML = html;\n                }\n                return true;\n            }).catch(e => window.console.error(e));\n        }\n        return false;\n    };\n\n    const cmid = M.cfg.contextInstanceId;\n    const emailLinks = document.querySelectorAll('#page-content div[role=\"main\"] td.lastcol a');\n    const headColumns = document.querySelectorAll('#region-main div[role=\"main\"] table thead tr');\n\n    Str.get_string('analytics', 'tiny_cursive').then((strs) => {\n        headColumns.forEach(function(row) {\n            const secondTh = row.querySelector('th:nth-child(2)');\n            if (secondTh) {\n                const newTh = document.createElement('th');\n                newTh.className = 'header';\n                newTh.innerHTML = strs;\n                secondTh.insertAdjacentElement('afterend', newTh);\n            }\n        });\n        return true;\n    }).catch(e => window.console.error(e));\n\n    emailLinks.forEach(function(emailLink) {\n        const href = emailLink.getAttribute('href');\n        let userid = 0;\n\n        if (href) {\n            const urlParams = new URLSearchParams(href.split('?')[1]);\n            const useridParam = urlParams.get('userid');\n            userid = useridParam ? parseInt(useridParam) : 0;\n\n            if (!userid) {\n                // For aligning the table column\n                const closestTr = emailLink.closest('tr');\n                const secondTd = closestTr.querySelector('td:nth-child(2)');\n                if (secondTd) {\n                    const emptyTd = document.createElement('td');\n                    secondTd.insertAdjacentElement('afterend', emptyTd);\n                }\n            } else {\n                const args = { id: userid, modulename: \"lesson\", cmid: cmid };\n                const methodname = 'cursive_get_lesson_submission_data';\n                const com = getData([{ methodname, args }]);\n\n                com[0].done(function(json) {\n                    const data = JSON.parse(json);\n                    let filepath = '';\n                    if (data.res.filename) {\n                        filepath = data.res.filename;\n                    }\n\n                    const analyticButtonDiv = document.createElement('div');\n                    const analyticsColumn = document.createElement('td');\n                    analyticButtonDiv.append(analyticButton(userid));\n                    analyticButtonDiv.dataset.region = \"analytic-div\" + userid;\n                    analyticsColumn.append(analyticButtonDiv);\n\n                    const closestTr = emailLink.closest('tr');\n                    const secondTd = closestTr.querySelector('td:nth-child(2)');\n                    if (secondTd) {\n                        secondTd.insertAdjacentElement('afterend', analyticsColumn);\n                    }\n\n                    const myEvents = new AnalyticEvents();\n                    const context = {\n                        tabledata: data.res,\n                        formattime: myEvents.formatedTime(data.res),\n                        page: scoreSetting,\n                        userid: userid,\n                    };\n\n                    const authIcon = myEvents.authorshipStatus(data.res.first_file, data.res.score, scoreSetting);\n                    myEvents.createModal(userid, context, '', authIcon);\n                    myEvents.analytics(userid, templates, context, '', replayInstances, authIcon);\n                    myEvents.checkDiff(userid, data.res.file_id, '', replayInstances);\n                    myEvents.replyWriting(userid, filepath, '', replayInstances);\n\n                });\n\n                com[0].fail((error) => {\n                    window.console.error('Error getting cursive config:', error);\n                });\n            }\n        }\n    });\n};"],"names":["scoreSetting","replayInstances","window","video_playback","mid","filepath","replay","Replay","render","then","html","contentElement","document","getElementById","innerHTML","catch","e","console","error","cmid","M","cfg","contextInstanceId","emailLinks","querySelectorAll","headColumns","Str","get_string","strs","forEach","row","secondTh","querySelector","newTh","createElement","className","insertAdjacentElement","emailLink","href","getAttribute","userid","useridParam","URLSearchParams","split","get","parseInt","args","id","modulename","methodname","com","done","json","data","JSON","parse","res","filename","analyticButtonDiv","analyticsColumn","append","dataset","region","secondTd","closest","myEvents","AnalyticEvents","context","tabledata","formattime","formatedTime","page","authIcon","authorshipStatus","first_file","score","createModal","analytics","templates","checkDiff","file_id","replyWriting","fail","emptyTd"],"mappings":";;;;;;;;;g8BA+BqBA,qBACXC,gBAAkB,GAGxBC,OAAOC,eAAiB,SAASC,IAAKC,aACjB,KAAbA,SAAiB,OACXC,OAAS,IAAIC,gBACf,UAAYH,IACZC,SACA,IACA,EACA,UAAYD,KAEhBH,gBAAgBG,KAAOE,+BAEbE,OAAO,8BAA8BC,MAAKC,aAC1CC,eAAiBC,SAASC,eAAe,UAAYT,YACvDO,iBACAA,eAAeG,UAAYJ,OAExB,KACRK,OAAMC,GAAKd,OAAOe,QAAQC,MAAMF,YAEhC,SAGLG,KAAOC,EAAEC,IAAIC,kBACbC,WAAaX,SAASY,iBAAiB,+CACvCC,YAAcb,SAASY,iBAAiB,gDAE9CE,IAAIC,WAAW,YAAa,gBAAgBlB,MAAMmB,OAC9CH,YAAYI,SAAQ,SAASC,WACnBC,SAAWD,IAAIE,cAAc,sBAC/BD,SAAU,OACJE,MAAQrB,SAASsB,cAAc,MACrCD,MAAME,UAAY,SAClBF,MAAMnB,UAAYc,KAClBG,SAASK,sBAAsB,WAAYH,YAG5C,KACRlB,OAAMC,GAAKd,OAAOe,QAAQC,MAAMF,KAEnCO,WAAWM,SAAQ,SAASQ,iBAClBC,KAAOD,UAAUE,aAAa,YAChCC,OAAS,KAETF,KAAM,OAEAG,YADY,IAAIC,gBAAgBJ,KAAKK,MAAM,KAAK,IACxBC,IAAI,aAClCJ,OAASC,YAAcI,SAASJ,aAAe,EAE1CD,OAQE,OACGM,KAAO,CAAEC,GAAIP,OAAQQ,WAAY,SAAU7B,KAAMA,MACjD8B,WAAa,qCACbC,KAAM,cAAQ,CAAC,CAAED,WAAAA,WAAYH,KAAAA,QAEnCI,IAAI,GAAGC,MAAK,SAASC,YACXC,KAAOC,KAAKC,MAAMH,UACpB/C,SAAW,GACXgD,KAAKG,IAAIC,WACTpD,SAAWgD,KAAKG,IAAIC,gBAGlBC,kBAAoB9C,SAASsB,cAAc,OAC3CyB,gBAAkB/C,SAASsB,cAAc,MAC/CwB,kBAAkBE,QAAO,4BAAepB,SACxCkB,kBAAkBG,QAAQC,OAAS,eAAiBtB,OACpDmB,gBAAgBC,OAAOF,yBAGjBK,SADY1B,UAAU2B,QAAQ,MACThC,cAAc,mBACrC+B,UACAA,SAAS3B,sBAAsB,WAAYuB,uBAGzCM,SAAW,IAAIC,yBACfC,QAAU,CACZC,UAAWf,KAAKG,IAChBa,WAAYJ,SAASK,aAAajB,KAAKG,KACvCe,KAAMvE,aACNwC,OAAQA,QAGNgC,SAAWP,SAASQ,iBAAiBpB,KAAKG,IAAIkB,WAAYrB,KAAKG,IAAImB,MAAO3E,cAChFiE,SAASW,YAAYpC,OAAQ2B,QAAS,GAAIK,UAC1CP,SAASY,UAAUrC,OAAQsC,mBAAWX,QAAS,GAAIlE,gBAAiBuE,UACpEP,SAASc,UAAUvC,OAAQa,KAAKG,IAAIwB,QAAS,GAAI/E,iBACjDgE,SAASgB,aAAazC,OAAQnC,SAAU,GAAIJ,oBAIhDiD,IAAI,GAAGgC,MAAMhE,QACThB,OAAOe,QAAQC,MAAM,gCAAiCA,cAjDjD,OAGH6C,SADY1B,UAAU2B,QAAQ,MACThC,cAAc,sBACrC+B,SAAU,OACJoB,QAAUvE,SAASsB,cAAc,MACvC6B,SAAS3B,sBAAsB,WAAY+C"}